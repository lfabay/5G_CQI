"""
5G CQIå…³è”æ€§èƒ½åˆ†æç³»ç»Ÿ - ç½‘ç»œåˆ¶å¼å¯¹æ¯”ç‰ˆ
æ”¯æŒN41å’ŒN28ç½‘ç»œåˆ¶å¼å·¦å³å¯¹æ¯”å±•ç¤º
"""

import streamlit as st
import pandas as pd
import numpy as np
from scipy import stats
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from typing import Dict, List, Tuple

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="5G CQIå…³è”æ€§èƒ½åˆ†æç³»ç»Ÿ - ç½‘ç»œåˆ¶å¼å¯¹æ¯”",
    page_icon="ğŸ“¡",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# è‡ªå®šä¹‰CSSæ ·å¼
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1E90FF;
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .sub-header {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        padding: 10px 0;
        border-bottom: 2px solid #1E90FF;
        margin-bottom: 20px;
    }
    .network-type-header {
        font-size: 1.3rem;
        font-weight: bold;
        color: white;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
    }
    .n41-header {
        background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%);
    }
    .n28-header {
        background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
    }
    .metric-card {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 10px;
    }
    .highlight {
        background-color: #f0f8ff;
        padding: 15px;
        border-left: 4px solid #1E90FF;
        border-radius: 5px;
        margin: 10px 0;
    }
    .success-box {
        background-color: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #28a745;
        margin: 10px 0;
    }
    .warning-box {
        background-color: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #ffc107;
        margin: 10px 0;
    }
    .comparison-divider {
        border-left: 3px dashed #ccc;
        height: 100%;
    }
    /* æ ‡ç­¾é¡µå­—ä½“æ ·å¼ */
    .stTabs [data-baseweb="tab-list"] {
        gap: 10px;
    }
    .stTabs [data-baseweb="tab"] {
        height: 50px;
        padding: 0 24px;
        font-size: 18px !important;
        font-weight: 700 !important;
        background-color: #f0f2f6;
        border-radius: 10px 10px 0 0;
    }
    .stTabs [aria-selected="true"] {
        background-color: #1E90FF !important;
        color: white !important;
    }
</style>
""", unsafe_allow_html=True)


class CQIåˆ†æå™¨:
    """CQIæ•°æ®åˆ†æç±»"""

    def __init__(self, æ–‡ä»¶è·¯å¾„: str):
        self.æ–‡ä»¶è·¯å¾„ = æ–‡ä»¶è·¯å¾„
        self.åŸå§‹æ•°æ® = None
        self.æ¸…æ´—åæ•°æ® = None

    def è¯»å–æ•°æ®(self) -> bool:
        try:
            self.åŸå§‹æ•°æ® = pd.read_excel(self.æ–‡ä»¶è·¯å¾„)
            return True
        except Exception as e:
            st.error(f"è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
            return False

    def æ¸…æ´—æ•°æ®(self) -> bool:
        # åˆ—åæ˜ å°„ï¼šå¤„ç†æ–°æ—§Excelåˆ—åå·®å¼‚
        self.åˆ—åæ˜ å°„ = {
            'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³(dBm)': 'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'
        }
        # é‡å‘½ååˆ—
        for æ–°åˆ—å, æ ‡å‡†åˆ—å in self.åˆ—åæ˜ å°„.items():
            if æ–°åˆ—å in self.åŸå§‹æ•°æ®.columns:
                self.åŸå§‹æ•°æ® = self.åŸå§‹æ•°æ®.rename(columns={æ–°åˆ—å: æ ‡å‡†åˆ—å})
        
        å…³é”®åˆ— = [
            'CQIä¼˜è‰¯ç‡',
            'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
            'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
            'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³',
            'å°åŒºMRè¦†ç›–å¹³å‡SINR',
            'å°åŒºMRè¦†ç›–å¹³å‡TA',
            'å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³'
        ]
        if 'ç½‘ç»œåˆ¶å¼' in self.åŸå§‹æ•°æ®.columns:
            å…³é”®åˆ—.append('ç½‘ç»œåˆ¶å¼')
        self.æ¸…æ´—åæ•°æ® = self.åŸå§‹æ•°æ®.dropna(subset=å…³é”®åˆ—)
        
        # è®¡ç®—è¦†ç›–ç³»æ•°ï¼ˆå¦‚æœåŸå§‹æ•°æ®ä¸­æœ‰ç›¸å…³åˆ—ï¼‰
        if 'è¦†ç›–ç³»æ•°' in self.æ¸…æ´—åæ•°æ®.columns:
            # è¦†ç›–ç³»æ•°å·²å­˜åœ¨ï¼Œç¡®ä¿æ•°å€¼æœ‰æ•ˆ
            self.æ¸…æ´—åæ•°æ®['è¦†ç›–ç³»æ•°'] = pd.to_numeric(self.æ¸…æ´—åæ•°æ®['è¦†ç›–ç³»æ•°'], errors='coerce')
        elif 'æ–¹å‘è§’ç«™é—´è·ï¼ˆç±³ï¼‰' in self.æ¸…æ´—åæ•°æ®.columns and 'å°åŒºMRè¦†ç›–å¹³å‡TA' in self.æ¸…æ´—åæ•°æ®.columns:
            # è®¡ç®—è¦†ç›–ç³»æ•° = TA / ç«™é—´è·
            ç«™é—´è· = pd.to_numeric(self.æ¸…æ´—åæ•°æ®['æ–¹å‘è§’ç«™é—´è·ï¼ˆç±³ï¼‰'], errors='coerce')
            TA = pd.to_numeric(self.æ¸…æ´—åæ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡TA'], errors='coerce')
            self.æ¸…æ´—åæ•°æ®['è¦†ç›–ç³»æ•°'] = TA / ç«™é—´è·
        
        return True

    def æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„(self) -> Dict:
        """æŒ‰ç½‘ç»œåˆ¶å¼(n41/n28)åˆ†ç»„æ•°æ®"""
        if 'ç½‘ç»œåˆ¶å¼' not in self.æ¸…æ´—åæ•°æ®.columns:
            return {'å…¨éƒ¨': self.æ¸…æ´—åæ•°æ®}

        åˆ†ç»„ç»“æœ = {}
        for åˆ¶å¼ in self.æ¸…æ´—åæ•°æ®['ç½‘ç»œåˆ¶å¼'].unique():
            åˆ†ç»„ç»“æœ[åˆ¶å¼] = self.æ¸…æ´—åæ•°æ®[self.æ¸…æ´—åæ•°æ®['ç½‘ç»œåˆ¶å¼'] == åˆ¶å¼]
        return åˆ†ç»„ç»“æœ

    def åˆ¤æ–­ç›¸å…³æ€§å¼ºåº¦(self, ç›¸å…³ç³»æ•°: float) -> str:
        if ç›¸å…³ç³»æ•° < 0.1:
            return "æå¼±"
        elif ç›¸å…³ç³»æ•° < 0.3:
            return "å¼±"
        elif ç›¸å…³ç³»æ•° < 0.5:
            return "ä¸­ç­‰"
        elif ç›¸å…³ç³»æ•° < 0.7:
            return "å¼º"
        else:
            return "æå¼º"

    def è®¡ç®—ç›¸å…³æ€§_æŒ‰åˆ¶å¼(self, å­—æ®µ1: str, å­—æ®µ2: str, æ•°æ®å­é›†: pd.DataFrame = None) -> Dict:
        if æ•°æ®å­é›† is None:
            æ•°æ®å­é›† = self.æ¸…æ´—åæ•°æ®
        
        # åˆ é™¤åŒ…å«NaNçš„è¡Œï¼Œç¡®ä¿æ•°æ®æœ‰æ•ˆ
        æœ‰æ•ˆæ•°æ® = æ•°æ®å­é›†[[å­—æ®µ1, å­—æ®µ2]].dropna()
        
        # æ£€æŸ¥æœ‰æ•ˆæ•°æ®é‡æ˜¯å¦è¶³å¤Ÿï¼ˆè‡³å°‘éœ€è¦3ä¸ªæ ·æœ¬ï¼‰
        if len(æœ‰æ•ˆæ•°æ®) < 3:
            return {"ç›¸å…³ç³»æ•°": None, "På€¼": None}
        
        try:
            ç›¸å…³ç³»æ•°, på€¼ = stats.pearsonr(æœ‰æ•ˆæ•°æ®[å­—æ®µ1], æœ‰æ•ˆæ•°æ®[å­—æ®µ2])
            return {"ç›¸å…³ç³»æ•°": ç›¸å…³ç³»æ•°, "På€¼": på€¼}
        except Exception:
            return {"ç›¸å…³ç³»æ•°": None, "På€¼": None}

    def åˆ†æCQIå¯¹é€Ÿç‡å½±å“_æŒ‰åˆ¶å¼(self) -> Dict:
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            ç»“æœ[åˆ¶å¼] = {}
            for é€Ÿç‡åˆ— in ['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']:
                ç›¸å…³æ€§ = self.è®¡ç®—ç›¸å…³æ€§_æŒ‰åˆ¶å¼('CQIä¼˜è‰¯ç‡', é€Ÿç‡åˆ—, æ•°æ®)
                ç›¸å…³æ€§['æ˜¾è‘—æ€§'] = 'æ˜¾è‘—' if ç›¸å…³æ€§['På€¼'] < 0.05 else 'ä¸æ˜¾è‘—'
                ç›¸å…³æ€§['å¼ºåº¦'] = self.åˆ¤æ–­ç›¸å…³æ€§å¼ºåº¦(abs(ç›¸å…³æ€§['ç›¸å…³ç³»æ•°']))
                ç»“æœ[åˆ¶å¼][é€Ÿç‡åˆ—] = ç›¸å…³æ€§
        return ç»“æœ

    def CQIåˆ†ä½æ•°é€Ÿç‡åˆ†æ_æŒ‰åˆ¶å¼(self, åˆ†ä½æ•°: int = 5) -> Dict:
        """å°†CQIæŒ‰åˆ†ä½æ•°åˆ†ç»„ï¼Œè®¡ç®—æ¯ä¸ªåˆ†ä½æ•°ç»„çš„å¹³å‡é€Ÿç‡"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            if 'CQIä¼˜è‰¯ç‡' not in æ•°æ®.columns:
                continue
                
            # ç§»é™¤NaN
            æœ‰æ•ˆæ•°æ® = æ•°æ®[['CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']].dropna()
            if len(æœ‰æ•ˆæ•°æ®) < 10:
                continue
            
            # åˆ›å»ºCQIåˆ†ä½æ•°
            æœ‰æ•ˆæ•°æ®['CQIåˆ†ä½æ•°'] = pd.qcut(æœ‰æ•ˆæ•°æ®['CQIä¼˜è‰¯ç‡'], q=åˆ†ä½æ•°, labels=[f"{i*20}-{(i+1)*20}%" for i in range(åˆ†ä½æ•°)], duplicates='drop')
            
            # æŒ‰åˆ†ä½æ•°åˆ†ç»„è®¡ç®—å¹³å‡é€Ÿç‡
            åˆ†ä½æ•°ç»Ÿè®¡ = æœ‰æ•ˆæ•°æ®.groupby('CQIåˆ†ä½æ•°').agg({
                'CQIä¼˜è‰¯ç‡': 'mean',
                'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)': 'mean',
                'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)': 'mean'
            }).reset_index()
            
            # æ·»åŠ æ ·æœ¬æ•°
            æ ·æœ¬æ•° = æœ‰æ•ˆæ•°æ®.groupby('CQIåˆ†ä½æ•°').size().to_dict()
            åˆ†ä½æ•°ç»Ÿè®¡['æ ·æœ¬æ•°'] = åˆ†ä½æ•°ç»Ÿè®¡['CQIåˆ†ä½æ•°'].map(æ ·æœ¬æ•°)
            
            # è®¡ç®—é€Ÿç‡æå‡ç‡ï¼ˆç›¸å¯¹äºæœ€ä½åˆ†ä½æ•°ï¼‰
            if len(åˆ†ä½æ•°ç»Ÿè®¡) > 1:
                åŸºå‡†ä¸‹è¡Œ = åˆ†ä½æ•°ç»Ÿè®¡.iloc[0]['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']
                åŸºå‡†ä¸Šè¡Œ = åˆ†ä½æ•°ç»Ÿè®¡.iloc[0]['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']
                åˆ†ä½æ•°ç»Ÿè®¡['ä¸‹è¡Œæå‡ç‡(%)'] = ((åˆ†ä½æ•°ç»Ÿè®¡['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'] - åŸºå‡†ä¸‹è¡Œ) / åŸºå‡†ä¸‹è¡Œ * 100).round(2)
                åˆ†ä½æ•°ç»Ÿè®¡['ä¸Šè¡Œæå‡ç‡(%)'] = ((åˆ†ä½æ•°ç»Ÿè®¡['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'] - åŸºå‡†ä¸Šè¡Œ) / åŸºå‡†ä¸Šè¡Œ * 100).round(2)
            
            ç»“æœ[åˆ¶å¼] = åˆ†ä½æ•°ç»Ÿè®¡
            
        return ç»“æœ

    def è¯†åˆ«å¼‚å¸¸å°åŒº_æŒ‰åˆ¶å¼(self, é˜ˆå€¼å€æ•°: float = 1.5) -> Dict:
        """è¯†åˆ«CQIä¸é€Ÿç‡ä¸åŒ¹é…çš„å¼‚å¸¸å°åŒº"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            if 'CQIä¼˜è‰¯ç‡' not in æ•°æ®.columns or 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)' not in æ•°æ®.columns:
                continue
            
            # æ£€æŸ¥å°åŒºæ ‡è¯†åˆ—ï¼Œä½¿ç”¨"å°åŒºä¸­æ–‡å"æˆ–"GNODEB"
            å°åŒºæ ‡è¯†åˆ— = None
            if 'å°åŒºä¸­æ–‡å' in æ•°æ®.columns:
                å°åŒºæ ‡è¯†åˆ— = 'å°åŒºä¸­æ–‡å'
            elif 'GNODEB' in æ•°æ®.columns:
                å°åŒºæ ‡è¯†åˆ— = 'GNODEB'
            else:
                # å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç´¢å¼•
                æ•°æ® = æ•°æ®.copy()
                æ•°æ®['å°åŒºæ ‡è¯†'] = æ•°æ®.index
                å°åŒºæ ‡è¯†åˆ— = 'å°åŒºæ ‡è¯†'
            
            # ç§»é™¤NaN
            æœ‰æ•ˆæ•°æ® = æ•°æ®[[å°åŒºæ ‡è¯†åˆ—, 'CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']].dropna()
            if len(æœ‰æ•ˆæ•°æ®) < 10:
                continue
            
            # è®¡ç®—Zåˆ†æ•°ï¼ˆæ ‡å‡†åŒ–ï¼‰ï¼Œå¤„ç†æ ‡å‡†å·®ä¸º0çš„æƒ…å†µ
            cqi_std = æœ‰æ•ˆæ•°æ®['CQIä¼˜è‰¯ç‡'].std()
            dl_std = æœ‰æ•ˆæ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].std()
            
            if cqi_std == 0 or dl_std == 0:
                continue  # æ ‡å‡†å·®ä¸º0ï¼Œæ— æ³•è®¡ç®—Zåˆ†æ•°ï¼Œè·³è¿‡
            
            æœ‰æ•ˆæ•°æ®['CQI_Z'] = (æœ‰æ•ˆæ•°æ®['CQIä¼˜è‰¯ç‡'] - æœ‰æ•ˆæ•°æ®['CQIä¼˜è‰¯ç‡'].mean()) / cqi_std
            æœ‰æ•ˆæ•°æ®['ä¸‹è¡ŒZ'] = (æœ‰æ•ˆæ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'] - æœ‰æ•ˆæ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean()) / dl_std
            
            # è¯†åˆ«é«˜CQIä½é€Ÿç‡å°åŒºï¼ˆCQI-Z > é˜ˆå€¼ ä¸” ä¸‹è¡ŒZ < -é˜ˆå€¼ï¼‰
            é«˜CQIä½é€Ÿç‡ = æœ‰æ•ˆæ•°æ®[(æœ‰æ•ˆæ•°æ®['CQI_Z'] > é˜ˆå€¼å€æ•°) & (æœ‰æ•ˆæ•°æ®['ä¸‹è¡ŒZ'] < -é˜ˆå€¼å€æ•°)].copy()
            é«˜CQIä½é€Ÿç‡ = é«˜CQIä½é€Ÿç‡.sort_values('ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', ascending=True).head(10)
            
            # è¯†åˆ«ä½CQIé«˜é€Ÿç‡å°åŒºï¼ˆCQI-Z < -é˜ˆå€¼ ä¸” ä¸‹è¡ŒZ > é˜ˆå€¼ï¼‰
            ä½CQIé«˜é€Ÿç‡ = æœ‰æ•ˆæ•°æ®[(æœ‰æ•ˆæ•°æ®['CQI_Z'] < -é˜ˆå€¼å€æ•°) & (æœ‰æ•ˆæ•°æ®['ä¸‹è¡ŒZ'] > é˜ˆå€¼å€æ•°)].copy()
            ä½CQIé«˜é€Ÿç‡ = ä½CQIé«˜é€Ÿç‡.sort_values('ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', ascending=False).head(10)
            
            # ç»Ÿä¸€åˆ—åï¼Œå°†ç¬¬ä¸€åˆ—é‡å‘½åä¸º"å°åŒºåç§°"ä»¥ä¾¿æ˜¾ç¤º
            if len(é«˜CQIä½é€Ÿç‡) > 0:
                ç¬¬ä¸€åˆ—å = é«˜CQIä½é€Ÿç‡.columns[0]
                é«˜CQIä½é€Ÿç‡ = é«˜CQIä½é€Ÿç‡.rename(columns={ç¬¬ä¸€åˆ—å: 'å°åŒºåç§°'})
            
            if len(ä½CQIé«˜é€Ÿç‡) > 0:
                ç¬¬ä¸€åˆ—å = ä½CQIé«˜é€Ÿç‡.columns[0]
                ä½CQIé«˜é€Ÿç‡ = ä½CQIé«˜é€Ÿç‡.rename(columns={ç¬¬ä¸€åˆ—å: 'å°åŒºåç§°'})
            
            ç»“æœ[åˆ¶å¼] = {
                'é«˜CQIä½é€Ÿç‡': é«˜CQIä½é€Ÿç‡,
                'ä½CQIé«˜é€Ÿç‡': ä½CQIé«˜é€Ÿç‡
            }
            
        return ç»“æœ

    def é€Ÿç‡åˆ†å¸ƒå¯¹æ¯”_æŒ‰åˆ¶å¼(self) -> Dict:
        """å¯¹æ¯”ä¸åŒCQIç­‰çº§çš„é€Ÿç‡åˆ†å¸ƒ"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            if 'CQIä¼˜è‰¯ç‡' not in æ•°æ®.columns:
                continue
            
            # åˆ›å»ºCQIç­‰çº§ï¼ˆä½<60%, ä¸­60-85%, é«˜>85%ï¼‰
            æœ‰æ•ˆæ•°æ® = æ•°æ®[['CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']].dropna()
            if len(æœ‰æ•ˆæ•°æ®) < 10:
                continue
            
            æœ‰æ•ˆæ•°æ®['CQIç­‰çº§'] = pd.cut(
                æœ‰æ•ˆæ•°æ®['CQIä¼˜è‰¯ç‡'],
                bins=[0, 60, 85, 100],
                labels=['ä½CQI(<60%)', 'ä¸­CQI(60-85%)', 'é«˜CQI(>85%)']
            )
            
            # æŒ‰ç­‰çº§ç»Ÿè®¡
            ç»Ÿè®¡ç»“æœ = æœ‰æ•ˆæ•°æ®.groupby('CQIç­‰çº§').agg({
                'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)': ['mean', 'std', 'min', 'max'],
                'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)': ['mean', 'std', 'min', 'max'],
                'CQIä¼˜è‰¯ç‡': 'count'
            }).reset_index()
            
            ç»Ÿè®¡ç»“æœ.columns = ['CQIç­‰çº§', 'ä¸‹è¡Œå‡å€¼', 'ä¸‹è¡Œæ ‡å‡†å·®', 'ä¸‹è¡Œæœ€å°å€¼', 'ä¸‹è¡Œæœ€å¤§å€¼',
                                 'ä¸Šè¡Œå‡å€¼', 'ä¸Šè¡Œæ ‡å‡†å·®', 'ä¸Šè¡Œæœ€å°å€¼', 'ä¸Šè¡Œæœ€å¤§å€¼', 'æ ·æœ¬æ•°']
            
            ç»“æœ[åˆ¶å¼] = ç»Ÿè®¡ç»“æœ
            
        return ç»“æœ

    def åˆ†æå½±å“CQIçš„æŒ‡æ ‡_æŒ‰åˆ¶å¼(self) -> Dict:
        å½±å“æŒ‡æ ‡ = [
            'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³',
            'å°åŒºMRè¦†ç›–å¹³å‡SINR',
            'å°åŒºMRè¦†ç›–å¹³å‡TA',
            'å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³',
            'ä¸Šè¡ŒPRBå¹³å‡åˆ©ç”¨ç‡',
            'ä¸‹è¡ŒPRBå¹³å‡åˆ©ç”¨ç‡',
            'è¦†ç›–ç³»æ•°',  # â­æ–°å¢
            'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)'  # â­æ–°å¢
        ]
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            ç»“æœåˆ—è¡¨ = []
            for æŒ‡æ ‡ in å½±å“æŒ‡æ ‡:
                if æŒ‡æ ‡ in æ•°æ®.columns:
                    ç›¸å…³æ€§ = self.è®¡ç®—ç›¸å…³æ€§_æŒ‰åˆ¶å¼('CQIä¼˜è‰¯ç‡', æŒ‡æ ‡, æ•°æ®)
                    ç›¸å…³æ€§['æ˜¾è‘—æ€§'] = 'æ˜¾è‘—' if ç›¸å…³æ€§['På€¼'] < 0.05 else 'ä¸æ˜¾è‘—'
                    ç›¸å…³æ€§['å¼ºåº¦'] = self.åˆ¤æ–­ç›¸å…³æ€§å¼ºåº¦(abs(ç›¸å…³æ€§['ç›¸å…³ç³»æ•°']))
                    ç»“æœåˆ—è¡¨.append({**{"æŒ‡æ ‡": æŒ‡æ ‡}, **ç›¸å…³æ€§})
            ç»“æœ[åˆ¶å¼] = sorted(ç»“æœåˆ—è¡¨, key=lambda x: abs(x["ç›¸å…³ç³»æ•°"]), reverse=True)
        return ç»“æœ

    def è®¡ç®—ç›¸å…³æ€§çŸ©é˜µ_æŒ‰åˆ¶å¼(self, åˆ—ååˆ—è¡¨: List[str]) -> Dict:
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            ç»“æœ[åˆ¶å¼] = æ•°æ®[åˆ—ååˆ—è¡¨].corr()
        return ç»“æœ

    def è·å–ç»Ÿè®¡æ‘˜è¦_æŒ‰åˆ¶å¼(self) -> Dict:
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            ç»“æœ[åˆ¶å¼] = {
                'æ•°æ®é‡': len(æ•°æ®),
                'å¹³å‡CQI': æ•°æ®['CQIä¼˜è‰¯ç‡'].mean(),
                'CQIæ ‡å‡†å·®': æ•°æ®['CQIä¼˜è‰¯ç‡'].std(),
                'å¹³å‡ä¸‹è¡Œé€Ÿç‡': æ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                'ä¸‹è¡Œé€Ÿç‡æ ‡å‡†å·®': æ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].std(),
                'å¹³å‡ä¸Šè¡Œé€Ÿç‡': æ•°æ®['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                'ä¸Šè¡Œé€Ÿç‡æ ‡å‡†å·®': æ•°æ®['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].std()
            }
            # æ·»åŠ è¦†ç›–ç³»æ•°ç»Ÿè®¡
            if 'è¦†ç›–ç³»æ•°' in æ•°æ®.columns:
                ç»“æœ[åˆ¶å¼]['å¹³å‡è¦†ç›–ç³»æ•°'] = æ•°æ®['è¦†ç›–ç³»æ•°'].mean()
                ç»“æœ[åˆ¶å¼]['è¦†ç›–ç³»æ•°æ ‡å‡†å·®'] = æ•°æ®['è¦†ç›–ç³»æ•°'].std()
            # æ·»åŠ é‡å è¦†ç›–ç»Ÿè®¡
            if 'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)' in æ•°æ®.columns:
                ç»“æœ[åˆ¶å¼]['å¹³å‡é‡å è¦†ç›–'] = æ•°æ®['é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)'].mean()
                ç»“æœ[åˆ¶å¼]['é‡å è¦†ç›–æ ‡å‡†å·®'] = æ•°æ®['é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)'].std()
        return ç»“æœ

    def æŒ‰è¦†ç›–åŒºåŸŸåˆ†ç»„ç»Ÿè®¡(self) -> Dict:
        """æŒ‰è¦†ç›–åŒºåŸŸï¼ˆåŸå¸‚/å†œæ‘/å¿åŸï¼‰åˆ†ç»„ç»Ÿè®¡"""
        if 'è¦†ç›–åŒºåŸŸ' not in self.æ¸…æ´—åæ•°æ®.columns:
            return {}
        ç»“æœ = {}
        for åŒºåŸŸ in self.æ¸…æ´—åæ•°æ®['è¦†ç›–åŒºåŸŸ'].unique():
            åŒºåŸŸæ•°æ® = self.æ¸…æ´—åæ•°æ®[self.æ¸…æ´—åæ•°æ®['è¦†ç›–åŒºåŸŸ'] == åŒºåŸŸ]
            ç»“æœ[åŒºåŸŸ] = {
                'æ•°æ®é‡': len(åŒºåŸŸæ•°æ®),
                'å¹³å‡CQI': åŒºåŸŸæ•°æ®['CQIä¼˜è‰¯ç‡'].mean(),
                'CQIæ ‡å‡†å·®': åŒºåŸŸæ•°æ®['CQIä¼˜è‰¯ç‡'].std(),
                'å¹³å‡ä¸‹è¡Œé€Ÿç‡': åŒºåŸŸæ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                'å¹³å‡ä¸Šè¡Œé€Ÿç‡': åŒºåŸŸæ•°æ®['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                'å¹³å‡é‡å è¦†ç›–': åŒºåŸŸæ•°æ®['é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)'].mean() if 'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)' in åŒºåŸŸæ•°æ®.columns else None,
                'å¹³å‡è¦†ç›–ç³»æ•°': åŒºåŸŸæ•°æ®['è¦†ç›–ç³»æ•°'].mean() if 'è¦†ç›–ç³»æ•°' in åŒºåŸŸæ•°æ®.columns else None
            }
        return ç»“æœ

    def æŒ‰åˆ¶å¼å’Œè¦†ç›–åŒºåŸŸåˆ†ç»„ç»Ÿè®¡(self) -> Dict:
        """æŒ‰ç½‘ç»œåˆ¶å¼å’Œè¦†ç›–åŒºåŸŸäº¤å‰åˆ†ç»„ç»Ÿè®¡"""
        if 'è¦†ç›–åŒºåŸŸ' not in self.æ¸…æ´—åæ•°æ®.columns or 'ç½‘ç»œåˆ¶å¼' not in self.æ¸…æ´—åæ•°æ®.columns:
            return {}
        
        ç»“æœ = {}
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        
        for åˆ¶å¼, åˆ¶å¼æ•°æ® in åˆ†ç»„æ•°æ®.items():
            ç»“æœ[åˆ¶å¼] = {}
            for åŒºåŸŸ in åˆ¶å¼æ•°æ®['è¦†ç›–åŒºåŸŸ'].unique():
                åŒºåŸŸæ•°æ® = åˆ¶å¼æ•°æ®[åˆ¶å¼æ•°æ®['è¦†ç›–åŒºåŸŸ'] == åŒºåŸŸ]
                ç»“æœ[åˆ¶å¼][åŒºåŸŸ] = {
                    'æ•°æ®é‡': len(åŒºåŸŸæ•°æ®),
                    'å¹³å‡CQI': åŒºåŸŸæ•°æ®['CQIä¼˜è‰¯ç‡'].mean(),
                    'å¹³å‡ä¸‹è¡Œé€Ÿç‡': åŒºåŸŸæ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                    'å¹³å‡ä¸Šè¡Œé€Ÿç‡': åŒºåŸŸæ•°æ®['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                    'å¹³å‡é‡å è¦†ç›–': åŒºåŸŸæ•°æ®['é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)'].mean() if 'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)' in åŒºåŸŸæ•°æ®.columns else None,
                    'å¹³å‡è¦†ç›–ç³»æ•°': åŒºåŸŸæ•°æ®['è¦†ç›–ç³»æ•°'].mean() if 'è¦†ç›–ç³»æ•°' in åŒºåŸŸæ•°æ®.columns else None
                }
        return ç»“æœ

    def CQIé€Ÿç‡æ‹ç‚¹åˆ†æ_æŒ‰åˆ¶å¼(self, åˆ†æ®µæ•°: int = 10) -> Dict:
        """åˆ†æCQIä¸é€Ÿç‡å…³ç³»çš„æ‹ç‚¹
        
        æ€è·¯ï¼š
        1. å°†CQIä¼˜è‰¯ç‡åˆ’åˆ†ä¸ºå¤šä¸ªåŒºé—´ï¼ˆå¦‚æ¯5%æˆ–10%ä¸€ä¸ªåŒºé—´ï¼‰
        2. è®¡ç®—æ¯ä¸ªåŒºé—´çš„å¹³å‡é€Ÿç‡
        3. æ‰¾å‡ºé€Ÿç‡å¢é•¿æ–œç‡å˜åŒ–æœ€å¤§çš„ç‚¹ï¼ˆæ‹ç‚¹ï¼‰
        4. æ‹ç‚¹ä»£è¡¨ï¼šè¶…è¿‡æ­¤CQIå€¼åï¼Œé€Ÿç‡æå‡æ•ˆæœå¼€å§‹æ˜¾è‘—å˜åŒ–
        
        è¿”å›ï¼šæ¯ä¸ªåˆ¶å¼çš„åŒºé—´åˆ†æå’Œæ‹ç‚¹ä¿¡æ¯
        """
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            if len(æ•°æ®) < åˆ†æ®µæ•° * 5:  # ç¡®ä¿æ¯ä¸ªåŒºé—´æœ‰è¶³å¤Ÿæ ·æœ¬
                continue
                
            # å°†CQIä¼˜è‰¯ç‡åˆ’åˆ†ä¸ºç­‰é¢‘åŒºé—´ï¼ˆä¿è¯æ¯ä¸ªåŒºé—´æ ·æœ¬é‡å‡è¡¡ï¼‰
            try:
                æ•°æ®['CQIåŒºé—´'] = pd.qcut(æ•°æ®['CQIä¼˜è‰¯ç‡'], q=åˆ†æ®µæ•°, duplicates='drop')
            except:
                continue
            
            # è®¡ç®—æ¯ä¸ªåŒºé—´çš„ç»Ÿè®¡ä¿¡æ¯
            åŒºé—´ç»Ÿè®¡ = æ•°æ®.groupby('CQIåŒºé—´').agg({
                'CQIä¼˜è‰¯ç‡': ['mean', 'min', 'max', 'count'],
                'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)': ['mean', 'std'],
                'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³': 'mean',
                'å°åŒºMRè¦†ç›–å¹³å‡SINR': 'mean'
            }).reset_index()
            
            # å±•å¹³åˆ—å
            åŒºé—´ç»Ÿè®¡.columns = ['CQIåŒºé—´', 'CQIå‡å€¼', 'CQIæœ€å°å€¼', 'CQIæœ€å¤§å€¼', 'æ ·æœ¬æ•°', 
                             'å¹³å‡é€Ÿç‡', 'é€Ÿç‡æ ‡å‡†å·®', 'å¹³å‡è¦†ç›–ç”µå¹³', 'å¹³å‡SINR']
            
            # è®¡ç®—é€Ÿç‡å¢é•¿ç‡ï¼ˆç›¸å¯¹äºå‰ä¸€ä¸ªåŒºé—´ï¼‰
            åŒºé—´ç»Ÿè®¡['é€Ÿç‡å¢é•¿(Mbps)'] = åŒºé—´ç»Ÿè®¡['å¹³å‡é€Ÿç‡'].diff()
            åŒºé—´ç»Ÿè®¡['é€Ÿç‡å¢é•¿ç‡(%)'] = (åŒºé—´ç»Ÿè®¡['å¹³å‡é€Ÿç‡'].pct_change() * 100)
            
            # æ‰¾å‡ºæ‹ç‚¹ï¼šé€Ÿç‡å¢é•¿æ–œç‡å˜åŒ–æœ€å¤§çš„ç‚¹
            if len(åŒºé—´ç»Ÿè®¡) > 2:
                # è®¡ç®—äºŒé˜¶å¯¼æ•°ï¼ˆæ–œç‡å˜åŒ–ï¼‰
                åŒºé—´ç»Ÿè®¡['æ–œç‡å˜åŒ–'] = åŒºé—´ç»Ÿè®¡['é€Ÿç‡å¢é•¿(Mbps)'].diff()
                # æ‹ç‚¹ï¼šæ–œç‡å˜åŒ–æœ€å¤§çš„æ­£å‘ç‚¹
                æ‹ç‚¹ç´¢å¼• = åŒºé—´ç»Ÿè®¡['æ–œç‡å˜åŒ–'].idxmax()
                æ‹ç‚¹æ•°æ® = åŒºé—´ç»Ÿè®¡.loc[æ‹ç‚¹ç´¢å¼•]
                
                # æ ‡è®°æ‹ç‚¹
                åŒºé—´ç»Ÿè®¡['æ˜¯å¦æ‹ç‚¹'] = False
                åŒºé—´ç»Ÿè®¡.loc[æ‹ç‚¹ç´¢å¼•, 'æ˜¯å¦æ‹ç‚¹'] = True
            else:
                æ‹ç‚¹æ•°æ® = None
            
            # æ‰¾å‡ºå…³é”®é˜ˆå€¼ç‚¹
            # 1. é€Ÿç‡æå‡å¼€å§‹æ˜¾è‘—çš„ç‚¹ï¼ˆå¢é•¿ç‡>10%ï¼‰
            æ˜¾è‘—æå‡ç‚¹ = åŒºé—´ç»Ÿè®¡[åŒºé—´ç»Ÿè®¡['é€Ÿç‡å¢é•¿ç‡(%)'] > 10]
            
            # 2. é€Ÿç‡è¶‹äºå¹³ç¨³çš„ç‚¹ï¼ˆå¢é•¿ç‡<5%ï¼‰
            å¹³ç¨³ç‚¹ = åŒºé—´ç»Ÿè®¡[åŒºé—´ç»Ÿè®¡['é€Ÿç‡å¢é•¿ç‡(%)'] < 5]
            
            ç»“æœ[åˆ¶å¼] = {
                'åŒºé—´ç»Ÿè®¡': åŒºé—´ç»Ÿè®¡,
                'æ‹ç‚¹': æ‹ç‚¹æ•°æ®,
                'æ˜¾è‘—æå‡ç‚¹': æ˜¾è‘—æå‡ç‚¹,
                'å¹³ç¨³ç‚¹': å¹³ç¨³ç‚¹
            }
        
        return ç»“æœ

    def è´¡çŒ®åº¦åˆ†æ_æŒ‰åˆ¶å¼(self) -> Dict:
        """æŒ‰ç½‘ç»œåˆ¶å¼åˆ†æå„æŒ‡æ ‡å¯¹CQIçš„è´¡çŒ®åº¦"""
        å½±å“æŒ‡æ ‡ = [
            'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³',
            'å°åŒºMRè¦†ç›–å¹³å‡SINR',
            'å°åŒºMRè¦†ç›–å¹³å‡TA',
            'å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³',
            'ä¸Šè¡ŒPRBå¹³å‡åˆ©ç”¨ç‡',
            'ä¸‹è¡ŒPRBå¹³å‡åˆ©ç”¨ç‡',
            'è¦†ç›–ç³»æ•°',  # â­æ–°å¢
            'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)'  # â­æ–°å¢
        ]
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            è´¡çŒ®åº¦åˆ—è¡¨ = []
            for æŒ‡æ ‡ in å½±å“æŒ‡æ ‡:
                if æŒ‡æ ‡ in æ•°æ®.columns:
                    # åˆ é™¤åŒ…å«NaNçš„è¡Œ
                    æœ‰æ•ˆæ•°æ® = æ•°æ®[[æŒ‡æ ‡, 'CQIä¼˜è‰¯ç‡']].dropna()
                    
                    # æ£€æŸ¥æœ‰æ•ˆæ•°æ®é‡æ˜¯å¦è¶³å¤Ÿ
                    if len(æœ‰æ•ˆæ•°æ®) < 3:
                        è´¡çŒ®åº¦åˆ—è¡¨.append({
                            'æŒ‡æ ‡': æŒ‡æ ‡,
                            'ç›¸å…³ç³»æ•°': None,
                            'è´¡çŒ®åº¦(%)': 0
                        })
                        continue
                    
                    try:
                        ç›¸å…³ç³»æ•°, _ = stats.pearsonr(æœ‰æ•ˆæ•°æ®[æŒ‡æ ‡], æœ‰æ•ˆæ•°æ®['CQIä¼˜è‰¯ç‡'])
                        è´¡çŒ®åº¦ = abs(ç›¸å…³ç³»æ•°) * 100
                        è´¡çŒ®åº¦åˆ—è¡¨.append({
                            'æŒ‡æ ‡': æŒ‡æ ‡,
                            'ç›¸å…³ç³»æ•°': ç›¸å…³ç³»æ•°,
                            'è´¡çŒ®åº¦(%)': è´¡çŒ®åº¦
                        })
                    except Exception:
                        è´¡çŒ®åº¦åˆ—è¡¨.append({
                            'æŒ‡æ ‡': æŒ‡æ ‡,
                            'ç›¸å…³ç³»æ•°': None,
                            'è´¡çŒ®åº¦(%)': 0
                        })
            
            # è¿‡æ»¤æ‰è´¡çŒ®åº¦ä¸º0çš„é¡¹å†æ’åº
            è´¡çŒ®åº¦åˆ—è¡¨ = [x for x in è´¡çŒ®åº¦åˆ—è¡¨ if x['è´¡çŒ®åº¦(%)'] > 0]
            è´¡çŒ®åº¦åˆ—è¡¨.sort(key=lambda x: x['è´¡çŒ®åº¦(%)'], reverse=True)
            
            æ€»è´¡çŒ®åº¦ = sum(x['è´¡çŒ®åº¦(%)'] for x in è´¡çŒ®åº¦åˆ—è¡¨)
            ç´¯ç§¯è´¡çŒ®åº¦ = 0
            for é¡¹ in è´¡çŒ®åº¦åˆ—è¡¨:
                ç´¯ç§¯è´¡çŒ®åº¦ += é¡¹['è´¡çŒ®åº¦(%)']
                é¡¹['ç´¯ç§¯è´¡çŒ®åº¦(%)'] = ç´¯ç§¯è´¡çŒ®åº¦ / æ€»è´¡çŒ®åº¦ * 100 if æ€»è´¡çŒ®åº¦ > 0 else 0
            ç»“æœ[åˆ¶å¼] = {'è´¡çŒ®åº¦åˆ—è¡¨': è´¡çŒ®åº¦åˆ—è¡¨, 'æ€»è´¡çŒ®åº¦': æ€»è´¡çŒ®åº¦}
        return ç»“æœ

    def æŒ‰CQIåˆ†ç»„åˆ†æ_æŒ‰åˆ¶å¼(self, åˆ†ç»„æ•°: int = 5) -> Dict:
        """æŒ‰ç½‘ç»œåˆ¶å¼è¿›è¡ŒCQIåˆ†ç»„åˆ†æ"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            åˆ†ç»„æ ‡ç­¾ = [f'ç¬¬{i+1}ç»„' for i in range(åˆ†ç»„æ•°)]
            æ•°æ®å‰¯æœ¬ = æ•°æ®.copy()
            æ•°æ®å‰¯æœ¬['CQIåˆ†ç»„'] = pd.qcut(æ•°æ®å‰¯æœ¬['CQIä¼˜è‰¯ç‡'], q=åˆ†ç»„æ•°, labels=åˆ†ç»„æ ‡ç­¾, duplicates='drop')
            åˆ†æåˆ— = [
                'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
                'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
                'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³',
                'å°åŒºMRè¦†ç›–å¹³å‡SINR',
                'å°åŒºMRè¦†ç›–å¹³å‡TA',
                'å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³'
            ]
            ç»“æœ[åˆ¶å¼] = æ•°æ®å‰¯æœ¬.groupby('CQIåˆ†ç»„')[åˆ†æåˆ—].agg(['mean', 'std', 'count'])
        return ç»“æœ

    # ==================== å¤šç»´åº¦äº¤å‰åˆ†ææ–¹æ³• ====================
    
    def ä¸‰ç»´æ•£ç‚¹å›¾åˆ†æ_æŒ‰åˆ¶å¼(self) -> Dict:
        """ä¸‰ç»´æ•£ç‚¹å›¾åˆ†æï¼šè¦†ç›–Ã—SINRÃ—CQI/é€Ÿç‡"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            # å‡†å¤‡ä¸‰ç»´æ•°æ®
            ä¸‰ç»´æ•°æ® = æ•°æ®[['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³', 'å°åŒºMRè¦†ç›–å¹³å‡SINR', 'CQIä¼˜è‰¯ç‡', 
                           'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']].dropna()
            ç»“æœ[åˆ¶å¼] = ä¸‰ç»´æ•°æ®
        return ç»“æœ
    
    def å››è±¡é™åˆ†æ_æŒ‰åˆ¶å¼(self, è¦†ç›–é˜ˆå€¼: float = -90, SINRé˜ˆå€¼: float = 15) -> Dict:
        """å››è±¡é™åˆ†æï¼šè¦†ç›–Ã—SINRçŸ©é˜µ"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            è±¡é™ç»Ÿè®¡ = []
            
            # å®šä¹‰å››ä¸ªè±¡é™
            # è¦†ç›–ç”µå¹³æ˜¯è´Ÿæ•°ï¼Œæ•°å€¼è¶Šå¤§ï¼ˆè¶Šæ¥è¿‘0ï¼‰ä¿¡å·è¶Šå¥½
            # å¥½è¦†ç›– = è¦†ç›–ç”µå¹³ > é˜ˆå€¼ï¼ˆä¿¡å·å¼ºï¼‰
            # å·®è¦†ç›– = è¦†ç›–ç”µå¹³ <= é˜ˆå€¼ï¼ˆä¿¡å·å¼±ï¼‰
            è±¡é™å®šä¹‰ = [
                ('è±¡é™1: å¥½è¦†ç›–+å¥½SINR', è¦†ç›–é˜ˆå€¼, float('inf'), SINRé˜ˆå€¼, float('inf')),
                ('è±¡é™2: å·®è¦†ç›–+å¥½SINR', -float('inf'), è¦†ç›–é˜ˆå€¼, SINRé˜ˆå€¼, float('inf')),
                ('è±¡é™3: å¥½è¦†ç›–+å·®SINR', è¦†ç›–é˜ˆå€¼, float('inf'), -float('inf'), SINRé˜ˆå€¼),
                ('è±¡é™4: å·®è¦†ç›–+å·®SINR', -float('inf'), è¦†ç›–é˜ˆå€¼, -float('inf'), SINRé˜ˆå€¼)
            ]
            
            for è±¡é™å, è¦†ç›–ä¸‹é™, è¦†ç›–ä¸Šé™, SINRä¸‹é™, SINRä¸Šé™ in è±¡é™å®šä¹‰:
                è±¡é™æ•°æ® = æ•°æ®[
                    (æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'] > è¦†ç›–ä¸‹é™) & 
                    (æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'] <= è¦†ç›–ä¸Šé™) &
                    (æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'] > SINRä¸‹é™) & 
                    (æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'] <= SINRä¸Šé™)
                ]
                
                if len(è±¡é™æ•°æ®) > 0:
                    è±¡é™ç»Ÿè®¡.append({
                        'è±¡é™': è±¡é™å,
                        'æ ·æœ¬æ•°': len(è±¡é™æ•°æ®),
                        'å æ¯”(%)': len(è±¡é™æ•°æ®) / len(æ•°æ®) * 100,
                        'å¹³å‡CQI': è±¡é™æ•°æ®['CQIä¼˜è‰¯ç‡'].mean(),
                        'å¹³å‡ä¸‹è¡Œé€Ÿç‡': è±¡é™æ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                        'å¹³å‡è¦†ç›–ç”µå¹³': è±¡é™æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'].mean(),
                        'å¹³å‡SINR': è±¡é™æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'].mean()
                    })
            
            ç»“æœ[åˆ¶å¼] = pd.DataFrame(è±¡é™ç»Ÿè®¡)
        return ç»“æœ
    
    def CQIä¸è¾¾æ ‡æ ¹å› åˆ†æ_æŒ‰åˆ¶å¼(self, CQIé˜ˆå€¼: Dict = None) -> Dict:
        """CQIä¸è¾¾æ ‡æ ¹å› åˆ†æ - æ”¯æŒåˆ†åˆ¶å¼è®¾ç½®é˜ˆå€¼"""
        if CQIé˜ˆå€¼ is None:
            CQIé˜ˆå€¼ = {'n41': 85, 'n28': 85}  # é»˜è®¤é˜ˆå€¼
        
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            # è·å–è¯¥åˆ¶å¼çš„é˜ˆå€¼ï¼Œé»˜è®¤ä¸º85
            é˜ˆå€¼ = CQIé˜ˆå€¼.get(åˆ¶å¼, 85)
            
            # ç­›é€‰CQIä¸è¾¾æ ‡çš„å°åŒº
            ä¸è¾¾æ ‡æ•°æ® = æ•°æ®[æ•°æ®['CQIä¼˜è‰¯ç‡'] < é˜ˆå€¼]
            è¾¾æ ‡æ•°æ® = æ•°æ®[æ•°æ®['CQIä¼˜è‰¯ç‡'] >= é˜ˆå€¼]
            
            if len(ä¸è¾¾æ ‡æ•°æ®) == 0:
                ç»“æœ[åˆ¶å¼] = {'æ ¹å› ç»Ÿè®¡': pd.DataFrame(), 'ä¸è¾¾æ ‡æ¯”ä¾‹': 0, 'CQIé˜ˆå€¼': é˜ˆå€¼}
                continue
            
            # æ ¹å› åˆ†ç±»
            æ ¹å› ç»Ÿè®¡ = []
            
            # 1. è¦†ç›–é—®é¢˜ï¼ˆè¦†ç›–ç”µå¹³ < -95dBmï¼‰
            è¦†ç›–é—®é¢˜æ•° = len(ä¸è¾¾æ ‡æ•°æ®[ä¸è¾¾æ ‡æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'] < -95])
            
            # 2. å¹²æ‰°é—®é¢˜ï¼ˆSINR < 10ï¼‰
            å¹²æ‰°é—®é¢˜æ•° = len(ä¸è¾¾æ ‡æ•°æ®[ä¸è¾¾æ ‡æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'] < 10])
            
            # 3. â­ ä¿®æ”¹ä¸ºï¼šè¶ŠåŒºè¦†ç›–é—®é¢˜ï¼ˆè¦†ç›–ç³»æ•° > 0.65ï¼‰
            è¶ŠåŒºè¦†ç›–é—®é¢˜æ•° = 0
            if 'è¦†ç›–ç³»æ•°' in ä¸è¾¾æ ‡æ•°æ®.columns:
                è¶ŠåŒºè¦†ç›–é—®é¢˜æ•° = len(ä¸è¾¾æ ‡æ•°æ®[ä¸è¾¾æ ‡æ•°æ®['è¦†ç›–ç³»æ•°'] > 0.65])
            
            # 4. ç»¼åˆé—®é¢˜ï¼ˆè¦†ç›–å·® + å¹²æ‰°é«˜ï¼‰
            ç»¼åˆé—®é¢˜æ•° = len(ä¸è¾¾æ ‡æ•°æ®[
                (ä¸è¾¾æ ‡æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'] < -95) & 
                (ä¸è¾¾æ ‡æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'] < 10)
            ])
            
            # 5. â­ ä¿®æ”¹ä¸ºï¼šé‡å è¦†ç›–é—®é¢˜ï¼ˆé‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹ â‰¥ 15%ï¼Œé«˜å¹²æ‰°ï¼‰
            é‡å è¦†ç›–é—®é¢˜æ•° = 0
            if 'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)' in ä¸è¾¾æ ‡æ•°æ®.columns:
                é‡å è¦†ç›–é—®é¢˜æ•° = len(ä¸è¾¾æ ‡æ•°æ®[ä¸è¾¾æ ‡æ•°æ®['é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)'] >= 15])
            
            æ ¹å› ç»Ÿè®¡ = [
                {'æ ¹å› ç±»å‹': 'è¦†ç›–é—®é¢˜(ç”µå¹³<-95dBm)', 'å°åŒºæ•°': è¦†ç›–é—®é¢˜æ•°, 
                 'å æ¯”(%)': è¦†ç›–é—®é¢˜æ•°/len(ä¸è¾¾æ ‡æ•°æ®)*100},
                {'æ ¹å› ç±»å‹': 'å¹²æ‰°é—®é¢˜(SINR<10)', 'å°åŒºæ•°': å¹²æ‰°é—®é¢˜æ•°, 
                 'å æ¯”(%)': å¹²æ‰°é—®é¢˜æ•°/len(ä¸è¾¾æ ‡æ•°æ®)*100},
                {'æ ¹å› ç±»å‹': 'è¶ŠåŒºè¦†ç›–(è¦†ç›–ç³»æ•°>0.65)', 'å°åŒºæ•°': è¶ŠåŒºè¦†ç›–é—®é¢˜æ•°, 
                 'å æ¯”(%)': è¶ŠåŒºè¦†ç›–é—®é¢˜æ•°/len(ä¸è¾¾æ ‡æ•°æ®)*100},
                {'æ ¹å› ç±»å‹': 'è¦†ç›–+å¹²æ‰°ç»¼åˆé—®é¢˜', 'å°åŒºæ•°': ç»¼åˆé—®é¢˜æ•°, 
                 'å æ¯”(%)': ç»¼åˆé—®é¢˜æ•°/len(ä¸è¾¾æ ‡æ•°æ®)*100},
                {'æ ¹å› ç±»å‹': 'é‡å è¦†ç›–é—®é¢˜(æ¯”ä¾‹â‰¥15%)', 'å°åŒºæ•°': é‡å è¦†ç›–é—®é¢˜æ•°, 
                 'å æ¯”(%)': é‡å è¦†ç›–é—®é¢˜æ•°/len(ä¸è¾¾æ ‡æ•°æ®)*100}
            ]
            
            ä¸è¾¾æ ‡æ¯”ä¾‹ = len(ä¸è¾¾æ ‡æ•°æ®) / len(æ•°æ®) * 100
            
            ç»“æœ[åˆ¶å¼] = {
                'æ ¹å› ç»Ÿè®¡': pd.DataFrame(æ ¹å› ç»Ÿè®¡),
                'ä¸è¾¾æ ‡æ¯”ä¾‹': ä¸è¾¾æ ‡æ¯”ä¾‹,
                'ä¸è¾¾æ ‡å°åŒºæ•°': len(ä¸è¾¾æ ‡æ•°æ®),
                'æ€»å°åŒºæ•°': len(æ•°æ®),
                'CQIé˜ˆå€¼': é˜ˆå€¼
            }
        return ç»“æœ

    # ==================== è¦†ç›–ç³»æ•°ç›¸å…³åˆ†ææ–¹æ³• ====================
    
    def è¦†ç›–ç³»æ•°ç»Ÿè®¡_æŒ‰åˆ¶å¼(self) -> Dict:
        """æŒ‰ç½‘ç»œåˆ¶å¼ç»Ÿè®¡è¦†ç›–ç³»æ•°åˆ†å¸ƒ"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            if 'è¦†ç›–ç³»æ•°' not in æ•°æ®.columns:
                continue
                
            è¦†ç›–ç³»æ•°æ•°æ® = æ•°æ®['è¦†ç›–ç³»æ•°'].dropna()
            
            # è¦†ç›–ç³»æ•°åˆ†çº§ï¼ˆè°ƒæ•´ä¸º3æ¡£ï¼‰
            è¦†ç›–è¿‘ = len(è¦†ç›–ç³»æ•°æ•°æ®[è¦†ç›–ç³»æ•°æ•°æ® < 0.3])
            è¦†ç›–é€‚ä¸­ = len(è¦†ç›–ç³»æ•°æ•°æ®[(è¦†ç›–ç³»æ•°æ•°æ® >= 0.3) & (è¦†ç›–ç³»æ•°æ•°æ® <= 0.65)])
            è¶ŠåŒºè¦†ç›– = len(è¦†ç›–ç³»æ•°æ•°æ®[è¦†ç›–ç³»æ•°æ•°æ® > 0.65])
            
            ç»“æœ[åˆ¶å¼] = {
                'æ ·æœ¬æ•°': len(è¦†ç›–ç³»æ•°æ•°æ®),
                'å¹³å‡å€¼': è¦†ç›–ç³»æ•°æ•°æ®.mean(),
                'æ ‡å‡†å·®': è¦†ç›–ç³»æ•°æ•°æ®.std(),
                'æœ€å°å€¼': è¦†ç›–ç³»æ•°æ•°æ®.min(),
                'æœ€å¤§å€¼': è¦†ç›–ç³»æ•°æ•°æ®.max(),
                'ä¸­ä½æ•°': è¦†ç›–ç³»æ•°æ•°æ®.median(),
                'è¦†ç›–è¾ƒè¿‘(<0.3)': è¦†ç›–è¿‘,
                'è¦†ç›–é€‚ä¸­(0.3-0.65)': è¦†ç›–é€‚ä¸­,
                'è¶ŠåŒºè¦†ç›–(>0.65)': è¶ŠåŒºè¦†ç›–,
                'è¦†ç›–ç³»æ•°æ•°æ®': è¦†ç›–ç³»æ•°æ•°æ®
            }
        return ç»“æœ
    
    def è¦†ç›–ç³»æ•°ä¸CQIç›¸å…³æ€§_æŒ‰åˆ¶å¼(self) -> Dict:
        """åˆ†æè¦†ç›–ç³»æ•°ä¸CQIåŠå…¶ä»–æŒ‡æ ‡çš„ç›¸å…³æ€§"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            if 'è¦†ç›–ç³»æ•°' not in æ•°æ®.columns:
                continue
                
            åˆ†ææŒ‡æ ‡ = ['CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
                      'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³', 'å°åŒºMRè¦†ç›–å¹³å‡SINR']
            
            ç›¸å…³æ€§åˆ—è¡¨ = []
            for æŒ‡æ ‡ in åˆ†ææŒ‡æ ‡:
                if æŒ‡æ ‡ in æ•°æ®.columns:
                    æœ‰æ•ˆæ•°æ® = æ•°æ®[['è¦†ç›–ç³»æ•°', æŒ‡æ ‡]].dropna()
                    if len(æœ‰æ•ˆæ•°æ®) > 10:
                        ç›¸å…³ç³»æ•°, på€¼ = stats.pearsonr(æœ‰æ•ˆæ•°æ®['è¦†ç›–ç³»æ•°'], æœ‰æ•ˆæ•°æ®[æŒ‡æ ‡])
                        ç›¸å…³æ€§åˆ—è¡¨.append({
                            'æŒ‡æ ‡': æŒ‡æ ‡,
                            'ç›¸å…³ç³»æ•°': ç›¸å…³ç³»æ•°,
                            'På€¼': på€¼,
                            'æ˜¾è‘—æ€§': 'æ˜¾è‘—' if på€¼ < 0.05 else 'ä¸æ˜¾è‘—',
                            'å¼ºåº¦': self.åˆ¤æ–­ç›¸å…³æ€§å¼ºåº¦(abs(ç›¸å…³ç³»æ•°))
                        })
            
            ç»“æœ[åˆ¶å¼] = sorted(ç›¸å…³æ€§åˆ—è¡¨, key=lambda x: abs(x['ç›¸å…³ç³»æ•°']), reverse=True)
        return ç»“æœ
    
    def å¤šç»´åº¦åˆ†å±‚åˆ†æ_æŒ‰åˆ¶å¼(self, ç»´åº¦: str = 'è¦†ç›–ç³»æ•°', åˆ†æ¡£é˜ˆå€¼: List[float] = None) -> Dict:
        """é€šç”¨å¤šç»´åº¦åˆ†å±‚åˆ†æ - æ”¯æŒè¦†ç›–ç³»æ•°ã€TAã€è¦†ç›–ç”µå¹³åˆ†æ¡£
        
        å‚æ•°:
            ç»´åº¦: 'è¦†ç›–ç³»æ•°' | 'TA' | 'è¦†ç›–ç”µå¹³'
            åˆ†æ¡£é˜ˆå€¼: åˆ†æ¡£é˜ˆå€¼åˆ—è¡¨ï¼ŒNoneåˆ™ä½¿ç”¨é»˜è®¤å€¼
        """
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            åˆ†æ¡£ç»“æœ = []
            
            if ç»´åº¦ == 'è¦†ç›–ç³»æ•°':
                if 'è¦†ç›–ç³»æ•°' not in æ•°æ®.columns:
                    continue
                å­—æ®µå = 'è¦†ç›–ç³»æ•°'
                é˜ˆå€¼ = åˆ†æ¡£é˜ˆå€¼ if åˆ†æ¡£é˜ˆå€¼ else [0.3, 0.7, 1.0, 2.0]
                æ¡£ä½å®šä¹‰ = [
                    ('è¿‘è¦†ç›–(<0.3)', 0, é˜ˆå€¼[0]),
                    ('é€‚ä¸­è¦†ç›–(0.3-0.7)', é˜ˆå€¼[0], é˜ˆå€¼[1]),
                    ('è¾ƒè¿œè¦†ç›–(0.7-1.0)', é˜ˆå€¼[1], é˜ˆå€¼[2]),
                    ('è½»å¾®è¶ŠåŒº(1.0-2.0)', é˜ˆå€¼[2], é˜ˆå€¼[3]),
                    ('ä¸¥é‡è¶ŠåŒº(>2.0)', é˜ˆå€¼[3], float('inf'))
                ]
                
            elif ç»´åº¦ == 'TA':
                if 'å°åŒºMRè¦†ç›–å¹³å‡TA' not in æ•°æ®.columns:
                    continue
                å­—æ®µå = 'å°åŒºMRè¦†ç›–å¹³å‡TA'
                é˜ˆå€¼ = åˆ†æ¡£é˜ˆå€¼ if åˆ†æ¡£é˜ˆå€¼ else [300, 600, 1000, 1500, 2000, 2500, 3000, 3500, 4000]
                æ¡£ä½å®šä¹‰ = [
                    ('0-300ç±³', 0, é˜ˆå€¼[0]),
                    ('300-600ç±³', é˜ˆå€¼[0], é˜ˆå€¼[1]),
                    ('600-1000ç±³', é˜ˆå€¼[1], é˜ˆå€¼[2]),
                    ('1000-1500ç±³', é˜ˆå€¼[2], é˜ˆå€¼[3]),
                    ('1500-2000ç±³', é˜ˆå€¼[3], é˜ˆå€¼[4]),
                    ('2000-2500ç±³', é˜ˆå€¼[4], é˜ˆå€¼[5]),
                    ('2500-3000ç±³', é˜ˆå€¼[5], é˜ˆå€¼[6]),
                    ('3000-3500ç±³', é˜ˆå€¼[6], é˜ˆå€¼[7]),
                    ('3500-4000ç±³', é˜ˆå€¼[7], é˜ˆå€¼[8]),
                    ('4000ç±³ä»¥ä¸Š', é˜ˆå€¼[8], float('inf'))
                ]
                
            elif ç»´åº¦ == 'è¦†ç›–ç”µå¹³':
                if 'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³' not in æ•°æ®.columns:
                    continue
                å­—æ®µå = 'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'
                é˜ˆå€¼ = åˆ†æ¡£é˜ˆå€¼ if åˆ†æ¡£é˜ˆå€¼ else [-95, -85]
                æ¡£ä½å®šä¹‰ = [
                    ('å¼±è¦†ç›–(<-95dBm)', -float('inf'), é˜ˆå€¼[0]),
                    ('ä¸­ç­‰è¦†ç›–(-95~-85dBm)', é˜ˆå€¼[0], é˜ˆå€¼[1]),
                    ('å¥½è¦†ç›–(>-85dBm)', é˜ˆå€¼[1], float('inf'))
                ]
            else:
                continue
            
            # æ‰§è¡Œåˆ†æ¡£ç»Ÿè®¡
            for æ¡£ä½å, ä¸‹é™, ä¸Šé™ in æ¡£ä½å®šä¹‰:
                æ¡£ä½æ•°æ® = æ•°æ®[(æ•°æ®[å­—æ®µå] > ä¸‹é™) & (æ•°æ®[å­—æ®µå] <= ä¸Šé™)]
                if len(æ¡£ä½æ•°æ®) > 5:
                    è¡Œ = {
                        'æ¡£ä½': æ¡£ä½å,
                        'æ ·æœ¬æ•°': len(æ¡£ä½æ•°æ®),
                        'å¹³å‡CQI': æ¡£ä½æ•°æ®['CQIä¼˜è‰¯ç‡'].mean(),
                        'å¹³å‡ä¸‹è¡Œé€Ÿç‡': æ¡£ä½æ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                        'å¹³å‡ä¸Šè¡Œé€Ÿç‡': æ¡£ä½æ•°æ®['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                        'å¹³å‡è¦†ç›–ç”µå¹³': æ¡£ä½æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'].mean(),
                        'å¹³å‡SINR': æ¡£ä½æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'].mean()
                    }
                    
                    # ç»´åº¦ç‰¹å®šç»Ÿè®¡
                    if ç»´åº¦ == 'è¦†ç›–ç³»æ•°':
                        è¡Œ['å¹³å‡TA'] = æ¡£ä½æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡TA'].mean()
                        # â­ æ–°å¢ï¼šè®¡ç®—è¦†ç›–å’ŒSINRä¸CQIçš„ç›¸å…³æ€§
                        è¡Œ['è¦†ç›–_CQIç›¸å…³æ€§'] = self._è®¡ç®—ç›¸å…³æ€§(æ¡£ä½æ•°æ®, 'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³', 'CQIä¼˜è‰¯ç‡')
                        è¡Œ['SINR_CQIç›¸å…³æ€§'] = self._è®¡ç®—ç›¸å…³æ€§(æ¡£ä½æ•°æ®, 'å°åŒºMRè¦†ç›–å¹³å‡SINR', 'CQIä¼˜è‰¯ç‡')
                    elif ç»´åº¦ == 'TA':
                        è¡Œ['è¦†ç›–_CQIç›¸å…³æ€§'] = self._è®¡ç®—ç›¸å…³æ€§(æ¡£ä½æ•°æ®, 'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³', 'CQIä¼˜è‰¯ç‡')
                        è¡Œ['SINR_CQIç›¸å…³æ€§'] = self._è®¡ç®—ç›¸å…³æ€§(æ¡£ä½æ•°æ®, 'å°åŒºMRè¦†ç›–å¹³å‡SINR', 'CQIä¼˜è‰¯ç‡')
                    elif ç»´åº¦ == 'è¦†ç›–ç”µå¹³':
                        è¡Œ['SINR_CQIç›¸å…³ç³»æ•°'] = self._è®¡ç®—ç›¸å…³æ€§(æ¡£ä½æ•°æ®, 'å°åŒºMRè¦†ç›–å¹³å‡SINR', 'CQIä¼˜è‰¯ç‡')
                    
                    åˆ†æ¡£ç»“æœ.append(è¡Œ)
            
            ç»“æœ[åˆ¶å¼] = pd.DataFrame(åˆ†æ¡£ç»“æœ)
        
        return ç»“æœ
    
    def _è®¡ç®—ç›¸å…³æ€§(self, æ•°æ®: pd.DataFrame, å­—æ®µ1: str, å­—æ®µ2: str) -> float:
        """è¾…åŠ©æ–¹æ³•ï¼šè®¡ç®—ä¸¤ä¸ªå­—æ®µçš„ç›¸å…³ç³»æ•°"""
        try:
            æœ‰æ•ˆæ•°æ® = æ•°æ®[[å­—æ®µ1, å­—æ®µ2]].dropna()
            if len(æœ‰æ•ˆæ•°æ®) > 10:
                corr, _ = stats.pearsonr(æœ‰æ•ˆæ•°æ®[å­—æ®µ1], æœ‰æ•ˆæ•°æ®[å­—æ®µ2])
                return corr
        except Exception:
            pass
        return None
    
    def è¦†ç›–ç³»æ•°å››è±¡é™åˆ†æ_æŒ‰åˆ¶å¼(self, è¦†ç›–ç³»æ•°é˜ˆå€¼: float = 0.7, è¦†ç›–ç”µå¹³é˜ˆå€¼: float = -90) -> Dict:
        """å››è±¡é™åˆ†æï¼šè¦†ç›–ç³»æ•°Ã—è¦†ç›–ç”µå¹³çŸ©é˜µ"""
        åˆ†ç»„æ•°æ® = self.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
        ç»“æœ = {}
        for åˆ¶å¼, æ•°æ® in åˆ†ç»„æ•°æ®.items():
            if 'è¦†ç›–ç³»æ•°' not in æ•°æ®.columns:
                continue
                
            è±¡é™ç»Ÿè®¡ = []
            
            # å®šä¹‰å››ä¸ªè±¡é™
            è±¡é™å®šä¹‰ = [
                ('è±¡é™1: å¥½è¦†ç›–+åˆç†è¦†ç›–è·ç¦»', è¦†ç›–ç”µå¹³é˜ˆå€¼, float('inf'), 0, è¦†ç›–ç³»æ•°é˜ˆå€¼),
                ('è±¡é™2: å·®è¦†ç›–+åˆç†è¦†ç›–è·ç¦»', -float('inf'), è¦†ç›–ç”µå¹³é˜ˆå€¼, 0, è¦†ç›–ç³»æ•°é˜ˆå€¼),
                ('è±¡é™3: å¥½è¦†ç›–+è¿‡è¿œè¦†ç›–è·ç¦»', è¦†ç›–ç”µå¹³é˜ˆå€¼, float('inf'), è¦†ç›–ç³»æ•°é˜ˆå€¼, float('inf')),
                ('è±¡é™4: å·®è¦†ç›–+è¿‡è¿œè¦†ç›–è·ç¦»', -float('inf'), è¦†ç›–ç”µå¹³é˜ˆå€¼, è¦†ç›–ç³»æ•°é˜ˆå€¼, float('inf'))
            ]
            
            for è±¡é™å, ç”µå¹³ä¸‹é™, ç”µå¹³ä¸Šé™, ç³»æ•°ä¸‹é™, ç³»æ•°ä¸Šé™ in è±¡é™å®šä¹‰:
                è±¡é™æ•°æ® = æ•°æ®[
                    (æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'] > ç”µå¹³ä¸‹é™) & 
                    (æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'] <= ç”µå¹³ä¸Šé™) &
                    (æ•°æ®['è¦†ç›–ç³»æ•°'] > ç³»æ•°ä¸‹é™) & 
                    (æ•°æ®['è¦†ç›–ç³»æ•°'] <= ç³»æ•°ä¸Šé™)
                ]
                
                if len(è±¡é™æ•°æ®) > 0:
                    è±¡é™ç»Ÿè®¡.append({
                        'è±¡é™': è±¡é™å,
                        'æ ·æœ¬æ•°': len(è±¡é™æ•°æ®),
                        'å æ¯”(%)': len(è±¡é™æ•°æ®) / len(æ•°æ®) * 100,
                        'å¹³å‡CQI': è±¡é™æ•°æ®['CQIä¼˜è‰¯ç‡'].mean(),
                        'å¹³å‡ä¸‹è¡Œé€Ÿç‡': è±¡é™æ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].mean(),
                        'å¹³å‡è¦†ç›–ç”µå¹³': è±¡é™æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'].mean(),
                        'å¹³å‡è¦†ç›–ç³»æ•°': è±¡é™æ•°æ®['è¦†ç›–ç³»æ•°'].mean(),
                        'å¹³å‡SINR': è±¡é™æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'].mean()
                    })
            
            ç»“æœ[åˆ¶å¼] = pd.DataFrame(è±¡é™ç»Ÿè®¡)
        return ç»“æœ


def ç”Ÿæˆç»¼åˆæŠ¥å‘Š(åˆ†æå™¨: CQIåˆ†æå™¨) -> str:
    """ç”Ÿæˆç»¼åˆåˆ†ææŠ¥å‘Šï¼Œæ±‡æ€»å„é¡µé¢å…³é”®æ´å¯Ÿ"""
    from datetime import datetime
    
    æŠ¥å‘Š = []
    æŠ¥å‘Š.append("=" * 60)
    æŠ¥å‘Š.append("ğŸ“Š 5G CQIå…³è”æ€§èƒ½åˆ†æ - ç»¼åˆæŠ¥å‘Š")
    æŠ¥å‘Š.append(f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    æŠ¥å‘Š.append("=" * 60)
    æŠ¥å‘Š.append("")
    
    # 1. æ¦‚è§ˆç»Ÿè®¡
    ç»Ÿè®¡æ‘˜è¦ = åˆ†æå™¨.è·å–ç»Ÿè®¡æ‘˜è¦_æŒ‰åˆ¶å¼()
    if 'n41' in ç»Ÿè®¡æ‘˜è¦ and 'n28' in ç»Ÿè®¡æ‘˜è¦:
        n41 = ç»Ÿè®¡æ‘˜è¦['n41']
        n28 = ç»Ÿè®¡æ‘˜è¦['n28']
        æŠ¥å‘Š.append("ã€ä¸€ã€æ¦‚è§ˆå¯¹æ¯”ã€‘")
        æŠ¥å‘Š.append(f"  N41: CQIä¼˜è‰¯ç‡ {n41['å¹³å‡CQI']:.2f}%, ä¸‹è¡Œé€Ÿç‡ {n41['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f} Mbps, å°åŒºæ•° {n41['æ•°æ®é‡']:,}")
        æŠ¥å‘Š.append(f"  N28: CQIä¼˜è‰¯ç‡ {n28['å¹³å‡CQI']:.2f}%, ä¸‹è¡Œé€Ÿç‡ {n28['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f} Mbps, å°åŒºæ•° {n28['æ•°æ®é‡']:,}")
        æŠ¥å‘Š.append(f"  CQIå·®å¼‚: {abs(n41['å¹³å‡CQI'] - n28['å¹³å‡CQI']):.2f}% ({'N41æ›´ä¼˜' if n41['å¹³å‡CQI'] > n28['å¹³å‡CQI'] else 'N28æ›´ä¼˜'})")
        æŠ¥å‘Š.append("")
    
    # 2. ç›¸å…³æ€§åˆ†æ - å½±å“CQIçš„ä¸»è¦å› ç´ 
    try:
        å½±å“ç»“æœ = åˆ†æå™¨.åˆ†æå½±å“CQIçš„æŒ‡æ ‡_æŒ‰åˆ¶å¼()
        æŠ¥å‘Š.append("ã€äºŒã€å½±å“CQIçš„ä¸»è¦å› ç´ ã€‘")
        for åˆ¶å¼ in ['n41', 'n28']:
            if åˆ¶å¼ in å½±å“ç»“æœ:
                æœ‰æ•ˆå› ç´  = [x for x in å½±å“ç»“æœ[åˆ¶å¼] if x['ç›¸å…³ç³»æ•°'] is not None][:3]
                if æœ‰æ•ˆå› ç´ :
                    æŠ¥å‘Š.append(f"  {åˆ¶å¼.upper()} TOP3:")
                    for i, f in enumerate(æœ‰æ•ˆå› ç´ , 1):
                        æŠ¥å‘Š.append(f"    {i}. {f['æŒ‡æ ‡']}: r={f['ç›¸å…³ç³»æ•°']:.3f} ({f['æ˜¾è‘—æ€§']})")
        æŠ¥å‘Š.append("")
    except:
        pass
    
    # 3. è´¡çŒ®åº¦åˆ†æ
    try:
        è´¡çŒ®åº¦ç»“æœ = åˆ†æå™¨.è´¡çŒ®åº¦åˆ†æ_æŒ‰åˆ¶å¼()
        æŠ¥å‘Š.append("ã€ä¸‰ã€æŒ‡æ ‡è´¡çŒ®åº¦æ’åã€‘")
        for åˆ¶å¼ in ['n41', 'n28']:
            if åˆ¶å¼ in è´¡çŒ®åº¦ç»“æœ and len(è´¡çŒ®åº¦ç»“æœ[åˆ¶å¼]['è´¡çŒ®åº¦åˆ—è¡¨']) > 0:
                top3 = è´¡çŒ®åº¦ç»“æœ[åˆ¶å¼]['è´¡çŒ®åº¦åˆ—è¡¨'][:3]
                æŠ¥å‘Š.append(f"  {åˆ¶å¼.upper()}:")
                for i, item in enumerate(top3, 1):
                    æŠ¥å‘Š.append(f"    {i}. {item['æŒ‡æ ‡']}: {item['è´¡çŒ®åº¦(%)']:.1f}% (ç´¯ç§¯: {item['ç´¯ç§¯è´¡çŒ®åº¦(%)']:.1f}%)")
        æŠ¥å‘Š.append("")
    except:
        pass
    
    # 4. è¦†ç›–ç³»æ•°åˆ†æ
    try:
        è¦†ç›–ç³»æ•°ç»Ÿè®¡ = åˆ†æå™¨.è¦†ç›–ç³»æ•°ç»Ÿè®¡_æŒ‰åˆ¶å¼()
        if len(è¦†ç›–ç³»æ•°ç»Ÿè®¡) > 0:
            æŠ¥å‘Š.append("ã€å››ã€è¦†ç›–ç³»æ•°åˆ†æã€‘")
            for åˆ¶å¼ in ['n41', 'n28']:
                if åˆ¶å¼ in è¦†ç›–ç³»æ•°ç»Ÿè®¡:
                    æ•°æ® = è¦†ç›–ç³»æ•°ç»Ÿè®¡[åˆ¶å¼]
                    è¶ŠåŒºå æ¯” = æ•°æ®['è¶ŠåŒºè¦†ç›–(>0.65)'] / æ•°æ®['æ ·æœ¬æ•°'] * 100
                    æŠ¥å‘Š.append(f"  {åˆ¶å¼.upper()}: å‡å€¼={æ•°æ®['å¹³å‡å€¼']:.3f}, è¶ŠåŒºè¦†ç›–å æ¯”={è¶ŠåŒºå æ¯”:.1f}%")
            æŠ¥å‘Š.append("")
    except:
        pass
    
    # 5. å››è±¡é™åˆ†ææ´å¯Ÿ
    try:
        å››è±¡é™ç»“æœ = åˆ†æå™¨.å››è±¡é™åˆ†æ_æŒ‰åˆ¶å¼(-90, 15)
        if len(å››è±¡é™ç»“æœ) > 0:
            æŠ¥å‘Š.append("ã€äº”ã€å››è±¡é™åˆ†æï¼ˆè¦†ç›–Ã—SINRï¼‰ã€‘")
            for åˆ¶å¼ in ['n41', 'n28']:
                if åˆ¶å¼ in å››è±¡é™ç»“æœ and len(å››è±¡é™ç»“æœ[åˆ¶å¼]) > 0:
                    # æ‰¾å‡ºå æ¯”æœ€å¤§çš„è±¡é™
                    æœ€å¤§è±¡é™ = å››è±¡é™ç»“æœ[åˆ¶å¼].loc[å››è±¡é™ç»“æœ[åˆ¶å¼]['å æ¯”(%)'].idxmax()]
                    æŠ¥å‘Š.append(f"  {åˆ¶å¼.upper()}: ä¸»è¦é—®é¢˜åŒºåŸŸä¸º'{æœ€å¤§è±¡é™['è±¡é™']}'ï¼Œå æ¯”{æœ€å¤§è±¡é™['å æ¯”(%)']:.1f}%ï¼Œå¹³å‡CQI={æœ€å¤§è±¡é™['å¹³å‡CQI']:.2f}%")
            æŠ¥å‘Š.append("")
    except:
        pass
    
    # 6. ä¼˜åŒ–å»ºè®®
    æŠ¥å‘Š.append("ã€å…­ã€ä¼˜åŒ–å»ºè®®æ‘˜è¦ã€‘")
    if 'n41' in ç»Ÿè®¡æ‘˜è¦ and 'n28' in ç»Ÿè®¡æ‘˜è¦:
        n41 = ç»Ÿè®¡æ‘˜è¦['n41']
        n28 = ç»Ÿè®¡æ‘˜è¦['n28']
        if n41['å¹³å‡CQI'] > n28['å¹³å‡CQI']:
            æŠ¥å‘Š.append("  â€¢ N28çš„CQIè¡¨ç°ç›¸å¯¹è¾ƒå·®ï¼Œå»ºè®®ä¼˜å…ˆä¼˜åŒ–N28ç½‘ç»œ")
        else:
            æŠ¥å‘Š.append("  â€¢ N41çš„CQIè¡¨ç°ç›¸å¯¹è¾ƒå·®ï¼Œå»ºè®®ä¼˜å…ˆä¼˜åŒ–N41ç½‘ç»œ")
        æŠ¥å‘Š.append("  â€¢ å…³æ³¨è´¡çŒ®åº¦æœ€é«˜çš„æŒ‡æ ‡ï¼Œé›†ä¸­èµ„æºè¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–")
        æŠ¥å‘Š.append("  â€¢ ç»“åˆå››è±¡é™åˆ†æï¼Œä¼˜å…ˆå¤„ç†'å·®è¦†ç›–+å·®SINR'åŒºåŸŸ")
    
    æŠ¥å‘Š.append("")
    æŠ¥å‘Š.append("=" * 60)
    æŠ¥å‘Š.append("æŠ¥å‘Šç”Ÿæˆå®Œæˆ | è¯¦ç»†åˆ†æè¯·æŸ¥çœ‹å„æ ‡ç­¾é¡µ")
    æŠ¥å‘Š.append("=" * 60)
    
    return "\n".join(æŠ¥å‘Š)


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”æ¦‚è§ˆ(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“æ¦‚è§ˆé¡µé¢çš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”"""
    ç»Ÿè®¡æ‘˜è¦ = åˆ†æå™¨.è·å–ç»Ÿè®¡æ‘˜è¦_æŒ‰åˆ¶å¼()

    # æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„
    if len(ç»Ÿè®¡æ‘˜è¦) == 1 and 'å…¨éƒ¨' in ç»Ÿè®¡æ‘˜è¦:
        st.warning("âš ï¸ æ•°æ®ä¸­æœªæ‰¾åˆ°'ç½‘ç»œåˆ¶å¼'åˆ—ï¼Œæ— æ³•è¿›è¡Œå¯¹æ¯”åˆ†æ")
        return
    
    # â­ æ–°å¢ï¼šä¸€é”®ç”Ÿæˆç»¼åˆæŠ¥å‘ŠæŒ‰é’®
    col_title, col_button = st.columns([3, 1])
    with col_title:
        st.markdown('<p class="sub-header">ğŸ  æ¦‚è§ˆ - N41 vs N28 ç½‘ç»œåˆ¶å¼å¯¹æ¯”</p>', unsafe_allow_html=True)
    with col_button:
        if st.button("ğŸ“‹ ä¸€é”®ç”Ÿæˆç»¼åˆæŠ¥å‘Š", type="primary", use_container_width=True):
            with st.spinner('æ­£åœ¨ç”Ÿæˆç»¼åˆæŠ¥å‘Š...'):
                ç»¼åˆæŠ¥å‘Š = ç”Ÿæˆç»¼åˆæŠ¥å‘Š(åˆ†æå™¨)
                st.session_state['ç»¼åˆæŠ¥å‘Š'] = ç»¼åˆæŠ¥å‘Š
                st.success("âœ… ç»¼åˆæŠ¥å‘Šå·²ç”Ÿæˆï¼")
    
    # æ˜¾ç¤ºç»¼åˆæŠ¥å‘Šï¼ˆå¦‚æœæœ‰ï¼‰
    if 'ç»¼åˆæŠ¥å‘Š' in st.session_state:
        with st.expander("ğŸ“‹ æŸ¥çœ‹ç»¼åˆæŠ¥å‘Š", expanded=True):
            st.text_area("ç»¼åˆæŠ¥å‘Šå†…å®¹", st.session_state['ç»¼åˆæŠ¥å‘Š'], height=500)
            
            # ä¸‹è½½æŒ‰é’®
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½æŠ¥å‘Š(.txt)",
                data=st.session_state['ç»¼åˆæŠ¥å‘Š'],
                file_name=f"CQIç»¼åˆæŠ¥å‘Š_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.txt",
                mime="text/plain"
            )
        st.markdown("---")

    # å·¦å³å¯¹æ¯”å¸ƒå±€
    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])

    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 ç½‘ç»œåˆ¶å¼</div>', unsafe_allow_html=True)
        if 'n41' in ç»Ÿè®¡æ‘˜è¦:
            æ•°æ® = ç»Ÿè®¡æ‘˜è¦['n41']
            st.metric("æ•°æ®é‡", f"{æ•°æ®['æ•°æ®é‡']:,}")
            st.metric("å¹³å‡CQIä¼˜è‰¯ç‡", f"{æ•°æ®['å¹³å‡CQI']:.2f}%", f"Â±{æ•°æ®['CQIæ ‡å‡†å·®']:.2f}")
            st.metric("å¹³å‡ä¸‹è¡Œé€Ÿç‡", f"{æ•°æ®['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f} Mbps", f"Â±{æ•°æ®['ä¸‹è¡Œé€Ÿç‡æ ‡å‡†å·®']:.2f}")
            st.metric("å¹³å‡ä¸Šè¡Œé€Ÿç‡", f"{æ•°æ®['å¹³å‡ä¸Šè¡Œé€Ÿç‡']:.2f} Mbps", f"Â±{æ•°æ®['ä¸Šè¡Œé€Ÿç‡æ ‡å‡†å·®']:.2f}")
            # â­ æ–°å¢ï¼šè¦†ç›–ç³»æ•°å’Œé‡å è¦†ç›–
            if 'å¹³å‡è¦†ç›–ç³»æ•°' in æ•°æ®:
                st.metric("å¹³å‡è¦†ç›–ç³»æ•°", f"{æ•°æ®['å¹³å‡è¦†ç›–ç³»æ•°']:.3f}", f"Â±{æ•°æ®['è¦†ç›–ç³»æ•°æ ‡å‡†å·®']:.3f}")
            if 'å¹³å‡é‡å è¦†ç›–' in æ•°æ®:
                st.metric("å¹³å‡é‡å è¦†ç›–", f"{æ•°æ®['å¹³å‡é‡å è¦†ç›–']:.2f}%", f"Â±{æ•°æ®['é‡å è¦†ç›–æ ‡å‡†å·®']:.2f}")

    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)

    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 ç½‘ç»œåˆ¶å¼</div>', unsafe_allow_html=True)
        if 'n28' in ç»Ÿè®¡æ‘˜è¦:
            æ•°æ® = ç»Ÿè®¡æ‘˜è¦['n28']
            st.metric("æ•°æ®é‡", f"{æ•°æ®['æ•°æ®é‡']:,}")
            st.metric("å¹³å‡CQIä¼˜è‰¯ç‡", f"{æ•°æ®['å¹³å‡CQI']:.2f}%", f"Â±{æ•°æ®['CQIæ ‡å‡†å·®']:.2f}")
            st.metric("å¹³å‡ä¸‹è¡Œé€Ÿç‡", f"{æ•°æ®['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f} Mbps", f"Â±{æ•°æ®['ä¸‹è¡Œé€Ÿç‡æ ‡å‡†å·®']:.2f}")
            st.metric("å¹³å‡ä¸Šè¡Œé€Ÿç‡", f"{æ•°æ®['å¹³å‡ä¸Šè¡Œé€Ÿç‡']:.2f} Mbps", f"Â±{æ•°æ®['ä¸Šè¡Œé€Ÿç‡æ ‡å‡†å·®']:.2f}")
            # â­ æ–°å¢ï¼šè¦†ç›–ç³»æ•°å’Œé‡å è¦†ç›–
            if 'å¹³å‡è¦†ç›–ç³»æ•°' in æ•°æ®:
                st.metric("å¹³å‡è¦†ç›–ç³»æ•°", f"{æ•°æ®['å¹³å‡è¦†ç›–ç³»æ•°']:.3f}", f"Â±{æ•°æ®['è¦†ç›–ç³»æ•°æ ‡å‡†å·®']:.3f}")
            if 'å¹³å‡é‡å è¦†ç›–' in æ•°æ®:
                st.metric("å¹³å‡é‡å è¦†ç›–", f"{æ•°æ®['å¹³å‡é‡å è¦†ç›–']:.2f}%", f"Â±{æ•°æ®['é‡å è¦†ç›–æ ‡å‡†å·®']:.2f}")

    # æ ‡å‡†å·®è¯´æ˜
    st.markdown("""
    <div style="background-color: #e8f4f8; padding: 12px 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #17a2b8;">
        <b>ğŸ“Š å…³äº"Â±æ•°å€¼"çš„è¯´æ˜ï¼ˆç¦»æ•£ç¨‹åº¦/æ ‡å‡†å·®ï¼‰ï¼š</b><br><br>
        æŒ‡æ ‡å¡ç‰‡ä¸­æ˜¾ç¤ºçš„ <b>"â†— Â±X.XX"</b> è¡¨ç¤ºè¯¥æŒ‡æ ‡çš„<b>æ ‡å‡†å·®</b>ï¼Œåæ˜ æ•°æ®çš„ç¦»æ•£ç¨‹åº¦ï¼ˆæ³¢åŠ¨èŒƒå›´ï¼‰ã€‚<br><br>
        <b>â€¢ æ ‡å‡†å·®å°</b>ï¼ˆå¦‚N41çš„Â±4.11ï¼‰ï¼šæ•°æ®é›†ä¸­åœ¨å¹³å‡å€¼é™„è¿‘ï¼Œç½‘ç»œè´¨é‡<b>ç¨³å®šå‡åŒ€</b><br>
        <b>â€¢ æ ‡å‡†å·®å¤§</b>ï¼ˆå¦‚N28çš„Â±7.70ï¼‰ï¼šæ•°æ®åˆ†æ•£ï¼Œæœ‰çš„å¾ˆé«˜æœ‰çš„å¾ˆä½ï¼Œç½‘ç»œè´¨é‡<b>å‚å·®ä¸é½</b><br><br>
        <b>å®é™…æ„ä¹‰</b>ï¼šN28çš„æ ‡å‡†å·®å¤§äºN41ï¼Œè¯´æ˜N28ç½‘ç»œä¸­å°åŒºæ€§èƒ½å·®å¼‚å¤§ï¼Œå­˜åœ¨"å¥½åŒº"å’Œ"å·®åŒº"çš„æ˜æ˜¾åˆ†åŒ–ï¼Œéœ€è¦é‡ç‚¹ä¼˜åŒ–æ€§èƒ½è¾ƒå·®çš„å°åŒºä»¥æå‡æ•´ä½“å‡åŒ€æ€§ã€‚
    </div>
    """, unsafe_allow_html=True)

    st.markdown("---")

    # â­ æ–°å¢ï¼šè¦†ç›–åŒºåŸŸåˆ†ç±»åˆ†æï¼ˆæŒ‰åˆ¶å¼åˆ†å¼€å±•ç¤ºï¼‰
    st.markdown('<p class="sub-header">ğŸ“ è¦†ç›–åŒºåŸŸåˆ†ç±»åˆ†æï¼ˆåŸå¸‚/å†œæ‘/å¿åŸï¼‰- æŒ‰ç½‘ç»œåˆ¶å¼</p>', unsafe_allow_html=True)
    
    åŒºåŸŸç»Ÿè®¡ = åˆ†æå™¨.æŒ‰åˆ¶å¼å’Œè¦†ç›–åŒºåŸŸåˆ†ç»„ç»Ÿè®¡()
    if åŒºåŸŸç»Ÿè®¡:
        col_n41_area, col_n28_area = st.columns(2)
        
        with col_n41_area:
            st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - è¦†ç›–åŒºåŸŸåˆ†å¸ƒ</div>', unsafe_allow_html=True)
            if 'n41' in åŒºåŸŸç»Ÿè®¡:
                # åˆ›å»ºN41åŒºåŸŸæ•°æ®è¡¨
                n41åŒºåŸŸæ•°æ® = []
                for åŒºåŸŸ, ç»Ÿè®¡ in åŒºåŸŸç»Ÿè®¡['n41'].items():
                    n41åŒºåŸŸæ•°æ®.append({
                        'è¦†ç›–åŒºåŸŸ': åŒºåŸŸ,
                        'å°åŒºæ•°': f"{ç»Ÿè®¡['æ•°æ®é‡']:,}",
                        'CQI': f"{ç»Ÿè®¡['å¹³å‡CQI']:.2f}%",
                        'ä¸‹è¡Œé€Ÿç‡': f"{ç»Ÿè®¡['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f}",
                        'ä¸Šè¡Œé€Ÿç‡': f"{ç»Ÿè®¡['å¹³å‡ä¸Šè¡Œé€Ÿç‡']:.2f}",
                        'é‡å è¦†ç›–': f"{ç»Ÿè®¡['å¹³å‡é‡å è¦†ç›–']:.2f}%" if ç»Ÿè®¡['å¹³å‡é‡å è¦†ç›–'] is not None else '-',
                        'è¦†ç›–ç³»æ•°': f"{ç»Ÿè®¡['å¹³å‡è¦†ç›–ç³»æ•°']:.3f}" if ç»Ÿè®¡['å¹³å‡è¦†ç›–ç³»æ•°'] is not None else '-'
                    })
                n41åŒºåŸŸdf = pd.DataFrame(n41åŒºåŸŸæ•°æ®)
                st.dataframe(n41åŒºåŸŸdf, use_container_width=True, hide_index=True)
                
                # N41å„åŒºåŸŸCQIå¯¹æ¯”æŸ±çŠ¶å›¾
                fig_n41_bar = px.bar(
                    n41åŒºåŸŸdf, x='è¦†ç›–åŒºåŸŸ', y=[float(x.replace('%', '')) for x in n41åŒºåŸŸdf['CQI']],
                    title="N41å„åŒºåŸŸCQIä¼˜è‰¯ç‡å¯¹æ¯”",
                    labels={'y': 'CQIä¼˜è‰¯ç‡(%)'},
                    color='è¦†ç›–åŒºåŸŸ',
                    color_discrete_sequence=['#1E90FF', '#4169E1', '#6495ED']
                )
                fig_n41_bar.update_layout(template="plotly_white", height=300, showlegend=False)
                st.plotly_chart(fig_n41_bar, use_container_width=True)
            else:
                st.info("N41æ— è¦†ç›–åŒºåŸŸæ•°æ®")
        
        with col_n28_area:
            st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - è¦†ç›–åŒºåŸŸåˆ†å¸ƒ</div>', unsafe_allow_html=True)
            if 'n28' in åŒºåŸŸç»Ÿè®¡:
                # åˆ›å»ºN28åŒºåŸŸæ•°æ®è¡¨
                n28åŒºåŸŸæ•°æ® = []
                for åŒºåŸŸ, ç»Ÿè®¡ in åŒºåŸŸç»Ÿè®¡['n28'].items():
                    n28åŒºåŸŸæ•°æ®.append({
                        'è¦†ç›–åŒºåŸŸ': åŒºåŸŸ,
                        'å°åŒºæ•°': f"{ç»Ÿè®¡['æ•°æ®é‡']:,}",
                        'CQI': f"{ç»Ÿè®¡['å¹³å‡CQI']:.2f}%",
                        'ä¸‹è¡Œé€Ÿç‡': f"{ç»Ÿè®¡['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f}",
                        'ä¸Šè¡Œé€Ÿç‡': f"{ç»Ÿè®¡['å¹³å‡ä¸Šè¡Œé€Ÿç‡']:.2f}",
                        'é‡å è¦†ç›–': f"{ç»Ÿè®¡['å¹³å‡é‡å è¦†ç›–']:.2f}%" if ç»Ÿè®¡['å¹³å‡é‡å è¦†ç›–'] is not None else '-',
                        'è¦†ç›–ç³»æ•°': f"{ç»Ÿè®¡['å¹³å‡è¦†ç›–ç³»æ•°']:.3f}" if ç»Ÿè®¡['å¹³å‡è¦†ç›–ç³»æ•°'] is not None else '-'
                    })
                n28åŒºåŸŸdf = pd.DataFrame(n28åŒºåŸŸæ•°æ®)
                st.dataframe(n28åŒºåŸŸdf, use_container_width=True, hide_index=True)
                
                # N28å„åŒºåŸŸCQIå¯¹æ¯”æŸ±çŠ¶å›¾
                fig_n28_bar = px.bar(
                    n28åŒºåŸŸdf, x='è¦†ç›–åŒºåŸŸ', y=[float(x.replace('%', '')) for x in n28åŒºåŸŸdf['CQI']],
                    title="N28å„åŒºåŸŸCQIä¼˜è‰¯ç‡å¯¹æ¯”",
                    labels={'y': 'CQIä¼˜è‰¯ç‡(%)'},
                    color='è¦†ç›–åŒºåŸŸ',
                    color_discrete_sequence=['#FF6B6B', '#FF8E53', '#FFA07A']
                )
                fig_n28_bar.update_layout(template="plotly_white", height=300, showlegend=False)
                st.plotly_chart(fig_n28_bar, use_container_width=True)
            else:
                st.info("N28æ— è¦†ç›–åŒºåŸŸæ•°æ®")
    else:
        st.info("â„¹ï¸ æ•°æ®ä¸­æœªæ‰¾åˆ°'è¦†ç›–åŒºåŸŸ'åˆ—ï¼Œæ— æ³•è¿›è¡Œåˆ†ç±»åˆ†æ")

    st.markdown("---")

    # CQIåˆ†å¸ƒå¯¹æ¯”
    st.markdown('<p class="sub-header">ğŸ“ˆ CQIä¼˜è‰¯ç‡åˆ†å¸ƒå¯¹æ¯”</p>', unsafe_allow_html=True)

    col_hist1, col_hist2 = st.columns(2)

    åˆ†ç»„æ•°æ® = åˆ†æå™¨.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()

    with col_hist1:
        if 'n41' in åˆ†ç»„æ•°æ®:
            fig_n41 = px.histogram(
                åˆ†ç»„æ•°æ®['n41'],
                x="CQIä¼˜è‰¯ç‡",
                nbins=50,
                color_discrete_sequence=['#1E90FF'],
                title="N41 - CQIä¼˜è‰¯ç‡åˆ†å¸ƒ"
            )
            fig_n41.update_layout(template="plotly_white", height=400)
            st.plotly_chart(fig_n41, use_container_width=True)

    with col_hist2:
        if 'n28' in åˆ†ç»„æ•°æ®:
            fig_n28 = px.histogram(
                åˆ†ç»„æ•°æ®['n28'],
                x="CQIä¼˜è‰¯ç‡",
                nbins=50,
                color_discrete_sequence=['#FF6B6B'],
                title="N28 - CQIä¼˜è‰¯ç‡åˆ†å¸ƒ"
            )
            fig_n28.update_layout(template="plotly_white", height=400)
            st.plotly_chart(fig_n28, use_container_width=True)

    # åˆ†ææ€»ç»“
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)

    if 'n41' in ç»Ÿè®¡æ‘˜è¦ and 'n28' in ç»Ÿè®¡æ‘˜è¦:
        n41 = ç»Ÿè®¡æ‘˜è¦['n41']
        n28 = ç»Ÿè®¡æ‘˜è¦['n28']

        cqi_diff = n41['å¹³å‡CQI'] - n28['å¹³å‡CQI']
        ä¸‹è¡Œ_diff = n41['å¹³å‡ä¸‹è¡Œé€Ÿç‡'] - n28['å¹³å‡ä¸‹è¡Œé€Ÿç‡']
        ä¸Šè¡Œ_diff = n41['å¹³å‡ä¸Šè¡Œé€Ÿç‡'] - n28['å¹³å‡ä¸Šè¡Œé€Ÿç‡']

        æ€»ç»“å†…å®¹ = f"""
        <div class="highlight">
        <b>ğŸ“Š æ¦‚è§ˆåˆ†ææ€»ç»“</b><br><br>
        <b>1. CQIä¼˜è‰¯ç‡å¯¹æ¯”ï¼š</b><br>
        â€¢ N41å¹³å‡CQIä¼˜è‰¯ç‡ä¸º <b>{n41['å¹³å‡CQI']:.2f}%</b>ï¼ŒN28ä¸º <b>{n28['å¹³å‡CQI']:.2f}%</b><br>
        â€¢ ä¸¤è€…å·®å¼‚ï¼š<b>{abs(cqi_diff):.2f}%</b>ï¼Œ{'N41ä¼˜äºN28' if cqi_diff > 0 else 'N28ä¼˜äºN41'}<br><br>

        <b>2. ä¸‹è¡Œé€Ÿç‡å¯¹æ¯”ï¼š</b><br>
        â€¢ N41å¹³å‡ä¸‹è¡Œé€Ÿç‡ä¸º <b>{n41['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f} Mbps</b>ï¼ŒN28ä¸º <b>{n28['å¹³å‡ä¸‹è¡Œé€Ÿç‡']:.2f} Mbps</b><br>
        â€¢ ä¸¤è€…å·®å¼‚ï¼š<b>{abs(ä¸‹è¡Œ_diff):.2f} Mbps</b>ï¼Œ{'N41ä¼˜äºN28' if ä¸‹è¡Œ_diff > 0 else 'N28ä¼˜äºN41'}<br><br>

        <b>3. ä¸Šè¡Œé€Ÿç‡å¯¹æ¯”ï¼š</b><br>
        â€¢ N41å¹³å‡ä¸Šè¡Œé€Ÿç‡ä¸º <b>{n41['å¹³å‡ä¸Šè¡Œé€Ÿç‡']:.2f} Mbps</b>ï¼ŒN28ä¸º <b>{n28['å¹³å‡ä¸Šè¡Œé€Ÿç‡']:.2f} Mbps</b><br>
        â€¢ ä¸¤è€…å·®å¼‚ï¼š<b>{abs(ä¸Šè¡Œ_diff):.2f} Mbps</b>ï¼Œ{'N41ä¼˜äºN28' if ä¸Šè¡Œ_diff > 0 else 'N28ä¼˜äºN41'}<br><br>

        <b>4. æ•´ä½“è¯„ä¼°ï¼š</b><br>
        â€¢ {'N41åœ¨å„é¡¹æŒ‡æ ‡ä¸Šå‡ä¼˜äºN28ï¼Œç½‘ç»œæ€§èƒ½æ›´ä¼˜' if cqi_diff > 0 and ä¸‹è¡Œ_diff > 0 and ä¸Šè¡Œ_diff > 0 else 'N28åœ¨æŸäº›æŒ‡æ ‡ä¸Šè¡¨ç°æ›´å¥½ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ†æä¼˜åŒ–'}<br>
        â€¢ N41æ•°æ®é‡ï¼š{n41['æ•°æ®é‡']:,}æ¡ï¼ŒN28æ•°æ®é‡ï¼š{n28['æ•°æ®é‡']:,}æ¡
        </div>
        """
        st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)


def å®‰å…¨ç”Ÿæˆæ•£ç‚¹å›¾(æ•°æ®: pd.DataFrame, xè½´: str, yè½´: str, é¢œè‰²: str, æ ‡é¢˜: str, é…è‰²: str = "Blues") -> go.Figure:
    """å®‰å…¨ç”Ÿæˆæ•£ç‚¹å›¾ï¼Œå¤„ç†å¯èƒ½çš„é”™è¯¯"""
    try:
        if æ•°æ® is None or len(æ•°æ®) == 0:
            return None
        # æ£€æŸ¥å¿…è¦çš„åˆ—æ˜¯å¦å­˜åœ¨
        å¿…è¦åˆ— = [xè½´, yè½´, é¢œè‰²]
        ç¼ºå¤±åˆ— = [åˆ— for åˆ— in å¿…è¦åˆ— if åˆ— not in æ•°æ®.columns]
        if ç¼ºå¤±åˆ—:
            return None

        # ç¡®ä¿æ•°æ®ç±»å‹æ­£ç¡®
        temp_data = æ•°æ®[å¿…è¦åˆ—].copy()
        for åˆ— in å¿…è¦åˆ—:
            temp_data[åˆ—] = pd.to_numeric(temp_data[åˆ—], errors='coerce')

        # åˆ é™¤NaN
        temp_data = temp_data.dropna()
        if len(temp_data) == 0:
            return None

        # é‡‡æ ·
        æ ·æœ¬æ•° = min(3000, len(temp_data))
        æ ·æœ¬æ•°æ® = temp_data.sample(æ ·æœ¬æ•°) if æ ·æœ¬æ•° > 0 else temp_data

        # è®¡ç®—è½´èŒƒå›´ï¼ˆç•™10%è¾¹è·ï¼‰
        x_min, x_max = æ ·æœ¬æ•°æ®[xè½´].min(), æ ·æœ¬æ•°æ®[xè½´].max()
        y_min, y_max = æ ·æœ¬æ•°æ®[yè½´].min(), æ ·æœ¬æ•°æ®[yè½´].max()
        x_range = [x_min - (x_max - x_min) * 0.1, x_max + (x_max - x_min) * 0.1]
        y_range = [y_min - (y_max - y_min) * 0.1, y_max + (y_max - y_min) * 0.1]

        # è®¡ç®—é¢œè‰²èŒƒå›´
        color_min, color_max = æ ·æœ¬æ•°æ®[é¢œè‰²].min(), æ ·æœ¬æ•°æ®[é¢œè‰²].max()
        color_range = [color_min - (color_max - color_min) * 0.05, color_max + (color_max - color_min) * 0.05]

        fig = go.Figure()

        # æ·»åŠ æ•£ç‚¹
        fig.add_trace(go.Scatter(
            x=æ ·æœ¬æ•°æ®[xè½´],
            y=æ ·æœ¬æ•°æ®[yè½´],
            mode='markers',
            marker=dict(
                size=6,
                color=æ ·æœ¬æ•°æ®[é¢œè‰²],
                colorscale=é…è‰²,
                opacity=0.6,
                cmin=color_range[0],
                cmax=color_range[1],
                colorbar=dict(title=é¢œè‰², thickness=15)
            ),
            hovertemplate=f'{xè½´}: %{{x:.2f}}<br>{yè½´}: %{{y:.2f}}<br>{é¢œè‰²}: %{{marker.color:.2f}}<extra></extra>'
        ))

        # æ·»åŠ è¶‹åŠ¿çº¿
        try:
            from scipy import stats
            valid_data = temp_data[[xè½´, yè½´]].dropna()
            if len(valid_data) > 2:
                slope, intercept, r_value, p_value, std_err = stats.linregress(valid_data[xè½´], valid_data[yè½´])
                x_line = np.array([valid_data[xè½´].min(), valid_data[xè½´].max()])
                y_line = slope * x_line + intercept
                fig.add_trace(go.Scatter(
                    x=x_line,
                    y=y_line,
                    mode='lines',
                    line=dict(color='red', width=2, dash='dash'),
                    name=f'è¶‹åŠ¿çº¿ (R={r_value:.3f})',
                    hovertemplate=f'RÂ²={r_value**2:.3f}<br>æ–œç‡={slope:.3f}<extra></extra>'
                ))
        except:
            pass

        fig.update_layout(
            title=dict(text=æ ‡é¢˜, font=dict(size=16)),
            template='plotly_white',
            height=420,
            margin=dict(l=60, r=30, t=50, b=50),
            xaxis=dict(
                title=xè½´,
                range=x_range,
                showgrid=True,
                gridwidth=1,
                gridcolor='lightgray'
            ),
            yaxis=dict(
                title=yè½´,
                range=y_range,
                showgrid=True,
                gridwidth=1,
                gridcolor='lightgray'
            ),
            hovermode='closest'
        )

        return fig
    except Exception as e:
        return None


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”é€Ÿç‡å½±å“(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“CQIå¯¹é€Ÿç‡å½±å“çš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”"""
    é€Ÿç‡å½±å“ = åˆ†æå™¨.åˆ†æCQIå¯¹é€Ÿç‡å½±å“_æŒ‰åˆ¶å¼()

    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])

    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - CQIå¯¹é€Ÿç‡å½±å“</div>', unsafe_allow_html=True)
        if 'n41' in é€Ÿç‡å½±å“:
            for é€Ÿç‡, ç»“æœ in é€Ÿç‡å½±å“['n41'].items():
                with st.container():
                    st.markdown(f"**{é€Ÿç‡}**")
                    col_a, col_b = st.columns(2)
                    with col_a:
                        st.metric("ç›¸å…³ç³»æ•°", f"{ç»“æœ['ç›¸å…³ç³»æ•°']:.4f}")
                    with col_b:
                        st.metric("På€¼", f"{ç»“æœ['På€¼']:.2e}", ç»“æœ['æ˜¾è‘—æ€§'])
                    st.write(f"å¼ºåº¦: {ç»“æœ['å¼ºåº¦']}")
                    st.markdown("---")

    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)

    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - CQIå¯¹é€Ÿç‡å½±å“</div>', unsafe_allow_html=True)
        if 'n28' in é€Ÿç‡å½±å“:
            for é€Ÿç‡, ç»“æœ in é€Ÿç‡å½±å“['n28'].items():
                with st.container():
                    st.markdown(f"**{é€Ÿç‡}**")
                    col_a, col_b = st.columns(2)
                    with col_a:
                        st.metric("ç›¸å…³ç³»æ•°", f"{ç»“æœ['ç›¸å…³ç³»æ•°']:.4f}")
                    with col_b:
                        st.metric("På€¼", f"{ç»“æœ['På€¼']:.2e}", ç»“æœ['æ˜¾è‘—æ€§'])
                    st.write(f"å¼ºåº¦: {ç»“æœ['å¼ºåº¦']}")
                    st.markdown("---")

    # åˆ†ææ€»ç»“
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)

    if 'n41' in é€Ÿç‡å½±å“ and 'n28' in é€Ÿç‡å½±å“:
        æ€»ç»“å†…å®¹ = "<div class='highlight'><b>ğŸ“Š CQIå¯¹é€Ÿç‡å½±å“åˆ†ææ€»ç»“</b><br><br>"

        æ€»ç»“å†…å®¹ += "<b>1. CQIä¸é€Ÿç‡ç›¸å…³æ€§å¯¹æ¯”ï¼š</b><br>"
        for é€Ÿç‡ in é€Ÿç‡å½±å“['n41'].keys():
            if é€Ÿç‡ in é€Ÿç‡å½±å“['n28']:
                n41_r = é€Ÿç‡å½±å“['n41'][é€Ÿç‡]['ç›¸å…³ç³»æ•°']
                n28_r = é€Ÿç‡å½±å“['n28'][é€Ÿç‡]['ç›¸å…³ç³»æ•°']
                æ€»ç»“å†…å®¹ += f"â€¢ {é€Ÿç‡}: N41ç›¸å…³ç³»æ•°={n41_r:.4f}, N28ç›¸å…³ç³»æ•°={n28_r:.4f}<br>"

        æ€»ç»“å†…å®¹ += "<br><b>2. æ˜¾è‘—æ€§åˆ†æï¼š</b><br>"
        for é€Ÿç‡ in é€Ÿç‡å½±å“['n41'].keys():
            if é€Ÿç‡ in é€Ÿç‡å½±å“['n28']:
                n41_sig = é€Ÿç‡å½±å“['n41'][é€Ÿç‡]['æ˜¾è‘—æ€§']
                n28_sig = é€Ÿç‡å½±å“['n28'][é€Ÿç‡]['æ˜¾è‘—æ€§']
                æ€»ç»“å†…å®¹ += f"â€¢ {é€Ÿç‡}: N41={n41_sig}, N28={n28_sig}<br>"

        æ€»ç»“å†…å®¹ += "<br><b>3. å…³é”®å‘ç°ï¼š</b><br>"
        # æ‰¾å‡ºç›¸å…³æ€§æœ€å¼ºçš„æŒ‡æ ‡
        n41æœ€å¼º = max(é€Ÿç‡å½±å“['n41'].items(), key=lambda x: abs(x[1]['ç›¸å…³ç³»æ•°']))
        n28æœ€å¼º = max(é€Ÿç‡å½±å“['n28'].items(), key=lambda x: abs(x[1]['ç›¸å…³ç³»æ•°']))
        æ€»ç»“å†…å®¹ += f"â€¢ N41ä¸CQIç›¸å…³æ€§æœ€å¼ºçš„æŒ‡æ ‡: {n41æœ€å¼º[0]} (ç›¸å…³ç³»æ•°={n41æœ€å¼º[1]['ç›¸å…³ç³»æ•°']:.4f})<br>"
        æ€»ç»“å†…å®¹ += f"â€¢ N28ä¸CQIç›¸å…³æ€§æœ€å¼ºçš„æŒ‡æ ‡: {n28æœ€å¼º[0]} (ç›¸å…³ç³»æ•°={n28æœ€å¼º[1]['ç›¸å…³ç³»æ•°']:.4f})<br>"

        æ€»ç»“å†…å®¹ += "<br><b>4. ä¼˜åŒ–å»ºè®®ï¼š</b><br>"
        æ€»ç»“å†…å®¹ += "â€¢ å…³æ³¨CQIå¯¹ä¸‹è¡Œ/ä¸Šè¡Œé€Ÿç‡å½±å“è¾ƒå¤§çš„ç½‘ç»œåˆ¶å¼<br>"
        æ€»ç»“å†…å®¹ += "â€¢ æ ¹æ®ç›¸å…³æ€§å¼ºåº¦åˆ¶å®šé’ˆå¯¹æ€§çš„CQIä¼˜åŒ–ç­–ç•¥<br>"
        æ€»ç»“å†…å®¹ += "â€¢ ä¼˜å…ˆä¼˜åŒ–ç›¸å…³æ€§é«˜çš„æŒ‡æ ‡å¯è·å¾—æ›´å¥½çš„æ•´ä½“æ€§èƒ½æå‡"

        æ€»ç»“å†…å®¹ += "</div>"
        st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)

    # ========== æ–°å¢ï¼šCQIåˆ†ä½æ•°é€Ÿç‡åˆ†æ ==========
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“Š CQIåˆ†ä½æ•°é€Ÿç‡åˆ†æ</p>', unsafe_allow_html=True)
    st.info("ğŸ’¡ **è¯´æ˜**ï¼šå°†CQIæŒ‰åˆ†ä½æ•°ï¼ˆ0-20%, 20-40%, 40-60%, 60-80%, 80-100%ï¼‰åˆ†ç»„ï¼Œè§‚å¯Ÿä¸åŒCQIåŒºé—´çš„é€Ÿç‡å˜åŒ–è¶‹åŠ¿")

    åˆ†ä½æ•°æ•°æ® = åˆ†æå™¨.CQIåˆ†ä½æ•°é€Ÿç‡åˆ†æ_æŒ‰åˆ¶å¼(åˆ†ä½æ•°=5)

    if åˆ†ä½æ•°æ•°æ®:
        col_n41_åˆ†ä½æ•°, col_n28_åˆ†ä½æ•° = st.columns(2)
        
        with col_n41_åˆ†ä½æ•°:
            if 'n41' in åˆ†ä½æ•°æ•°æ®:
                st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - åˆ†ä½æ•°åˆ†æ</div>', unsafe_allow_html=True)
                df_n41 = åˆ†ä½æ•°æ•°æ®['n41']
                # åˆ›å»ºå›¾è¡¨
                fig_n41 = go.Figure()
                fig_n41.add_trace(go.Scatter(
                    x=df_n41['CQIä¼˜è‰¯ç‡'],
                    y=df_n41['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'],
                    mode='lines+markers',
                    name='ä¸‹è¡Œé€Ÿç‡',
                    line=dict(color='blue', width=3),
                    marker=dict(size=10)
                ))
                fig_n41.add_trace(go.Scatter(
                    x=df_n41['CQIä¼˜è‰¯ç‡'],
                    y=df_n41['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'],
                    mode='lines+markers',
                    name='ä¸Šè¡Œé€Ÿç‡',
                    line=dict(color='orange', width=3),
                    marker=dict(size=10)
                ))
                fig_n41.update_layout(
                    title="N41 - CQIåˆ†ä½æ•° vs é€Ÿç‡è¶‹åŠ¿",
                    xaxis_title="CQIä¼˜è‰¯ç‡ (%)",
                    yaxis_title="é€Ÿç‡ (Mbps)",
                    template='plotly_white',
                    height=400,
                    hovermode='x unified'
                )
                st.plotly_chart(fig_n41, use_container_width=True)
                
                # æ•°æ®è¡¨
                with st.expander("æŸ¥çœ‹è¯¦ç»†æ•°æ®"):
                    st.dataframe(df_n41, use_container_width=True)
            else:
                st.info("N41æ•°æ®ä¸å¯ç”¨")
        
        with col_n28_åˆ†ä½æ•°:
            if 'n28' in åˆ†ä½æ•°æ•°æ®:
                st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - åˆ†ä½æ•°åˆ†æ</div>', unsafe_allow_html=True)
                df_n28 = åˆ†ä½æ•°æ•°æ®['n28']
                # åˆ›å»ºå›¾è¡¨
                fig_n28 = go.Figure()
                fig_n28.add_trace(go.Scatter(
                    x=df_n28['CQIä¼˜è‰¯ç‡'],
                    y=df_n28['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'],
                    mode='lines+markers',
                    name='ä¸‹è¡Œé€Ÿç‡',
                    line=dict(color='red', width=3),
                    marker=dict(size=10)
                ))
                fig_n28.add_trace(go.Scatter(
                    x=df_n28['CQIä¼˜è‰¯ç‡'],
                    y=df_n28['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'],
                    mode='lines+markers',
                    name='ä¸Šè¡Œé€Ÿç‡',
                    line=dict(color='green', width=3),
                    marker=dict(size=10)
                ))
                fig_n28.update_layout(
                    title="N28 - CQIåˆ†ä½æ•° vs é€Ÿç‡è¶‹åŠ¿",
                    xaxis_title="CQIä¼˜è‰¯ç‡ (%)",
                    yaxis_title="é€Ÿç‡ (Mbps)",
                    template='plotly_white',
                    height=400,
                    hovermode='x unified'
                )
                st.plotly_chart(fig_n28, use_container_width=True)
                
                # æ•°æ®è¡¨
                with st.expander("æŸ¥çœ‹è¯¦ç»†æ•°æ®"):
                    st.dataframe(df_n28, use_container_width=True)
            else:
                st.info("N28æ•°æ®ä¸å¯ç”¨")

    # ========== æ–°å¢ï¼šé€Ÿç‡åˆ†å¸ƒå¯¹æ¯”åˆ†æ ==========
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ˆ ä¸åŒCQIç­‰çº§çš„é€Ÿç‡åˆ†å¸ƒ</p>', unsafe_allow_html=True)
    st.info("ğŸ’¡ **è¯´æ˜**ï¼šæŒ‰CQIç­‰çº§ï¼ˆä½<60%ã€ä¸­60-85%ã€é«˜>85%ï¼‰åˆ†ç»„ï¼Œå¯¹æ¯”ä¸åŒç­‰çº§çš„é€Ÿç‡åˆ†å¸ƒæƒ…å†µ")

    åˆ†å¸ƒæ•°æ® = åˆ†æå™¨.é€Ÿç‡åˆ†å¸ƒå¯¹æ¯”_æŒ‰åˆ¶å¼()

    if åˆ†å¸ƒæ•°æ®:
        col_n41_åˆ†å¸ƒ, col_n28_åˆ†å¸ƒ = st.columns(2)
        
        with col_n41_åˆ†å¸ƒ:
            if 'n41' in åˆ†å¸ƒæ•°æ®:
                st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - é€Ÿç‡åˆ†å¸ƒ</div>', unsafe_allow_html=True)
                df_åˆ†å¸ƒ_n41 = åˆ†å¸ƒæ•°æ®['n41']
                
                # ç®€åŒ–æ˜¾ç¤ºçš„æ•°æ®è¡¨
                æ˜¾ç¤ºæ•°æ® = df_åˆ†å¸ƒ_n41[['CQIç­‰çº§', 'æ ·æœ¬æ•°', 'ä¸‹è¡Œå‡å€¼', 'ä¸‹è¡Œæœ€å¤§å€¼', 'ä¸Šè¡Œå‡å€¼', 'ä¸Šè¡Œæœ€å¤§å€¼']].copy()
                æ˜¾ç¤ºæ•°æ®.columns = ['CQIç­‰çº§', 'æ ·æœ¬æ•°', 'ä¸‹è¡Œå‡å€¼(Mbps)', 'ä¸‹è¡Œæœ€å¤§å€¼(Mbps)', 'ä¸Šè¡Œå‡å€¼(Mbps)', 'ä¸Šè¡Œæœ€å¤§å€¼(Mbps)']
                st.dataframe(æ˜¾ç¤ºæ•°æ®, use_container_width=True, hide_index=True)
                
                # åˆ›å»ºæŸ±çŠ¶å›¾å¯¹æ¯”
                fig_åˆ†å¸ƒ_n41 = go.Figure()
                fig_åˆ†å¸ƒ_n41.add_trace(go.Bar(
                    x=df_åˆ†å¸ƒ_n41['CQIç­‰çº§'],
                    y=df_åˆ†å¸ƒ_n41['ä¸‹è¡Œå‡å€¼'],
                    name='ä¸‹è¡Œå‡å€¼',
                    marker_color='blue',
                    error_y=dict(type='data', array=df_åˆ†å¸ƒ_n41['ä¸‹è¡Œæ ‡å‡†å·®'])
                ))
                fig_åˆ†å¸ƒ_n41.add_trace(go.Bar(
                    x=df_åˆ†å¸ƒ_n41['CQIç­‰çº§'],
                    y=df_åˆ†å¸ƒ_n41['ä¸Šè¡Œå‡å€¼'],
                    name='ä¸Šè¡Œå‡å€¼',
                    marker_color='orange',
                    error_y=dict(type='data', array=df_åˆ†å¸ƒ_n41['ä¸Šè¡Œæ ‡å‡†å·®'])
                ))
                fig_åˆ†å¸ƒ_n41.update_layout(
                    title="N41 - ä¸åŒCQIç­‰çº§çš„é€Ÿç‡å¯¹æ¯”ï¼ˆè¯¯å·®çº¿ä¸ºæ ‡å‡†å·®ï¼‰",
                    barmode='group',
                    xaxis_title="CQIç­‰çº§",
                    yaxis_title="é€Ÿç‡ (Mbps)",
                    template='plotly_white',
                    height=400
                )
                st.plotly_chart(fig_åˆ†å¸ƒ_n41, use_container_width=True)
            else:
                st.info("N41æ•°æ®ä¸å¯ç”¨")
        
        with col_n28_åˆ†å¸ƒ:
            if 'n28' in åˆ†å¸ƒæ•°æ®:
                st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - é€Ÿç‡åˆ†å¸ƒ</div>', unsafe_allow_html=True)
                df_åˆ†å¸ƒ_n28 = åˆ†å¸ƒæ•°æ®['n28']
                
                # ç®€åŒ–æ˜¾ç¤ºçš„æ•°æ®è¡¨
                æ˜¾ç¤ºæ•°æ® = df_åˆ†å¸ƒ_n28[['CQIç­‰çº§', 'æ ·æœ¬æ•°', 'ä¸‹è¡Œå‡å€¼', 'ä¸‹è¡Œæœ€å¤§å€¼', 'ä¸Šè¡Œå‡å€¼', 'ä¸Šè¡Œæœ€å¤§å€¼']].copy()
                æ˜¾ç¤ºæ•°æ®.columns = ['CQIç­‰çº§', 'æ ·æœ¬æ•°', 'ä¸‹è¡Œå‡å€¼(Mbps)', 'ä¸‹è¡Œæœ€å¤§å€¼(Mbps)', 'ä¸Šè¡Œå‡å€¼(Mbps)', 'ä¸Šè¡Œæœ€å¤§å€¼(Mbps)']
                st.dataframe(æ˜¾ç¤ºæ•°æ®, use_container_width=True, hide_index=True)
                
                # åˆ›å»ºæŸ±çŠ¶å›¾å¯¹æ¯”
                fig_åˆ†å¸ƒ_n28 = go.Figure()
                fig_åˆ†å¸ƒ_n28.add_trace(go.Bar(
                    x=df_åˆ†å¸ƒ_n28['CQIç­‰çº§'],
                    y=df_åˆ†å¸ƒ_n28['ä¸‹è¡Œå‡å€¼'],
                    name='ä¸‹è¡Œå‡å€¼',
                    marker_color='red',
                    error_y=dict(type='data', array=df_åˆ†å¸ƒ_n28['ä¸‹è¡Œæ ‡å‡†å·®'])
                ))
                fig_åˆ†å¸ƒ_n28.add_trace(go.Bar(
                    x=df_åˆ†å¸ƒ_n28['CQIç­‰çº§'],
                    y=df_åˆ†å¸ƒ_n28['ä¸Šè¡Œå‡å€¼'],
                    name='ä¸Šè¡Œå‡å€¼',
                    marker_color='green',
                    error_y=dict(type='data', array=df_åˆ†å¸ƒ_n28['ä¸Šè¡Œæ ‡å‡†å·®'])
                ))
                fig_åˆ†å¸ƒ_n28.update_layout(
                    title="N28 - ä¸åŒCQIç­‰çº§çš„é€Ÿç‡å¯¹æ¯”ï¼ˆè¯¯å·®çº¿ä¸ºæ ‡å‡†å·®ï¼‰",
                    barmode='group',
                    xaxis_title="CQIç­‰çº§",
                    yaxis_title="é€Ÿç‡ (Mbps)",
                    template='plotly_white',
                    height=400
                )
                st.plotly_chart(fig_åˆ†å¸ƒ_n28, use_container_width=True)
            else:
                st.info("N28æ•°æ®ä¸å¯ç”¨")

    # ========== æ–°å¢ï¼šå¼‚å¸¸å°åŒºè¯†åˆ« ==========
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ” å¼‚å¸¸å°åŒºè¯†åˆ«</p>', unsafe_allow_html=True)
    st.info("ğŸ’¡ **è¯´æ˜**ï¼šè¯†åˆ«CQIä¸é€Ÿç‡ä¸åŒ¹é…çš„å¼‚å¸¸å°åŒºï¼ˆé˜ˆå€¼=1.5å€æ ‡å‡†å·®ï¼‰ï¼Œå¯èƒ½å­˜åœ¨å¹²æ‰°ã€é…ç½®é—®é¢˜æˆ–ç‰¹æ®Šåœºæ™¯")

    å¼‚å¸¸å°åŒº = åˆ†æå™¨.è¯†åˆ«å¼‚å¸¸å°åŒº_æŒ‰åˆ¶å¼(é˜ˆå€¼å€æ•°=1.5)

    if å¼‚å¸¸å°åŒº:
        col_n41_å¼‚å¸¸, col_n28_å¼‚å¸¸ = st.columns(2)
        
        with col_n41_å¼‚å¸¸:
            if 'n41' in å¼‚å¸¸å°åŒº:
                st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - å¼‚å¸¸å°åŒº</div>', unsafe_allow_html=True)
                
                # é«˜CQIä½é€Ÿç‡
                é«˜ä½ = å¼‚å¸¸å°åŒº['n41']['é«˜CQIä½é€Ÿç‡']
                if len(é«˜ä½) > 0:
                    st.warning(f"âš ï¸ **é«˜CQIä½é€Ÿç‡å°åŒº** (å…±{len(é«˜ä½)}ä¸ª): CQIé«˜ä½†é€Ÿç‡ä½ï¼Œå¯èƒ½å­˜åœ¨å¹²æ‰°ã€æ‹¥å¡æˆ–ä¼˜åŒ–è¿‡åº¦")
                    æ˜¾ç¤ºåˆ— = ['å°åŒºåç§°', 'CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']
                    st.dataframe(é«˜ä½[æ˜¾ç¤ºåˆ—], use_container_width=True, hide_index=True)
                else:
                    st.success("âœ… æœªå‘ç°é«˜CQIä½é€Ÿç‡å°åŒº")
                
                st.markdown("---")
                
                # ä½CQIé«˜é€Ÿç‡
                ä½é«˜ = å¼‚å¸¸å°åŒº['n41']['ä½CQIé«˜é€Ÿç‡']
                if len(ä½é«˜) > 0:
                    st.info("ğŸ’¡ **ä½CQIé«˜é€Ÿç‡å°åŒº** (å…±{}ä¸ª): CQIä½ä½†é€Ÿç‡é«˜ï¼Œå¯èƒ½å­˜åœ¨æµ‹è¯•æ–¹æ³•é—®é¢˜ã€æ•°æ®é‡‡é›†å¼‚å¸¸æˆ–ç‰¹æ®Šåœºæ™¯".format(len(ä½é«˜)))
                    æ˜¾ç¤ºåˆ— = ['å°åŒºåç§°', 'CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']
                    st.dataframe(ä½é«˜[æ˜¾ç¤ºåˆ—], use_container_width=True, hide_index=True)
                else:
                    st.success("âœ… æœªå‘ç°ä½CQIé«˜é€Ÿç‡å°åŒº")
            else:
                st.info("N41æ•°æ®ä¸å¯ç”¨")
        
        with col_n28_å¼‚å¸¸:
            if 'n28' in å¼‚å¸¸å°åŒº:
                st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - å¼‚å¸¸å°åŒº</div>', unsafe_allow_html=True)
                
                # é«˜CQIä½é€Ÿç‡
                é«˜ä½ = å¼‚å¸¸å°åŒº['n28']['é«˜CQIä½é€Ÿç‡']
                if len(é«˜ä½) > 0:
                    st.warning(f"âš ï¸ **é«˜CQIä½é€Ÿç‡å°åŒº** (å…±{len(é«˜ä½)}ä¸ª): CQIé«˜ä½†é€Ÿç‡ä½ï¼Œå¯èƒ½å­˜åœ¨å¹²æ‰°ã€æ‹¥å¡æˆ–ä¼˜åŒ–è¿‡åº¦")
                    æ˜¾ç¤ºåˆ— = ['å°åŒºåç§°', 'CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']
                    st.dataframe(é«˜ä½[æ˜¾ç¤ºåˆ—], use_container_width=True, hide_index=True)
                else:
                    st.success("âœ… æœªå‘ç°é«˜CQIä½é€Ÿç‡å°åŒº")
                
                st.markdown("---")
                
                # ä½CQIé«˜é€Ÿç‡
                ä½é«˜ = å¼‚å¸¸å°åŒº['n28']['ä½CQIé«˜é€Ÿç‡']
                if len(ä½é«˜) > 0:
                    st.info("ğŸ’¡ **ä½CQIé«˜é€Ÿç‡å°åŒº** (å…±{}ä¸ª): CQIä½ä½†é€Ÿç‡é«˜ï¼Œå¯èƒ½å­˜åœ¨æµ‹è¯•æ–¹æ³•é—®é¢˜ã€æ•°æ®é‡‡é›†å¼‚å¸¸æˆ–ç‰¹æ®Šåœºæ™¯".format(len(ä½é«˜)))
                    æ˜¾ç¤ºåˆ— = ['å°åŒºåç§°', 'CQIä¼˜è‰¯ç‡', 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)', 'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']
                    st.dataframe(ä½é«˜[æ˜¾ç¤ºåˆ—], use_container_width=True, hide_index=True)
                else:
                    st.success("âœ… æœªå‘ç°ä½CQIé«˜é€Ÿç‡å°åŒº")
            else:
                st.info("N28æ•°æ®ä¸å¯ç”¨")


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”å½±å“å› ç´ (åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“å½±å“CQIå› ç´ çš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”"""
    å½±å“ç»“æœ = åˆ†æå™¨.åˆ†æå½±å“CQIçš„æŒ‡æ ‡_æŒ‰åˆ¶å¼()

    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])

    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - å½±å“å› ç´ æ’åº</div>', unsafe_allow_html=True)
        if 'n41' in å½±å“ç»“æœ:
            å›¾è¡¨æ•°æ® = pd.DataFrame(å½±å“ç»“æœ['n41'])
            fig_n41 = px.bar(
                å›¾è¡¨æ•°æ®,
                x="ç›¸å…³ç³»æ•°",
                y="æŒ‡æ ‡",
                orientation='h',
                color="ç›¸å…³ç³»æ•°",
                color_continuous_scale="Blues",
                title="N41 - å½±å“CQIçš„å› ç´ ",
                text_auto=".3f"
            )
            fig_n41.update_layout(template="plotly_white", yaxis={'categoryorder': 'total ascending'})
            st.plotly_chart(fig_n41, use_container_width=True)

    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)

    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - å½±å“å› ç´ æ’åº</div>', unsafe_allow_html=True)
        if 'n28' in å½±å“ç»“æœ:
            å›¾è¡¨æ•°æ® = pd.DataFrame(å½±å“ç»“æœ['n28'])
            fig_n28 = px.bar(
                å›¾è¡¨æ•°æ®,
                x="ç›¸å…³ç³»æ•°",
                y="æŒ‡æ ‡",
                orientation='h',
                color="ç›¸å…³ç³»æ•°",
                color_continuous_scale="Reds",
                title="N28 - å½±å“CQIçš„å› ç´ ",
                text_auto=".3f"
            )
            fig_n28.update_layout(template="plotly_white", yaxis={'categoryorder': 'total ascending'})
            st.plotly_chart(fig_n28, use_container_width=True)

    st.markdown("---")

    # è¯¦ç»†å¯¹æ¯”è¡¨
    st.markdown('<p class="sub-header">ğŸ“Š å½±å“å› ç´ è¯¦ç»†å¯¹æ¯”</p>', unsafe_allow_html=True)

    if 'n41' in å½±å“ç»“æœ and 'n28' in å½±å“ç»“æœ:
        å¯¹æ¯”æ•°æ® = []
        for i, (n41ç»“æœ, n28ç»“æœ) in enumerate(zip(å½±å“ç»“æœ['n41'], å½±å“ç»“æœ['n28'])):
            # å¤„ç†Noneå€¼çš„æƒ…å†µ
            n41ç³»æ•° = n41ç»“æœ['ç›¸å…³ç³»æ•°']
            n28ç³»æ•° = n28ç»“æœ['ç›¸å…³ç³»æ•°']
            
            # è®¡ç®—å·®å¼‚ï¼Œå¤„ç†Noneå€¼
            if n41ç³»æ•° is not None and n28ç³»æ•° is not None:
                å·®å¼‚å€¼ = abs(n41ç³»æ•° - n28ç³»æ•°)
            else:
                å·®å¼‚å€¼ = None
            
            å¯¹æ¯”æ•°æ®.append({
                'æŒ‡æ ‡': n41ç»“æœ['æŒ‡æ ‡'],
                'N41ç›¸å…³ç³»æ•°': n41ç³»æ•°,
                'N41æ˜¾è‘—æ€§': n41ç»“æœ['æ˜¾è‘—æ€§'] if n41ç³»æ•° is not None else 'æ•°æ®ä¸è¶³',
                'N28ç›¸å…³ç³»æ•°': n28ç³»æ•°,
                'N28æ˜¾è‘—æ€§': n28ç»“æœ['æ˜¾è‘—æ€§'] if n28ç³»æ•° is not None else 'æ•°æ®ä¸è¶³',
                'å·®å¼‚': å·®å¼‚å€¼
            })

        å¯¹æ¯”df = pd.DataFrame(å¯¹æ¯”æ•°æ®)
        
        # è‡ªå®šä¹‰æ ¼å¼åŒ–å‡½æ•°ï¼Œå¤„ç†Noneå€¼
        def æ ¼å¼åŒ–ç›¸å…³ç³»æ•°(val):
            if val is None:
                return '-'
            return f"{val:.4f}"
        
        st.dataframe(
            å¯¹æ¯”df.style.format({
                'N41ç›¸å…³ç³»æ•°': æ ¼å¼åŒ–ç›¸å…³ç³»æ•°,
                'N28ç›¸å…³ç³»æ•°': æ ¼å¼åŒ–ç›¸å…³ç³»æ•°,
                'å·®å¼‚': lambda x: '-' if x is None else f"{x:.4f}"
            }).background_gradient(subset=['å·®å¼‚'], cmap='YlOrRd'),
            use_container_width=True
        )

    # åˆ†ææ€»ç»“
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)

    if 'n41' in å½±å“ç»“æœ and 'n28' in å½±å“ç»“æœ:
        æ€»ç»“å†…å®¹ = "<div class='highlight'><b>ğŸ“Š å½±å“CQIçš„å› ç´ åˆ†ææ€»ç»“</b><br><br>"

        # è·å–å‰3ä¸ªæœ€é‡è¦å› ç´ ï¼ˆè¿‡æ»¤æ‰ç›¸å…³ç³»æ•°ä¸ºNoneçš„ï¼‰
        n41_top3 = [x for x in å½±å“ç»“æœ['n41'][:5] if x['ç›¸å…³ç³»æ•°'] is not None][:3]
        n28_top3 = [x for x in å½±å“ç»“æœ['n28'][:5] if x['ç›¸å…³ç³»æ•°'] is not None][:3]

        æ€»ç»“å†…å®¹ += "<b>1. N41ç½‘ç»œåˆ¶å¼TOP 3å½±å“å› ç´ ï¼š</b><br>"
        if n41_top3:
            for i, item in enumerate(n41_top3, 1):
                æ€»ç»“å†…å®¹ += f"â€¢ ç¬¬{i}ä½: {item['æŒ‡æ ‡']} (ç›¸å…³ç³»æ•°={item['ç›¸å…³ç³»æ•°']:.4f}, {item['æ˜¾è‘—æ€§']})<br>"
        else:
            æ€»ç»“å†…å®¹ += "â€¢ æ²¡æœ‰è¶³å¤Ÿçš„æœ‰æ•ˆæ•°æ®è¿›è¡Œåˆ†æ<br>"

        æ€»ç»“å†…å®¹ += "<br><b>2. N28ç½‘ç»œåˆ¶å¼TOP 3å½±å“å› ç´ ï¼š</b><br>"
        if n28_top3:
            for i, item in enumerate(n28_top3, 1):
                æ€»ç»“å†…å®¹ += f"â€¢ ç¬¬{i}ä½: {item['æŒ‡æ ‡']} (ç›¸å…³ç³»æ•°={item['ç›¸å…³ç³»æ•°']:.4f}, {item['æ˜¾è‘—æ€§']})<br>"
        else:
            æ€»ç»“å†…å®¹ += "â€¢ æ²¡æœ‰è¶³å¤Ÿçš„æœ‰æ•ˆæ•°æ®è¿›è¡Œåˆ†æ<br>"

        # è®¡ç®—å…±åŒå› ç´ 
        n41_factors = set([item['æŒ‡æ ‡'] for item in å½±å“ç»“æœ['n41'][:5] if item['ç›¸å…³ç³»æ•°'] is not None])
        n28_factors = set([item['æŒ‡æ ‡'] for item in å½±å“ç»“æœ['n28'][:5] if item['ç›¸å…³ç³»æ•°'] is not None])
        å…±åŒå› ç´  = n41_factors & n28_factors

        æ€»ç»“å†…å®¹ += "<br><b>3. å…±åŒé‡è¦å› ç´ ï¼š</b><br>"
        if å…±åŒå› ç´ :
            for factor in å…±åŒå› ç´ :
                æ€»ç»“å†…å®¹ += f"â€¢ {factor}<br>"
        else:
            æ€»ç»“å†…å®¹ += "â€¢ æ— å…±åŒçš„é‡è¦å› ç´ ï¼Œä¸¤ç§åˆ¶å¼çš„ä¼˜åŒ–é‡ç‚¹ä¸åŒ<br>"

        æ€»ç»“å†…å®¹ += "<br><b>4. ä¼˜åŒ–å»ºè®®ï¼š</b><br>"
        if n41_top3:
            æ€»ç»“å†…å®¹ += f"â€¢ N41åº”é‡ç‚¹ä¼˜åŒ–: {n41_top3[0]['æŒ‡æ ‡']}<br>"
        if n28_top3:
            æ€»ç»“å†…å®¹ += f"â€¢ N28åº”é‡ç‚¹ä¼˜åŒ–: {n28_top3[0]['æŒ‡æ ‡']}<br>"
        æ€»ç»“å†…å®¹ += "â€¢ é’ˆå¯¹ä¸åŒç½‘ç»œåˆ¶å¼åˆ¶å®šå·®å¼‚åŒ–çš„CQIä¼˜åŒ–ç­–ç•¥"

        æ€»ç»“å†…å®¹ += "</div>"
        st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”ç›¸å…³æ€§çŸ©é˜µ(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“ç›¸å…³æ€§å¯è§†åŒ–çš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”ï¼ˆåŒ…å«æ•£ç‚¹å›¾å’Œç›¸å…³æ€§çŸ©é˜µï¼‰"""
    
    st.info("""
    ğŸ“Š **ç›¸å…³æ€§å¯è§†åŒ–è¯´æ˜**ï¼šç»“åˆæ•£ç‚¹å›¾å’Œç›¸å…³æ€§çŸ©é˜µï¼Œå…¨é¢å±•ç¤ºæŒ‡æ ‡é—´çš„å…³ç³»
    â€¢ æ•£ç‚¹å›¾ï¼šå±•ç¤ºå…·ä½“æ•°æ®åˆ†å¸ƒå’Œè¶‹åŠ¿ï¼Œå¯ç›´è§‚çœ‹åˆ°å¼‚å¸¸å€¼
    â€¢ ç›¸å…³æ€§çŸ©é˜µï¼šå±•ç¤ºæ‰€æœ‰æŒ‡æ ‡é—´çš„ç›¸å…³æ€§å¼ºåº¦ï¼Œæ•°å€¼èŒƒå›´[-1, 1]
    """)
    
    åˆ—ååˆ—è¡¨ = [
        'CQIä¼˜è‰¯ç‡',
        'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
        'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
        'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³',
        'å°åŒºMRè¦†ç›–å¹³å‡SINR',
        'å°åŒºMRè¦†ç›–å¹³å‡TA',
        'å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³',
        'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)',  # â­æ–°å¢
        'è¦†ç›–ç³»æ•°'  # â­æ–°å¢
    ]

    ç®€çŸ­åˆ—å = {
        'CQIä¼˜è‰¯ç‡': 'CQI',
        'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)': 'ä¸‹è¡Œé€Ÿç‡',
        'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)': 'ä¸Šè¡Œé€Ÿç‡',
        'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³': 'è¦†ç›–ç”µå¹³',
        'å°åŒºMRè¦†ç›–å¹³å‡SINR': 'SINR',
        'å°åŒºMRè¦†ç›–å¹³å‡TA': 'TA',
        'å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³': 'å¹²æ‰°ç”µå¹³',
        'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)': 'é‡å è¦†ç›–',  # â­æ–°å¢
        'è¦†ç›–ç³»æ•°': 'è¦†ç›–ç³»æ•°'  # â­æ–°å¢
    }

    ç›¸å…³æ€§çŸ©é˜µ = åˆ†æå™¨.è®¡ç®—ç›¸å…³æ€§çŸ©é˜µ_æŒ‰åˆ¶å¼(åˆ—ååˆ—è¡¨)

    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])

    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - ç›¸å…³æ€§å¯è§†åŒ–</div>', unsafe_allow_html=True)
        if 'n41' in ç›¸å…³æ€§çŸ©é˜µ:
            çŸ©é˜µ = ç›¸å…³æ€§çŸ©é˜µ['n41'].copy()
            çŸ©é˜µ.index = [ç®€çŸ­åˆ—å.get(x, x) for x in çŸ©é˜µ.index]
            çŸ©é˜µ.columns = [ç®€çŸ­åˆ—å.get(x, x) for x in çŸ©é˜µ.columns]

            fig_n41 = go.Figure(data=go.Heatmap(
                z=çŸ©é˜µ.values,
                x=çŸ©é˜µ.columns,
                y=çŸ©é˜µ.index,
                colorscale='Blues',
                zmid=0,
                text=np.round(çŸ©é˜µ.values, 2),
                texttemplate='%{text}',
                textfont={"size": 10}
            ))
            fig_n41.update_layout(template="plotly_white", height=500)
            st.plotly_chart(fig_n41, use_container_width=True)

    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)

    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - ç›¸å…³æ€§å¯è§†åŒ–</div>', unsafe_allow_html=True)
        if 'n28' in ç›¸å…³æ€§çŸ©é˜µ:
            çŸ©é˜µ = ç›¸å…³æ€§çŸ©é˜µ['n28'].copy()
            çŸ©é˜µ.index = [ç®€çŸ­åˆ—å.get(x, x) for x in çŸ©é˜µ.index]
            çŸ©é˜µ.columns = [ç®€çŸ­åˆ—å.get(x, x) for x in çŸ©é˜µ.columns]

            fig_n28 = go.Figure(data=go.Heatmap(
                z=çŸ©é˜µ.values,
                x=çŸ©é˜µ.columns,
                y=çŸ©é˜µ.index,
                colorscale='Reds',
                zmid=0,
                text=np.round(çŸ©é˜µ.values, 2),
                texttemplate='%{text}',
                textfont={"size": 10}
            ))
            fig_n28.update_layout(template="plotly_white", height=500)
            st.plotly_chart(fig_n28, use_container_width=True)

    # ========== æ•£ç‚¹å›¾å¯¹æ¯” ==========
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ˆ å…³é”®æŒ‡æ ‡æ•£ç‚¹å›¾å¯¹æ¯”</p>', unsafe_allow_html=True)
    
    st.info("""
    ğŸ’¡ **æç¤º**ï¼šæ•£ç‚¹å›¾å±•ç¤ºå…³é”®æŒ‡æ ‡å¯¹ä¹‹é—´çš„æ•°æ®åˆ†å¸ƒå…³ç³»
    â€¢ è¶‹åŠ¿çº¿è™šçº¿è¡¨ç¤ºæ‹Ÿåˆè¶‹åŠ¿ï¼ŒRå€¼è¡¨ç¤ºç›¸å…³å¼ºåº¦
    â€¢ é¢œè‰²æ·±æµ…ä»£è¡¨ç¬¬ä¸‰ç»´æŒ‡æ ‡çš„å€¼ï¼ˆé€šå¸¸ä¸ºSINRæˆ–CQIï¼‰
    """)
    
    åˆ†ç»„æ•°æ® = åˆ†æå™¨.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
    
    # å®šä¹‰æ•£ç‚¹å›¾é…ç½®ï¼ˆç²¾é€‰5ä¸ªå…³é”®å…³ç³»ï¼‰
    æ•£ç‚¹å›¾é…ç½® = [
        ("ğŸ“Š CQIä¼˜è‰¯ç‡ vs ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡", "CQIä¼˜è‰¯ç‡", "ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)", "å°åŒºMRè¦†ç›–å¹³å‡SINR"),
        ("ğŸ“Š CQIä¼˜è‰¯ç‡ vs ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡", "CQIä¼˜è‰¯ç‡", "ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)", "å°åŒºMRè¦†ç›–å¹³å‡SINR"),
        ("ğŸ“¡ SINR vs ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡", "å°åŒºMRè¦†ç›–å¹³å‡SINR", "ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)", "CQIä¼˜è‰¯ç‡"),
        ("ğŸ“¶ è¦†ç›–ç”µå¹³ vs CQIä¼˜è‰¯ç‡", "å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³", "CQIä¼˜è‰¯ç‡", "å°åŒºMRè¦†ç›–å¹³å‡SINR"),
        ("ğŸ“ TA vs CQIä¼˜è‰¯ç‡", "å°åŒºMRè¦†ç›–å¹³å‡TA", "CQIä¼˜è‰¯ç‡", "å°åŒºMRè¦†ç›–å¹³å‡SINR"),
    ]
    
    for æ ‡é¢˜, xè½´, yè½´, é¢œè‰² in æ•£ç‚¹å›¾é…ç½®:
        st.markdown(f"**{æ ‡é¢˜}**")
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**N41**")
            if 'n41' in åˆ†ç»„æ•°æ®:
                fig = å®‰å…¨ç”Ÿæˆæ•£ç‚¹å›¾(åˆ†ç»„æ•°æ®['n41'], xè½´, yè½´, é¢œè‰², f"N41 - {æ ‡é¢˜}", "Blues")
                if fig:
                    # è®¡ç®—ç›¸å…³æ€§å¹¶ç”Ÿæˆä¸€å¥è¯æ€»ç»“
                    temp_data = åˆ†ç»„æ•°æ®['n41'][[xè½´, yè½´]].dropna()
                    if len(temp_data) > 10:
                        corr = temp_data[xè½´].corr(temp_data[yè½´])
                        trend = "æ­£ç›¸å…³" if corr > 0 else "è´Ÿç›¸å…³"
                        strength = "å¼º" if abs(corr) > 0.6 else ("ä¸­ç­‰" if abs(corr) > 0.3 else "å¼±")
                        st.info(f"ğŸ“Š N41: {xè½´}ä¸{yè½´}å‘ˆ{strength}{trend}(r={corr:.3f})")
                    st.plotly_chart(fig, use_container_width=True, key=f"n41_{æ ‡é¢˜}_{xè½´}_{yè½´}")
                else:
                    st.info("æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨")
            else:
                st.info("N41æ•°æ®ä¸å¯ç”¨")
        
        with col2:
            st.markdown("**N28**")
            if 'n28' in åˆ†ç»„æ•°æ®:
                é…è‰² = "Viridis" if "SINR" in æ ‡é¢˜ else "Reds"
                fig = å®‰å…¨ç”Ÿæˆæ•£ç‚¹å›¾(åˆ†ç»„æ•°æ®['n28'], xè½´, yè½´, é¢œè‰², f"N28 - {æ ‡é¢˜}", é…è‰²)
                if fig:
                    # è®¡ç®—ç›¸å…³æ€§å¹¶ç”Ÿæˆä¸€å¥è¯æ€»ç»“
                    temp_data = åˆ†ç»„æ•°æ®['n28'][[xè½´, yè½´]].dropna()
                    if len(temp_data) > 10:
                        corr = temp_data[xè½´].corr(temp_data[yè½´])
                        trend = "æ­£ç›¸å…³" if corr > 0 else "è´Ÿç›¸å…³"
                        strength = "å¼º" if abs(corr) > 0.6 else ("ä¸­ç­‰" if abs(corr) > 0.3 else "å¼±")
                        st.info(f"ğŸ“Š N28: {xè½´}ä¸{yè½´}å‘ˆ{strength}{trend}(r={corr:.3f})")
                    st.plotly_chart(fig, use_container_width=True, key=f"n28_{æ ‡é¢˜}_{xè½´}_{yè½´}")
                else:
                    st.info("æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨")
            else:
                st.info("N28æ•°æ®ä¸å¯ç”¨")

    # åˆ†ææ€»ç»“
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ ç›¸å…³æ€§å¯è§†åŒ–åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)

    if 'n41' in ç›¸å…³æ€§çŸ©é˜µ and 'n28' in ç›¸å…³æ€§çŸ©é˜µ:
        æ€»ç»“å†…å®¹ = "<div class='highlight'><b>ğŸ“Š ç›¸å…³æ€§å¯è§†åŒ–åˆ†ææ€»ç»“</b><br><br>"

        # è·å–CQIä¸å…¶ä»–æŒ‡æ ‡çš„ç›¸å…³æ€§
        n41_matrix = ç›¸å…³æ€§çŸ©é˜µ['n41']
        n28_matrix = ç›¸å…³æ€§çŸ©é˜µ['n28']

        if 'CQIä¼˜è‰¯ç‡' in n41_matrix.index and 'CQIä¼˜è‰¯ç‡' in n28_matrix.index:
            cqi_corr_n41 = n41_matrix.loc['CQIä¼˜è‰¯ç‡'].drop('CQIä¼˜è‰¯ç‡')
            cqi_corr_n28 = n28_matrix.loc['CQIä¼˜è‰¯ç‡'].drop('CQIä¼˜è‰¯ç‡')

            æ€»ç»“å†…å®¹ += "<b>1. CQIä¸å„æŒ‡æ ‡ç›¸å…³æ€§æ’åºï¼ˆN41ï¼‰ï¼š</b><br>"
            n41_sorted = cqi_corr_n41.abs().sort_values(ascending=False)
            for i, (idx, val) in enumerate(n41_sorted.head(4).items(), 1):
                æ€»ç»“å†…å®¹ += f"â€¢ ç¬¬{i}ä½: {ç®€çŸ­åˆ—å.get(idx, idx)} (r={cqi_corr_n41[idx]:.3f})<br>"

            æ€»ç»“å†…å®¹ += "<br><b>2. CQIä¸å„æŒ‡æ ‡ç›¸å…³æ€§æ’åºï¼ˆN28ï¼‰ï¼š</b><br>"
            n28_sorted = cqi_corr_n28.abs().sort_values(ascending=False)
            for i, (idx, val) in enumerate(n28_sorted.head(4).items(), 1):
                æ€»ç»“å†…å®¹ += f"â€¢ ç¬¬{i}ä½: {ç®€çŸ­åˆ—å.get(idx, idx)} (r={cqi_corr_n28[idx]:.3f})<br>"

            # æ‰¾å‡ºç›¸å…³æ€§å·®å¼‚æœ€å¤§çš„æŒ‡æ ‡
            diff = (cqi_corr_n41 - cqi_corr_n28).abs()
            if len(diff) > 0:
                max_diff_idx = diff.idxmax()
                æ€»ç»“å†…å®¹ += f"<br><b>3. ç›¸å…³æ€§å·®å¼‚æœ€å¤§çš„æŒ‡æ ‡ï¼š</b><br>"
                æ€»ç»“å†…å®¹ += f"â€¢ {ç®€çŸ­åˆ—å.get(max_diff_idx, max_diff_idx)}: N41(r={cqi_corr_n41[max_diff_idx]:.3f}) vs N28(r={cqi_corr_n28[max_diff_idx]:.3f})<br>"

        æ€»ç»“å†…å®¹ += "<br><b>4. å…³é”®å‘ç°ï¼š</b><br>"
        æ€»ç»“å†…å®¹ += "â€¢ ä»çƒ­åŠ›å›¾å¯ç›´è§‚çœ‹å‡ºå„æŒ‡æ ‡é—´çš„ç›¸å…³æ€§å¼ºåº¦<br>"
        æ€»ç»“å†…å®¹ += "â€¢ æ·±è‰²åŒºåŸŸè¡¨ç¤ºå¼ºæ­£ç›¸å…³ï¼Œæµ…è‰²åŒºåŸŸè¡¨ç¤ºå¼±ç›¸å…³æˆ–è´Ÿç›¸å…³<br>"
        æ€»ç»“å†…å®¹ += "â€¢ å¯¹è§’çº¿å§‹ç»ˆä¸º1ï¼ˆè‡ªèº«ç›¸å…³æ€§ï¼‰"

        æ€»ç»“å†…å®¹ += "</div>"
        st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”æ‹ç‚¹åˆ†æ(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“CQI-é€Ÿç‡æ‹ç‚¹åˆ†æ"""
    st.markdown("""
    <div class="highlight">
    <b>ğŸ“ˆ CQI-é€Ÿç‡æ‹ç‚¹åˆ†æï¼š</b><br>
    å°†CQIä¼˜è‰¯ç‡åˆ’åˆ†ä¸ºå¤šä¸ªåŒºé—´ï¼Œåˆ†ææ¯ä¸ªåŒºé—´çš„å¹³å‡é€Ÿç‡å˜åŒ–ï¼Œæ‰¾å‡ºé€Ÿç‡å¢é•¿çš„<b>æ‹ç‚¹</b>ã€‚<br>
    <b>æ‹ç‚¹å«ä¹‰ï¼š</b>è¶…è¿‡æ­¤CQIå€¼åï¼Œé€Ÿç‡æå‡æ•ˆæœå‘ç”Ÿæ˜¾è‘—å˜åŒ–ï¼ˆå¯èƒ½å¼€å§‹åŠ é€Ÿæˆ–è¶‹äºå¹³ç¨³ï¼‰ã€‚
    </div>
    """, unsafe_allow_html=True)

    åˆ†æ®µæ•° = st.slider("é€‰æ‹©CQIåŒºé—´æ•°é‡", 5, 15, 10, key="inflection_slider")

    with st.spinner('æ­£åœ¨åˆ†ææ‹ç‚¹...'):
        æ‹ç‚¹åˆ†æç»“æœ = åˆ†æå™¨.CQIé€Ÿç‡æ‹ç‚¹åˆ†æ_æŒ‰åˆ¶å¼(åˆ†æ®µæ•°)

    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])

    # N41åˆ†æ
    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - æ‹ç‚¹åˆ†æ</div>', unsafe_allow_html=True)
        if 'n41' in æ‹ç‚¹åˆ†æç»“æœ:
            åŒºé—´ç»Ÿè®¡ = æ‹ç‚¹åˆ†æç»“æœ['n41']['åŒºé—´ç»Ÿè®¡']
            æ‹ç‚¹ = æ‹ç‚¹åˆ†æç»“æœ['n41']['æ‹ç‚¹']
            
            # æ˜¾ç¤ºæ‹ç‚¹ä¿¡æ¯
            if æ‹ç‚¹ is not None:
                st.success(f"ğŸ¯ **æ‹ç‚¹CQIå€¼ï¼š{æ‹ç‚¹['CQIå‡å€¼']:.1f}%**\n\n"
                          f"â€¢ æ‹ç‚¹å‰å¹³å‡é€Ÿç‡ï¼š{åŒºé—´ç»Ÿè®¡.loc[æ‹ç‚¹.name-1, 'å¹³å‡é€Ÿç‡']:.2f} Mbps\n"
                          f"â€¢ æ‹ç‚¹åå¹³å‡é€Ÿç‡ï¼š{æ‹ç‚¹['å¹³å‡é€Ÿç‡']:.2f} Mbps\n"
                          f"â€¢ é€Ÿç‡è·ƒå‡ï¼š{æ‹ç‚¹['é€Ÿç‡å¢é•¿(Mbps)']:.2f} Mbps ({æ‹ç‚¹['é€Ÿç‡å¢é•¿ç‡(%)']:.1f}%)\n"
                          f"â€¢ è¯¥åŒºé—´æ ·æœ¬æ•°ï¼š{æ‹ç‚¹['æ ·æœ¬æ•°']:.0f}")
            
            # æ˜¾ç¤ºåŒºé—´ç»Ÿè®¡è¡¨
            æ˜¾ç¤ºåˆ— = ['CQIå‡å€¼', 'CQIæœ€å°å€¼', 'CQIæœ€å¤§å€¼', 'æ ·æœ¬æ•°', 'å¹³å‡é€Ÿç‡', 'é€Ÿç‡å¢é•¿(Mbps)', 'é€Ÿç‡å¢é•¿ç‡(%)']
            
            # å¦‚æœæœ‰æ‹ç‚¹ï¼Œåœ¨è¡¨æ ¼ä¸­æ ‡è®°
            if æ‹ç‚¹ is not None:
                st.info(f"ğŸ¯ æ‹ç‚¹ä½äºç¬¬ {æ‹ç‚¹.name + 1} è¡Œ (CQIå‡å€¼: {æ‹ç‚¹['CQIå‡å€¼']:.1f}%)")
            
            st.dataframe(
                åŒºé—´ç»Ÿè®¡[æ˜¾ç¤ºåˆ—].style.format({
                    'CQIå‡å€¼': '{:.1f}%',
                    'CQIæœ€å°å€¼': '{:.1f}%',
                    'CQIæœ€å¤§å€¼': '{:.1f}%',
                    'å¹³å‡é€Ÿç‡': '{:.2f}',
                    'é€Ÿç‡å¢é•¿(Mbps)': '{:.2f}',
                    'é€Ÿç‡å¢é•¿ç‡(%)': '{:.1f}%'
                }),
                use_container_width=True
            )
            
            # ç»˜åˆ¶æ‹ç‚¹å›¾
            fig_n41 = go.Figure()
            fig_n41.add_trace(go.Scatter(
                x=åŒºé—´ç»Ÿè®¡['CQIå‡å€¼'],
                y=åŒºé—´ç»Ÿè®¡['å¹³å‡é€Ÿç‡'],
                mode='lines+markers',
                name='å¹³å‡é€Ÿç‡',
                line=dict(color='#1E90FF', width=2),
                marker=dict(size=8)
            ))
            
            # æ ‡è®°æ‹ç‚¹
            if æ‹ç‚¹ is not None:
                fig_n41.add_trace(go.Scatter(
                    x=[æ‹ç‚¹['CQIå‡å€¼']],
                    y=[æ‹ç‚¹['å¹³å‡é€Ÿç‡']],
                    mode='markers',
                    name='æ‹ç‚¹',
                    marker=dict(color='red', size=15, symbol='star')
                ))
            
            fig_n41.update_layout(
                title='N41 - CQIä¸é€Ÿç‡å…³ç³»æ›²çº¿',
                xaxis_title='CQIä¼˜è‰¯ç‡ (%)',
                yaxis_title='å¹³å‡ä¸‹è¡Œé€Ÿç‡ (Mbps)',
                template='plotly_white',
                height=400,
                showlegend=True
            )
            st.plotly_chart(fig_n41, use_container_width=True)
        else:
            st.warning("N41æ•°æ®ä¸æ»¡è¶³æ‹ç‚¹åˆ†ææ¡ä»¶")

    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)

    # N28åˆ†æ
    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - æ‹ç‚¹åˆ†æ</div>', unsafe_allow_html=True)
        if 'n28' in æ‹ç‚¹åˆ†æç»“æœ:
            åŒºé—´ç»Ÿè®¡ = æ‹ç‚¹åˆ†æç»“æœ['n28']['åŒºé—´ç»Ÿè®¡']
            æ‹ç‚¹ = æ‹ç‚¹åˆ†æç»“æœ['n28']['æ‹ç‚¹']
            
            # æ˜¾ç¤ºæ‹ç‚¹ä¿¡æ¯
            if æ‹ç‚¹ is not None:
                st.success(f"ğŸ¯ **æ‹ç‚¹CQIå€¼ï¼š{æ‹ç‚¹['CQIå‡å€¼']:.1f}%**\n\n"
                          f"â€¢ æ‹ç‚¹å‰å¹³å‡é€Ÿç‡ï¼š{åŒºé—´ç»Ÿè®¡.loc[æ‹ç‚¹.name-1, 'å¹³å‡é€Ÿç‡']:.2f} Mbps\n"
                          f"â€¢ æ‹ç‚¹åå¹³å‡é€Ÿç‡ï¼š{æ‹ç‚¹['å¹³å‡é€Ÿç‡']:.2f} Mbps\n"
                          f"â€¢ é€Ÿç‡è·ƒå‡ï¼š{æ‹ç‚¹['é€Ÿç‡å¢é•¿(Mbps)']:.2f} Mbps ({æ‹ç‚¹['é€Ÿç‡å¢é•¿ç‡(%)']:.1f}%)\n"
                          f"â€¢ è¯¥åŒºé—´æ ·æœ¬æ•°ï¼š{æ‹ç‚¹['æ ·æœ¬æ•°']:.0f}")
            
            # æ˜¾ç¤ºåŒºé—´ç»Ÿè®¡è¡¨
            æ˜¾ç¤ºåˆ— = ['CQIå‡å€¼', 'CQIæœ€å°å€¼', 'CQIæœ€å¤§å€¼', 'æ ·æœ¬æ•°', 'å¹³å‡é€Ÿç‡', 'é€Ÿç‡å¢é•¿(Mbps)', 'é€Ÿç‡å¢é•¿ç‡(%)']
            
            # å¦‚æœæœ‰æ‹ç‚¹ï¼Œåœ¨è¡¨æ ¼ä¸­æ ‡è®°
            if æ‹ç‚¹ is not None:
                st.info(f"ğŸ¯ æ‹ç‚¹ä½äºç¬¬ {æ‹ç‚¹.name + 1} è¡Œ (CQIå‡å€¼: {æ‹ç‚¹['CQIå‡å€¼']:.1f}%)")
            
            st.dataframe(
                åŒºé—´ç»Ÿè®¡[æ˜¾ç¤ºåˆ—].style.format({
                    'CQIå‡å€¼': '{:.1f}%',
                    'CQIæœ€å°å€¼': '{:.1f}%',
                    'CQIæœ€å¤§å€¼': '{:.1f}%',
                    'å¹³å‡é€Ÿç‡': '{:.2f}',
                    'é€Ÿç‡å¢é•¿(Mbps)': '{:.2f}',
                    'é€Ÿç‡å¢é•¿ç‡(%)': '{:.1f}%'
                }),
                use_container_width=True
            )
            
            # ç»˜åˆ¶æ‹ç‚¹å›¾
            fig_n28 = go.Figure()
            fig_n28.add_trace(go.Scatter(
                x=åŒºé—´ç»Ÿè®¡['CQIå‡å€¼'],
                y=åŒºé—´ç»Ÿè®¡['å¹³å‡é€Ÿç‡'],
                mode='lines+markers',
                name='å¹³å‡é€Ÿç‡',
                line=dict(color='#FF6B6B', width=2),
                marker=dict(size=8)
            ))
            
            # æ ‡è®°æ‹ç‚¹
            if æ‹ç‚¹ is not None:
                fig_n28.add_trace(go.Scatter(
                    x=[æ‹ç‚¹['CQIå‡å€¼']],
                    y=[æ‹ç‚¹['å¹³å‡é€Ÿç‡']],
                    mode='markers',
                    name='æ‹ç‚¹',
                    marker=dict(color='red', size=15, symbol='star')
                ))
            
            fig_n28.update_layout(
                title='N28 - CQIä¸é€Ÿç‡å…³ç³»æ›²çº¿',
                xaxis_title='CQIä¼˜è‰¯ç‡ (%)',
                yaxis_title='å¹³å‡ä¸‹è¡Œé€Ÿç‡ (Mbps)',
                template='plotly_white',
                height=400,
                showlegend=True
            )
            st.plotly_chart(fig_n28, use_container_width=True)
        else:
            st.warning("N28æ•°æ®ä¸æ»¡è¶³æ‹ç‚¹åˆ†ææ¡ä»¶")

    # å¯¹æ¯”æ€»ç»“
    n41æœ‰æ•°æ® = 'n41' in æ‹ç‚¹åˆ†æç»“æœ
    n28æœ‰æ•°æ® = 'n28' in æ‹ç‚¹åˆ†æç»“æœ
    
    if n41æœ‰æ•°æ® or n28æœ‰æ•°æ®:
        æ€»ç»“å†…å®¹ = "<div class='success-box'><b>ğŸ’¡ æ‹ç‚¹åˆ†æå¯¹æ¯”ç»“è®ºï¼š</b><br>"
        
        if n41æœ‰æ•°æ® and æ‹ç‚¹åˆ†æç»“æœ['n41']['æ‹ç‚¹'] is not None:
            æ‹ç‚¹_n41 = æ‹ç‚¹åˆ†æç»“æœ['n41']['æ‹ç‚¹']
            åŒºé—´ç»Ÿè®¡_n41 = æ‹ç‚¹åˆ†æç»“æœ['n41']['åŒºé—´ç»Ÿè®¡']
            æ€»ç»“å†…å®¹ += f"<b>ğŸ“¡ N41æ‹ç‚¹</b>ï¼šCQIå‡å€¼ä¸º<strong>{æ‹ç‚¹_n41['CQIå‡å€¼']:.1f}%</strong>æ—¶ï¼Œé€Ÿç‡å‘ç”Ÿæ˜¾è‘—å˜åŒ–<br>"
            æ€»ç»“å†…å®¹ += f"&nbsp;&nbsp;â€¢ æ‹ç‚¹å‰é€Ÿç‡ï¼š{åŒºé—´ç»Ÿè®¡_n41.loc[æ‹ç‚¹_n41.name-1, 'å¹³å‡é€Ÿç‡']:.2f} Mbps<br>"
            æ€»ç»“å†…å®¹ += f"&nbsp;&nbsp;â€¢ æ‹ç‚¹åé€Ÿç‡ï¼š{æ‹ç‚¹_n41['å¹³å‡é€Ÿç‡']:.2f} Mbps<br>"
            æ€»ç»“å†…å®¹ += f"&nbsp;&nbsp;â€¢ é€Ÿç‡è·ƒå‡ï¼š{æ‹ç‚¹_n41['é€Ÿç‡å¢é•¿(Mbps)']:.2f} Mbps ({æ‹ç‚¹_n41['é€Ÿç‡å¢é•¿ç‡(%)']:.1f}%)<br><br>"
        elif n41æœ‰æ•°æ®:
            æ€»ç»“å†…å®¹ += "<b>ğŸ“¡ N41</b>ï¼šæœªæ‰¾åˆ°æ˜æ˜¾æ‹ç‚¹<br><br>"
        
        if n28æœ‰æ•°æ® and æ‹ç‚¹åˆ†æç»“æœ['n28']['æ‹ç‚¹'] is not None:
            æ‹ç‚¹_n28 = æ‹ç‚¹åˆ†æç»“æœ['n28']['æ‹ç‚¹']
            åŒºé—´ç»Ÿè®¡_n28 = æ‹ç‚¹åˆ†æç»“æœ['n28']['åŒºé—´ç»Ÿè®¡']
            æ€»ç»“å†…å®¹ += f"<b>ğŸ“¡ N28æ‹ç‚¹</b>ï¼šCQIå‡å€¼ä¸º<strong>{æ‹ç‚¹_n28['CQIå‡å€¼']:.1f}%</strong>æ—¶ï¼Œé€Ÿç‡å‘ç”Ÿæ˜¾è‘—å˜åŒ–<br>"
            æ€»ç»“å†…å®¹ += f"&nbsp;&nbsp;â€¢ æ‹ç‚¹å‰é€Ÿç‡ï¼š{åŒºé—´ç»Ÿè®¡_n28.loc[æ‹ç‚¹_n28.name-1, 'å¹³å‡é€Ÿç‡']:.2f} Mbps<br>"
            æ€»ç»“å†…å®¹ += f"&nbsp;&nbsp;â€¢ æ‹ç‚¹åé€Ÿç‡ï¼š{æ‹ç‚¹_n28['å¹³å‡é€Ÿç‡']:.2f} Mbps<br>"
            æ€»ç»“å†…å®¹ += f"&nbsp;&nbsp;â€¢ é€Ÿç‡è·ƒå‡ï¼š{æ‹ç‚¹_n28['é€Ÿç‡å¢é•¿(Mbps)']:.2f} Mbps ({æ‹ç‚¹_n28['é€Ÿç‡å¢é•¿ç‡(%)']:.1f}%)<br><br>"
        elif n28æœ‰æ•°æ®:
            æ€»ç»“å†…å®¹ += "<b>ğŸ“¡ N28</b>ï¼šæœªæ‰¾åˆ°æ˜æ˜¾æ‹ç‚¹<br><br>"
        
        if n41æœ‰æ•°æ® and n28æœ‰æ•°æ® and æ‹ç‚¹åˆ†æç»“æœ['n41']['æ‹ç‚¹'] is not None and æ‹ç‚¹åˆ†æç»“æœ['n28']['æ‹ç‚¹'] is not None:
            æ‹ç‚¹_n41 = æ‹ç‚¹åˆ†æç»“æœ['n41']['æ‹ç‚¹']
            æ‹ç‚¹_n28 = æ‹ç‚¹åˆ†æç»“æœ['n28']['æ‹ç‚¹']
            å¯¹æ¯”ç»“è®º = "N41" if æ‹ç‚¹_n41['é€Ÿç‡å¢é•¿ç‡(%)'] > æ‹ç‚¹_n28['é€Ÿç‡å¢é•¿ç‡(%)'] else "N28"
            æ€»ç»“å†…å®¹ += f"<b>ğŸ“Š å¯¹æ¯”åˆ†æ</b>ï¼š{å¯¹æ¯”ç»“è®º}çš„é€Ÿç‡æ‹ç‚¹å˜åŒ–æ›´æ˜¾è‘—ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨è¯¥åˆ¶å¼çš„CQIä¼˜åŒ–"
        elif n41æœ‰æ•°æ® and n28æœ‰æ•°æ®:
            æ€»ç»“å†…å®¹ += "<b>ğŸ“Š å¯¹æ¯”åˆ†æ</b>ï¼šä¸¤ç»„æ•°æ®å‡å·²åˆ†æ"
        
        æ€»ç»“å†…å®¹ += "</div>"
        st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)
    else:
        st.warning("âš ï¸ å½“å‰æ•°æ®ä¸æ»¡è¶³æ‹ç‚¹åˆ†ææ¡ä»¶ã€‚å¯èƒ½åŸå› ï¼šæ•°æ®æ ·æœ¬åˆ†å¸ƒè¿‡äºé›†ä¸­ï¼Œå»ºè®®æ£€æŸ¥CQIä¼˜è‰¯ç‡æ•°æ®åˆ†å¸ƒæˆ–å¢åŠ æ ·æœ¬é‡ã€‚")


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”è´¡çŒ®åº¦åˆ†æ(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“è´¡çŒ®åº¦åˆ†æçš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”"""
    st.markdown("""
    <div class="highlight">
    <b>ğŸ’¡ è´¡çŒ®åº¦åˆ†æè¯´æ˜ï¼š</b><br>
    åŸºäºå„æŒ‡æ ‡ä¸CQIçš„ç›¸å…³æ€§ï¼Œé‡åŒ–æ¯ä¸ªæŒ‡æ ‡å¯¹CQIçš„è´¡çŒ®åº¦ï¼Œä»è€Œæ˜ç¡®ä¼˜åŒ–ä¼˜å…ˆçº§ï¼ŒæŒ‡å¯¼ä¼˜åŒ–èµ„æºåˆ†é…ã€‚
    </div>
    """, unsafe_allow_html=True)

    with st.spinner('æ­£åœ¨åˆ†æ...'):
        è´¡çŒ®åº¦ç»“æœ = åˆ†æå™¨.è´¡çŒ®åº¦åˆ†æ_æŒ‰åˆ¶å¼()

    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])

    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - è´¡çŒ®åº¦åˆ†æ</div>', unsafe_allow_html=True)
        if 'n41' in è´¡çŒ®åº¦ç»“æœ:
            è´¡çŒ®åº¦df_n41 = pd.DataFrame(è´¡çŒ®åº¦ç»“æœ['n41']['è´¡çŒ®åº¦åˆ—è¡¨'])
            
            # è‡ªå®šä¹‰æ ¼å¼åŒ–å‡½æ•°å¤„ç†Noneå€¼
            def æ ¼å¼åŒ–ç›¸å…³ç³»æ•°(val):
                return '-' if val is None else f"{val:.4f}"
            
            st.dataframe(
                è´¡çŒ®åº¦df_n41.style.format({
                    'ç›¸å…³ç³»æ•°': æ ¼å¼åŒ–ç›¸å…³ç³»æ•°,
                    'è´¡çŒ®åº¦(%)': '{:.2f}',
                    'ç´¯ç§¯è´¡çŒ®åº¦(%)': '{:.2f}%'
                }).background_gradient(subset=['è´¡çŒ®åº¦(%)'], cmap='Blues'),
                use_container_width=True
            )

            # é¥¼å›¾åªä½¿ç”¨æœ‰è´¡çŒ®åº¦çš„æ•°æ®
            if len(è´¡çŒ®åº¦df_n41) > 0:
                fig_pie_n41 = go.Figure(data=[go.Pie(
                    labels=è´¡çŒ®åº¦df_n41['æŒ‡æ ‡'],
                    values=è´¡çŒ®åº¦df_n41['è´¡çŒ®åº¦(%)'],
                    hole=0.3,
                    textinfo='label+percent',
                    marker=dict(colors=px.colors.sequential.Blues[:len(è´¡çŒ®åº¦df_n41)])
                )])
                fig_pie_n41.update_layout(title='N41 - è´¡çŒ®åº¦åˆ†å¸ƒ', template='plotly_white', height=400)
                st.plotly_chart(fig_pie_n41, use_container_width=True)
            else:
                st.warning("N41æ— æœ‰æ•ˆçš„è´¡çŒ®åº¦æ•°æ®")

    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)

    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - è´¡çŒ®åº¦åˆ†æ</div>', unsafe_allow_html=True)
        if 'n28' in è´¡çŒ®åº¦ç»“æœ:
            è´¡çŒ®åº¦df_n28 = pd.DataFrame(è´¡çŒ®åº¦ç»“æœ['n28']['è´¡çŒ®åº¦åˆ—è¡¨'])
            
            # è‡ªå®šä¹‰æ ¼å¼åŒ–å‡½æ•°å¤„ç†Noneå€¼
            def æ ¼å¼åŒ–ç›¸å…³ç³»æ•°(val):
                return '-' if val is None else f"{val:.4f}"
            
            st.dataframe(
                è´¡çŒ®åº¦df_n28.style.format({
                    'ç›¸å…³ç³»æ•°': æ ¼å¼åŒ–ç›¸å…³ç³»æ•°,
                    'è´¡çŒ®åº¦(%)': '{:.2f}',
                    'ç´¯ç§¯è´¡çŒ®åº¦(%)': '{:.2f}%'
                }).background_gradient(subset=['è´¡çŒ®åº¦(%)'], cmap='Reds'),
                use_container_width=True
            )

            # é¥¼å›¾åªä½¿ç”¨æœ‰è´¡çŒ®åº¦çš„æ•°æ®
            if len(è´¡çŒ®åº¦df_n28) > 0:
                fig_pie_n28 = go.Figure(data=[go.Pie(
                    labels=è´¡çŒ®åº¦df_n28['æŒ‡æ ‡'],
                    values=è´¡çŒ®åº¦df_n28['è´¡çŒ®åº¦(%)'],
                    hole=0.3,
                    textinfo='label+percent',
                    marker=dict(colors=px.colors.sequential.Reds[:len(è´¡çŒ®åº¦df_n28)])
                )])
                fig_pie_n28.update_layout(title='N28 - è´¡çŒ®åº¦åˆ†å¸ƒ', template='plotly_white', height=400)
                st.plotly_chart(fig_pie_n28, use_container_width=True)
            else:
                st.warning("N28æ— æœ‰æ•ˆçš„è´¡çŒ®åº¦æ•°æ®")

    # åˆ†ææ€»ç»“
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)

    if 'n41' in è´¡çŒ®åº¦ç»“æœ and 'n28' in è´¡çŒ®åº¦ç»“æœ:
        è´¡çŒ®åº¦df_n41 = pd.DataFrame(è´¡çŒ®åº¦ç»“æœ['n41']['è´¡çŒ®åº¦åˆ—è¡¨'])
        è´¡çŒ®åº¦df_n28 = pd.DataFrame(è´¡çŒ®åº¦ç»“æœ['n28']['è´¡çŒ®åº¦åˆ—è¡¨'])
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
        n41æœ‰æ•°æ® = len(è´¡çŒ®åº¦df_n41) > 0
        n28æœ‰æ•°æ® = len(è´¡çŒ®åº¦df_n28) > 0
        
        æ€»ç»“å†…å®¹ = "<div class='highlight'><b>ğŸ“Š è´¡çŒ®åº¦åˆ†ææ€»ç»“</b><br><br>"

        if n41æœ‰æ•°æ®:
            æ€»ç»“å†…å®¹ += "<b>1. N41ç½‘ç»œåˆ¶å¼è´¡çŒ®åº¦æ’åï¼š</b><br>"
            for i, row in è´¡çŒ®åº¦df_n41.head(5).iterrows():
                æ€»ç»“å†…å®¹ += f"â€¢ {row['æŒ‡æ ‡']}: {row['è´¡çŒ®åº¦(%)']:.2f}% (ç´¯ç§¯: {row['ç´¯ç§¯è´¡çŒ®åº¦(%)']:.2f}%)<br>"
        else:
            æ€»ç»“å†…å®¹ += "<b>1. N41ç½‘ç»œåˆ¶å¼ï¼š</b><br>â€¢ æ— æœ‰æ•ˆçš„è´¡çŒ®åº¦æ•°æ®<br>"

        if n28æœ‰æ•°æ®:
            æ€»ç»“å†…å®¹ += "<br><b>2. N28ç½‘ç»œåˆ¶å¼è´¡çŒ®åº¦æ’åï¼š</b><br>"
            for i, row in è´¡çŒ®åº¦df_n28.head(5).iterrows():
                æ€»ç»“å†…å®¹ += f"â€¢ {row['æŒ‡æ ‡']}: {row['è´¡çŒ®åº¦(%)']:.2f}% (ç´¯ç§¯: {row['ç´¯ç§¯è´¡çŒ®åº¦(%)']:.2f}%)<br>"
        else:
            æ€»ç»“å†…å®¹ += "<br><b>2. N28ç½‘ç»œåˆ¶å¼ï¼š</b><br>â€¢ æ— æœ‰æ•ˆçš„è´¡çŒ®åº¦æ•°æ®<br>"

        # æ‰¾å‡ºä¸»è¦è´¡çŒ®å› ç´ 
        if n41æœ‰æ•°æ® and n28æœ‰æ•°æ®:
            n41_top1 = è´¡çŒ®åº¦df_n41.iloc[0]['æŒ‡æ ‡']
            n28_top1 = è´¡çŒ®åº¦df_n28.iloc[0]['æŒ‡æ ‡']

            æ€»ç»“å†…å®¹ += "<br><b>3. ä¸»è¦è´¡çŒ®å› ç´ ï¼š</b><br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N41: {n41_top1}è´¡çŒ®æœ€å¤§ï¼Œå æ¯”{è´¡çŒ®åº¦df_n41.iloc[0]['è´¡çŒ®åº¦(%)']:.2f}%<br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N28: {n28_top1}è´¡çŒ®æœ€å¤§ï¼Œå æ¯”{è´¡çŒ®åº¦df_n28.iloc[0]['è´¡çŒ®åº¦(%)']:.2f}%<br>"

            æ€»ç»“å†…å®¹ += "<br><b>4. ä¼˜åŒ–å»ºè®®ï¼š</b><br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N41åº”ä¼˜å…ˆä¼˜åŒ–{n41_top1}æŒ‡æ ‡<br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N28åº”ä¼˜å…ˆä¼˜åŒ–{n28_top1}æŒ‡æ ‡<br>"
            æ€»ç»“å†…å®¹ += "â€¢ é›†ä¸­èµ„æºä¼˜åŒ–è´¡çŒ®åº¦æœ€é«˜çš„æŒ‡æ ‡å¯è·å¾—æœ€å¤§æ€§èƒ½æå‡<br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N41å‰3ä¸ªæŒ‡æ ‡ç´¯ç§¯è´¡çŒ®åº¦: {è´¡çŒ®åº¦df_n41.head(3)['è´¡çŒ®åº¦(%)'].sum():.2f}%<br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N28å‰3ä¸ªæŒ‡æ ‡ç´¯ç§¯è´¡çŒ®åº¦: {è´¡çŒ®åº¦df_n28.head(3)['è´¡çŒ®åº¦(%)'].sum():.2f}%"
        
        æ€»ç»“å†…å®¹ += "</div>"
        st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”åˆ†ç»„åˆ†æ(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“åˆ†ç»„åˆ†æçš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”"""
    åˆ†ç»„æ•° = st.slider("é€‰æ‹©åˆ†ç»„æ•°", 3, 10, 5, key="group_slider")

    with st.spinner('æ­£åœ¨åˆ†æ...'):
        åˆ†ç»„åˆ†æ = åˆ†æå™¨.æŒ‰CQIåˆ†ç»„åˆ†æ_æŒ‰åˆ¶å¼(åˆ†ç»„æ•°)

    # ========== åˆ†ç»„å¯¹æ¯”å›¾ï¼ˆå›¾è¡¨éƒ¨åˆ†ï¼‰==========
    st.markdown('<p class="sub-header">ğŸ“ˆ åˆ†ç»„å¯¹æ¯”å›¾</p>', unsafe_allow_html=True)

    # 1. ä¸‹è¡Œé€Ÿç‡å¯¹æ¯”
    st.markdown("**ğŸ“Š ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡åˆ†ç»„å¯¹æ¯”**")
    col_chart1, col_chart2 = st.columns(2)

    with col_chart1:
        if 'n41' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n41'].index.tolist()
            ä¸‹è¡Œå‡å€¼ = åˆ†ç»„åˆ†æ['n41']['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']['mean'].values

            fig_n41 = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=ä¸‹è¡Œå‡å€¼,
                marker_color='#1E90FF',
                text=np.round(ä¸‹è¡Œå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n41.update_layout(
                title='N41 - ä¸‹è¡Œé€Ÿç‡åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='ä¸‹è¡Œé€Ÿç‡ (Mbps)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n41, use_container_width=True)

    with col_chart2:
        if 'n28' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n28'].index.tolist()
            ä¸‹è¡Œå‡å€¼ = åˆ†ç»„åˆ†æ['n28']['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']['mean'].values

            fig_n28 = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=ä¸‹è¡Œå‡å€¼,
                marker_color='#FF6B6B',
                text=np.round(ä¸‹è¡Œå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n28.update_layout(
                title='N28 - ä¸‹è¡Œé€Ÿç‡åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='ä¸‹è¡Œé€Ÿç‡ (Mbps)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n28, use_container_width=True)

    # 2. ä¸Šè¡Œé€Ÿç‡å¯¹æ¯”
    st.markdown("**ğŸ“Š ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡åˆ†ç»„å¯¹æ¯”**")
    col_chart3, col_chart4 = st.columns(2)

    with col_chart3:
        if 'n41' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n41'].index.tolist()
            ä¸Šè¡Œå‡å€¼ = åˆ†ç»„åˆ†æ['n41']['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']['mean'].values

            fig_n41_up = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=ä¸Šè¡Œå‡å€¼,
                marker_color='#4169E1',
                text=np.round(ä¸Šè¡Œå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n41_up.update_layout(
                title='N41 - ä¸Šè¡Œé€Ÿç‡åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='ä¸Šè¡Œé€Ÿç‡ (Mbps)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n41_up, use_container_width=True)

    with col_chart4:
        if 'n28' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n28'].index.tolist()
            ä¸Šè¡Œå‡å€¼ = åˆ†ç»„åˆ†æ['n28']['ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']['mean'].values

            fig_n28_up = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=ä¸Šè¡Œå‡å€¼,
                marker_color='#FF8E53',
                text=np.round(ä¸Šè¡Œå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n28_up.update_layout(
                title='N28 - ä¸Šè¡Œé€Ÿç‡åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='ä¸Šè¡Œé€Ÿç‡ (Mbps)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n28_up, use_container_width=True)

    # 3. SINRå¯¹æ¯”
    st.markdown("**ğŸ“¡ å°åŒºMRè¦†ç›–å¹³å‡SINRåˆ†ç»„å¯¹æ¯”**")
    col_chart5, col_chart6 = st.columns(2)

    with col_chart5:
        if 'n41' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n41'].index.tolist()
            sinrå‡å€¼ = åˆ†ç»„åˆ†æ['n41']['å°åŒºMRè¦†ç›–å¹³å‡SINR']['mean'].values

            fig_n41_sinr = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=sinrå‡å€¼,
                marker_color='#00CED1',
                text=np.round(sinrå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n41_sinr.update_layout(
                title='N41 - SINRåˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='SINR (dB)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n41_sinr, use_container_width=True)

    with col_chart6:
        if 'n28' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n28'].index.tolist()
            sinrå‡å€¼ = åˆ†ç»„åˆ†æ['n28']['å°åŒºMRè¦†ç›–å¹³å‡SINR']['mean'].values

            fig_n28_sinr = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=sinrå‡å€¼,
                marker_color='#FF6347',
                text=np.round(sinrå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n28_sinr.update_layout(
                title='N28 - SINRåˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='SINR (dB)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n28_sinr, use_container_width=True)

    # 4. è¦†ç›–ç”µå¹³å¯¹æ¯”
    st.markdown("**ğŸ“¶ å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³åˆ†ç»„å¯¹æ¯”**")
    col_chart7, col_chart8 = st.columns(2)

    with col_chart7:
        if 'n41' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n41'].index.tolist()
            ç”µå¹³å‡å€¼ = åˆ†ç»„åˆ†æ['n41']['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³']['mean'].values

            fig_n41_rsrp = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=ç”µå¹³å‡å€¼,
                marker_color='#9370DB',
                text=np.round(ç”µå¹³å‡å€¼, 2),
                textposition='outside'
            )])
            fig_n41_rsrp.update_layout(
                title='N41 - è¦†ç›–ç”µå¹³åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='è¦†ç›–ç”µå¹³ (dBm)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n41_rsrp, use_container_width=True)

    with col_chart8:
        if 'n28' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n28'].index.tolist()
            ç”µå¹³å‡å€¼ = åˆ†ç»„åˆ†æ['n28']['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³']['mean'].values

            fig_n28_rsrp = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=ç”µå¹³å‡å€¼,
                marker_color='#DC143C',
                text=np.round(ç”µå¹³å‡å€¼, 2),
                textposition='outside'
            )])
            fig_n28_rsrp.update_layout(
                title='N28 - è¦†ç›–ç”µå¹³åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='è¦†ç›–ç”µå¹³ (dBm)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n28_rsrp, use_container_width=True)

    # 5. TAå¯¹æ¯”
    st.markdown("**ğŸ“ å°åŒºMRè¦†ç›–å¹³å‡TAåˆ†ç»„å¯¹æ¯”**")
    col_chart9, col_chart10 = st.columns(2)

    with col_chart9:
        if 'n41' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n41'].index.tolist()
            taå‡å€¼ = åˆ†ç»„åˆ†æ['n41']['å°åŒºMRè¦†ç›–å¹³å‡TA']['mean'].values

            fig_n41_ta = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=taå‡å€¼,
                marker_color='#20B2AA',
                text=np.round(taå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n41_ta.update_layout(
                title='N41 - TAåˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='TA',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n41_ta, use_container_width=True)

    with col_chart10:
        if 'n28' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n28'].index.tolist()
            taå‡å€¼ = åˆ†ç»„åˆ†æ['n28']['å°åŒºMRè¦†ç›–å¹³å‡TA']['mean'].values

            fig_n28_ta = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=taå‡å€¼,
                marker_color='#FF4500',
                text=np.round(taå‡å€¼, 2),
                textposition='outside'
            )])
            fig_n28_ta.update_layout(
                title='N28 - TAåˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='TA',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n28_ta, use_container_width=True)

    # 6. å¹²æ‰°ç”µå¹³å¯¹æ¯”
    st.markdown("**âš¡ å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³åˆ†ç»„å¯¹æ¯”**")
    col_chart11, col_chart12 = st.columns(2)

    with col_chart11:
        if 'n41' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n41'].index.tolist()
            å¹²æ‰°å‡å€¼ = åˆ†ç»„åˆ†æ['n41']['å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³']['mean'].values

            fig_n41_interf = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=å¹²æ‰°å‡å€¼,
                marker_color='#FF69B4',
                text=np.round(å¹²æ‰°å‡å€¼, 2),
                textposition='outside'
            )])
            fig_n41_interf.update_layout(
                title='N41 - å¹²æ‰°ç”µå¹³åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='å¹²æ‰°ç”µå¹³ (dBm)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n41_interf, use_container_width=True)

    with col_chart12:
        if 'n28' in åˆ†ç»„åˆ†æ:
            åˆ†ç»„æ ‡ç­¾ = åˆ†ç»„åˆ†æ['n28'].index.tolist()
            å¹²æ‰°å‡å€¼ = åˆ†ç»„åˆ†æ['n28']['å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³']['mean'].values

            fig_n28_interf = go.Figure(data=[go.Bar(
                x=åˆ†ç»„æ ‡ç­¾,
                y=å¹²æ‰°å‡å€¼,
                marker_color='#B22222',
                text=np.round(å¹²æ‰°å‡å€¼, 2),
                textposition='outside'
            )])
            fig_n28_interf.update_layout(
                title='N28 - å¹²æ‰°ç”µå¹³åˆ†ç»„å¯¹æ¯”',
                xaxis_title='CQIåˆ†ç»„',
                yaxis_title='å¹²æ‰°ç”µå¹³ (dBm)',
                template='plotly_white',
                height=380,
                margin=dict(t=50)
            )
            st.plotly_chart(fig_n28_interf, use_container_width=True)

    # ========== åˆ†ç»„å¯¹æ¯”è¡¨æ ¼ï¼ˆè¡¨æ ¼éƒ¨åˆ†ï¼‰==========
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“Š åˆ†ç»„å¯¹æ¯”è¡¨æ ¼</p>', unsafe_allow_html=True)
    st.info("ğŸ’¡ **è¯´æ˜**ï¼šå±•ç¤ºå„CQIåˆ†ç»„ä¸‹å„é¡¹æŒ‡æ ‡çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå‡å€¼ã€æ ‡å‡†å·®ã€æ ·æœ¬æ•°ï¼‰")

    col_n41_table, col_divider_table, col_n28_table = st.columns([10, 1, 10])

    with col_n41_table:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - åˆ†ç»„ç»Ÿè®¡</div>', unsafe_allow_html=True)
        if 'n41' in åˆ†ç»„åˆ†æ:
            for åˆ— in åˆ†ç»„åˆ†æ['n41'].columns.get_level_values(0).unique():
                with st.expander(f"**{åˆ—}**", expanded=True):
                    æ˜¾ç¤ºåˆ— = åˆ†ç»„åˆ†æ['n41'][åˆ—].reset_index()
                    æ˜¾ç¤ºåˆ—.columns = ['CQIåˆ†ç»„', 'å‡å€¼', 'æ ‡å‡†å·®', 'æ ·æœ¬æ•°']
                    st.dataframe(æ˜¾ç¤ºåˆ—.style.format({'å‡å€¼': '{:.2f}', 'æ ‡å‡†å·®': '{:.2f}', 'æ ·æœ¬æ•°': '{:.0f}'}), use_container_width=True)

    with col_divider_table:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)

    with col_n28_table:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - åˆ†ç»„ç»Ÿè®¡</div>', unsafe_allow_html=True)
        if 'n28' in åˆ†ç»„åˆ†æ:
            for åˆ— in åˆ†ç»„åˆ†æ['n28'].columns.get_level_values(0).unique():
                with st.expander(f"**{åˆ—}**", expanded=True):
                    æ˜¾ç¤ºåˆ— = åˆ†ç»„åˆ†æ['n28'][åˆ—].reset_index()
                    æ˜¾ç¤ºåˆ—.columns = ['CQIåˆ†ç»„', 'å‡å€¼', 'æ ‡å‡†å·®', 'æ ·æœ¬æ•°']
                    st.dataframe(æ˜¾ç¤ºåˆ—.style.format({'å‡å€¼': '{:.2f}', 'æ ‡å‡†å·®': '{:.2f}', 'æ ·æœ¬æ•°': '{:.0f}'}), use_container_width=True)

    # åˆ†ææ€»ç»“
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)

    if 'n41' in åˆ†ç»„åˆ†æ and 'n28' in åˆ†ç»„åˆ†æ:
        æ€»ç»“å†…å®¹ = "<div class='highlight'><b>ğŸ“Š åˆ†ç»„åˆ†ææ€»ç»“</b><br><br>"

        # è·å–å„åˆ†ç»„çš„CQIæ•°æ®
        n41_cqi_groups = åˆ†ç»„åˆ†æ['n41'].index.tolist()
        n28_cqi_groups = åˆ†ç»„åˆ†æ['n28'].index.tolist()

        # æ‰¾å‡ºCQIæœ€ä¼˜åˆ†ç»„
        n41_best_group = n41_cqi_groups[-1] if n41_cqi_groups else "æ— "
        n28_best_group = n28_cqi_groups[-1] if n28_cqi_groups else "æ— "

        æ€»ç»“å†…å®¹ += "<b>1. CQIåˆ†ç»„æ¦‚å†µï¼š</b><br>"
        æ€»ç»“å†…å®¹ += f"â€¢ N41å…±æœ‰{len(n41_cqi_groups)}ä¸ªåˆ†ç»„: {', '.join(n41_cqi_groups)}<br>"
        æ€»ç»“å†…å®¹ += f"â€¢ N28å…±æœ‰{len(n28_cqi_groups)}ä¸ªåˆ†ç»„: {', '.join(n28_cqi_groups)}<br>"

        # ä¸‹è¡Œé€Ÿç‡åˆ†æ
        if 'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)' in åˆ†ç»„åˆ†æ['n41'].columns.get_level_values(0):
            n41ä¸‹è¡Œ = åˆ†ç»„åˆ†æ['n41']['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']['mean'].values
            n28ä¸‹è¡Œ = åˆ†ç»„åˆ†æ['n28']['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)']['mean'].values

            n41_max_rate = max(n41ä¸‹è¡Œ)
            n28_max_rate = max(n28ä¸‹è¡Œ)
            n41_min_rate = min(n41ä¸‹è¡Œ)
            n28_min_rate = min(n28ä¸‹è¡Œ)

            æ€»ç»“å†…å®¹ += "<br><b>2. ä¸‹è¡Œé€Ÿç‡åˆ†æï¼š</b><br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N41é€Ÿç‡èŒƒå›´: {n41_min_rate:.2f} ~ {n41_max_rate:.2f} Mbps (è·¨åº¦: {n41_max_rate - n41_min_rate:.2f} Mbps)<br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N28é€Ÿç‡èŒƒå›´: {n28_min_rate:.2f} ~ {n28_max_rate:.2f} Mbps (è·¨åº¦: {n28_max_rate - n28_min_rate:.2f} Mbps)<br>"

        # è¦†ç›–ç”µå¹³åˆ†æ
        if 'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³' in åˆ†ç»„åˆ†æ['n41'].columns.get_level_values(0):
            n41_rsrp = åˆ†ç»„åˆ†æ['n41']['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³']['mean'].values
            n28_rsrp = åˆ†ç»„åˆ†æ['n28']['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³']['mean'].values

            æ€»ç»“å†…å®¹ += "<br><b>3. è¦†ç›–ç”µå¹³åˆ†æï¼š</b><br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N41è¦†ç›–ç”µå¹³éšCQIåˆ†ç»„é€’å¢è€Œ{'æ”¹å–„' if n41_rsrp[-1] > n41_rsrp[0] else 'ä¸‹é™'}<br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N28è¦†ç›–ç”µå¹³éšCQIåˆ†ç»„é€’å¢è€Œ{'æ”¹å–„' if n28_rsrp[-1] > n28_rsrp[0] else 'ä¸‹é™'}<br>"

        # SINRåˆ†æ
        if 'å°åŒºMRè¦†ç›–å¹³å‡SINR' in åˆ†ç»„åˆ†æ['n41'].columns.get_level_values(0):
            n41_sinr = åˆ†ç»„åˆ†æ['n41']['å°åŒºMRè¦†ç›–å¹³å‡SINR']['mean'].values
            n28_sinr = åˆ†ç»„åˆ†æ['n28']['å°åŒºMRè¦†ç›–å¹³å‡SINR']['mean'].values

            æ€»ç»“å†…å®¹ += "<br><b>4. SINRåˆ†æï¼š</b><br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N41æœ€ä¼˜CQIåˆ†ç»„SINRå‡å€¼: {n41_sinr[-1]:.2f} dB<br>"
            æ€»ç»“å†…å®¹ += f"â€¢ N28æœ€ä¼˜CQIåˆ†ç»„SINRå‡å€¼: {n28_sinr[-1]:.2f} dB<br>"

        æ€»ç»“å†…å®¹ += "<br><b>5. å…³é”®å‘ç°ï¼š</b><br>"
        æ€»ç»“å†…å®¹ += "â€¢ CQIä¼˜è‰¯ç‡ä¸å„é¡¹æ€§èƒ½æŒ‡æ ‡å‘ˆç°æ˜æ˜¾çš„æ­£ç›¸å…³è¶‹åŠ¿<br>"
        æ€»ç»“å†…å®¹ += "â€¢ éšç€CQIåˆ†ç»„ç­‰çº§æé«˜ï¼Œä¸‹è¡Œé€Ÿç‡å’ŒSINRé€šå¸¸ä¼šæå‡<br>"
        æ€»ç»“å†…å®¹ += "â€¢ é«˜CQIåˆ†ç»„å°åŒºçš„å„é¡¹æŒ‡æ ‡æ™®éä¼˜äºä½CQIåˆ†ç»„å°åŒº<br>"

        æ€»ç»“å†…å®¹ += "<br><b>6. ä¼˜åŒ–å»ºè®®ï¼š</b><br>"
        æ€»ç»“å†…å®¹ += "â€¢ å…³æ³¨ä½CQIåˆ†ç»„å°åŒºçš„æ€§èƒ½ç“¶é¢ˆ<br>"
        æ€»ç»“å†…å®¹ += "â€¢ æå‡CQIä¼˜è‰¯ç‡å¯æœ‰æ•ˆæ”¹å–„ç”¨æˆ·ä½“éªŒ<br>"
        æ€»ç»“å†…å®¹ += "â€¢ é’ˆå¯¹ä¸åŒCQIç­‰çº§åˆ¶å®šå·®å¼‚åŒ–çš„ä¼˜åŒ–ç­–ç•¥"

        æ€»ç»“å†…å®¹ += "</div>"
        st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”å¤šç»´åº¦äº¤å‰åˆ†æ(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“å¤šç»´åº¦äº¤å‰åˆ†æçš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”"""
    st.markdown("""
    <div class="highlight">
    <b>ğŸ”„ å¤šç»´åº¦äº¤å‰åˆ†æè¯´æ˜ï¼š</b><br>
    é€šè¿‡è¦†ç›–ã€SINRã€TAã€CQIã€é€Ÿç‡ç­‰å¤šä¸ªç»´åº¦çš„äº¤å‰åˆ†æï¼Œæ·±å…¥æŒ–æ˜ç½‘ç»œæ€§èƒ½ç“¶é¢ˆå’Œä¼˜åŒ–æ–¹å‘ã€‚
    </div>
    """, unsafe_allow_html=True)
    
    # ä½¿ç”¨å­æ ‡ç­¾é¡µç»„ç»‡3ä¸ªåˆ†ææ¨¡å—ï¼ˆTAåˆ†å±‚å’Œæ¡ä»¶åˆ†ç»„å·²åˆå¹¶åˆ°è·ç¦»è¦†ç›–åˆ†æï¼‰
    å­æ ‡ç­¾ = st.tabs([
        "ğŸ“Š 1.ä¸‰ç»´æ•£ç‚¹å›¾åˆ†æ",
        "ğŸ¯ 2.å››è±¡é™åˆ†æ",
        "ğŸ” 3.CQIä¸è¾¾æ ‡æ ¹å› åˆ†æ"
    ])
    
    # ========== 1. ä¸‰ç»´æ•£ç‚¹å›¾åˆ†æ ==========
    with å­æ ‡ç­¾[0]:
        st.markdown('<p class="sub-header">ğŸ“Š ä¸‰ç»´æ•£ç‚¹å›¾åˆ†æ - è¦†ç›–Ã—SINRÃ—CQI/é€Ÿç‡</p>', unsafe_allow_html=True)
        
        ä¸‰ç»´æ•°æ® = åˆ†æå™¨.ä¸‰ç»´æ•£ç‚¹å›¾åˆ†æ_æŒ‰åˆ¶å¼()
        
        col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
        
        with col_n41:
            st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - ä¸‰ç»´å…³ç³»</div>', unsafe_allow_html=True)
            if 'n41' in ä¸‰ç»´æ•°æ® and len(ä¸‰ç»´æ•°æ®['n41']) > 0:
                æ•°æ® = ä¸‰ç»´æ•°æ®['n41'].sample(min(2000, len(ä¸‰ç»´æ•°æ®['n41']))).copy()

                # ç¡®ä¿sizeåˆ—ä¸ºæ­£æ•°ï¼ˆplotlyè¦æ±‚sizeå¿…é¡»>0ï¼‰
                æ•°æ®['é€Ÿç‡å¤§å°'] = æ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].clip(lower=0.1)

                # è¦†ç›–Ã—SINRÃ—CQI
                fig1 = px.scatter(
                    æ•°æ®, x='å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³', y='å°åŒºMRè¦†ç›–å¹³å‡SINR',
                    color='CQIä¼˜è‰¯ç‡', size='é€Ÿç‡å¤§å°',
                    color_continuous_scale='Blues',
                    title="N41: è¦†ç›–Ã—SINRÃ—CQI(é¢œè‰²)Ã—é€Ÿç‡(å¤§å°)",
                    height=450
                )
                fig1.update_layout(template="plotly_white")
                st.plotly_chart(fig1, use_container_width=True)
                
                # åˆ†ææ€»ç»“
                corr_è¦†ç›–_sinr = æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'].corr(æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'])
                corr_è¦†ç›–_cqi = æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'].corr(æ•°æ®['CQIä¼˜è‰¯ç‡'])
                corr_sinr_cqi = æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'].corr(æ•°æ®['CQIä¼˜è‰¯ç‡'])
                
                st.markdown(f"""
                <div class="success-box">
                <b>ğŸ“Š N41ä¸‰ç»´å…³ç³»åˆ†æï¼š</b><br>
                â€¢ è¦†ç›–ä¸SINRç›¸å…³æ€§: <b>{corr_è¦†ç›–_sinr:.3f}</b><br>
                â€¢ è¦†ç›–ä¸CQIç›¸å…³æ€§: <b>{corr_è¦†ç›–_cqi:.3f}</b><br>
                â€¢ SINRä¸CQIç›¸å…³æ€§: <b>{corr_sinr_cqi:.3f}</b><br>
                â€¢ æ ·æœ¬æ•°: {len(æ•°æ®):,}
                </div>
                """, unsafe_allow_html=True)
            else:
                st.warning("N41æ•°æ®ä¸è¶³")
        
        with col_divider:
            st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
        
        with col_n28:
            st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - ä¸‰ç»´å…³ç³»</div>', unsafe_allow_html=True)
            if 'n28' in ä¸‰ç»´æ•°æ® and len(ä¸‰ç»´æ•°æ®['n28']) > 0:
                æ•°æ® = ä¸‰ç»´æ•°æ®['n28'].sample(min(2000, len(ä¸‰ç»´æ•°æ®['n28']))).copy()

                # ç¡®ä¿sizeåˆ—ä¸ºæ­£æ•°ï¼ˆplotlyè¦æ±‚sizeå¿…é¡»>0ï¼‰
                æ•°æ®['é€Ÿç‡å¤§å°'] = æ•°æ®['ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)'].clip(lower=0.1)

                fig2 = px.scatter(
                    æ•°æ®, x='å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³', y='å°åŒºMRè¦†ç›–å¹³å‡SINR',
                    color='CQIä¼˜è‰¯ç‡', size='é€Ÿç‡å¤§å°',
                    color_continuous_scale='Reds',
                    title="N28: è¦†ç›–Ã—SINRÃ—CQI(é¢œè‰²)Ã—é€Ÿç‡(å¤§å°)",
                    height=450
                )
                fig2.update_layout(template="plotly_white")
                st.plotly_chart(fig2, use_container_width=True)
                
                corr_è¦†ç›–_sinr = æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'].corr(æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'])
                corr_è¦†ç›–_cqi = æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³'].corr(æ•°æ®['CQIä¼˜è‰¯ç‡'])
                corr_sinr_cqi = æ•°æ®['å°åŒºMRè¦†ç›–å¹³å‡SINR'].corr(æ•°æ®['CQIä¼˜è‰¯ç‡'])
                
                st.markdown(f"""
                <div class="success-box">
                <b>ğŸ“Š N28ä¸‰ç»´å…³ç³»åˆ†æï¼š</b><br>
                â€¢ è¦†ç›–ä¸SINRç›¸å…³æ€§: <b>{corr_è¦†ç›–_sinr:.3f}</b><br>
                â€¢ è¦†ç›–ä¸CQIç›¸å…³æ€§: <b>{corr_è¦†ç›–_cqi:.3f}</b><br>
                â€¢ SINRä¸CQIç›¸å…³æ€§: <b>{corr_sinr_cqi:.3f}</b><br>
                â€¢ æ ·æœ¬æ•°: {len(æ•°æ®):,}
                </div>
                """, unsafe_allow_html=True)
            else:
                st.warning("N28æ•°æ®ä¸è¶³")
    
    # ========== 2. å››è±¡é™åˆ†æ ==========
    with å­æ ‡ç­¾[1]:
        st.markdown('<p class="sub-header">ğŸ¯ å››è±¡é™åˆ†æ - è¦†ç›–Ã—SINRçŸ©é˜µ</p>', unsafe_allow_html=True)
        
        col1, col2 = st.columns(2)
        with col1:
            è¦†ç›–é˜ˆå€¼ = st.number_input("è¦†ç›–é˜ˆå€¼(dBm)", value=-90, key="è¦†ç›–é˜ˆå€¼")
        with col2:
            SINRé˜ˆå€¼ = st.number_input("SINRé˜ˆå€¼(dB)", value=15, key="SINRé˜ˆå€¼")
        
        å››è±¡é™ç»“æœ = åˆ†æå™¨.å››è±¡é™åˆ†æ_æŒ‰åˆ¶å¼(è¦†ç›–é˜ˆå€¼, SINRé˜ˆå€¼)
        
        col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
        
        with col_n41:
            st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - å››è±¡é™</div>', unsafe_allow_html=True)
            if 'n41' in å››è±¡é™ç»“æœ and len(å››è±¡é™ç»“æœ['n41']) > 0:
                st.dataframe(å››è±¡é™ç»“æœ['n41'], use_container_width=True)
                
                # é¥¼å›¾å±•ç¤ºå æ¯”
                fig = px.pie(
                    å››è±¡é™ç»“æœ['n41'], values='å æ¯”(%)', names='è±¡é™',
                    title="N41: å››è±¡é™åˆ†å¸ƒ", hole=0.3,
                    color_discrete_sequence=['#1E90FF', '#4169E1', '#87CEEB', '#B0C4DE']
                )
                fig.update_layout(height=400)
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.warning("N41æ•°æ®ä¸è¶³")
        
        with col_divider:
            st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
        
        with col_n28:
            st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - å››è±¡é™</div>', unsafe_allow_html=True)
            if 'n28' in å››è±¡é™ç»“æœ and len(å››è±¡é™ç»“æœ['n28']) > 0:
                st.dataframe(å››è±¡é™ç»“æœ['n28'], use_container_width=True)
                
                fig = px.pie(
                    å››è±¡é™ç»“æœ['n28'], values='å æ¯”(%)', names='è±¡é™',
                    title="N28: å››è±¡é™åˆ†å¸ƒ", hole=0.3,
                    color_discrete_sequence=['#FF6B6B', '#FF8E53', '#FFA07A', '#FFB6C1']
                )
                fig.update_layout(height=400)
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.warning("N28æ•°æ®ä¸è¶³")
    
    # ========== 3. CQIä¸è¾¾æ ‡æ ¹å› åˆ†æ ==========
    with å­æ ‡ç­¾[2]:
        st.markdown('<p class="sub-header">ğŸ” CQIä¸è¾¾æ ‡æ ¹å› åˆ†æ - é—®é¢˜å®šä½</p>', unsafe_allow_html=True)
        
        st.markdown("""
        <div class="highlight">
        <b>ğŸ” æ ¹å› åˆ†æè¯´æ˜ï¼š</b><br>
        è¯†åˆ«CQIä¸è¾¾æ ‡å°åŒºçš„æ ¹å› ç±»å‹ï¼šè¦†ç›–é—®é¢˜ã€å¹²æ‰°é—®é¢˜ã€è¶ŠåŒºè¦†ç›–ç­‰ã€‚<br>
        â­ N41å’ŒN28å¯åˆ†åˆ«è®¾ç½®ä¸åŒçš„CQIè¾¾æ ‡é˜ˆå€¼ï¼ˆå› ä¸¤åˆ¶å¼æ€§èƒ½åŸºå‡†ä¸åŒï¼‰ã€‚<br>
        â­ è¶ŠåŒºè¦†ç›–ä½¿ç”¨<b>è¦†ç›–ç³»æ•°>0.65</b>ä½œä¸ºåˆ¤æ–­æ ‡å‡†ï¼ˆTA/ç«™é—´è·ï¼‰ã€‚
        </div>
        """, unsafe_allow_html=True)
        
        # â­ ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„æ»‘å—åˆ†åˆ«è®¾ç½®N41å’ŒN28çš„é˜ˆå€¼
        col_n41_th, col_n28_th = st.columns(2)
        with col_n41_th:
            n41é˜ˆå€¼ = st.slider("N41 CQIè¾¾æ ‡é˜ˆå€¼(%)", 70, 95, 85, key="n41_CQIæ ¹å› é˜ˆå€¼")
        with col_n28_th:
            n28é˜ˆå€¼ = st.slider("N28 CQIè¾¾æ ‡é˜ˆå€¼(%)", 70, 95, 75, key="n28_CQIæ ¹å› é˜ˆå€¼")
        
        # ä¼ å…¥å­—å…¸å½¢å¼çš„é˜ˆå€¼
        CQIé˜ˆå€¼ = {'n41': n41é˜ˆå€¼, 'n28': n28é˜ˆå€¼}
        æ ¹å› ç»“æœ = åˆ†æå™¨.CQIä¸è¾¾æ ‡æ ¹å› åˆ†æ_æŒ‰åˆ¶å¼(CQIé˜ˆå€¼)
        
        col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
        
        with col_n41:
            st.markdown(f'<div class="network-type-header n41-header">ğŸ“¡ N41 - æ ¹å› åˆ†æ (é˜ˆå€¼:{n41é˜ˆå€¼}%)</div>', unsafe_allow_html=True)
            if 'n41' in æ ¹å› ç»“æœ:
                st.metric("ä¸è¾¾æ ‡æ¯”ä¾‹", f"{æ ¹å› ç»“æœ['n41']['ä¸è¾¾æ ‡æ¯”ä¾‹']:.2f}%")
                st.metric("ä¸è¾¾æ ‡å°åŒºæ•°", f"{æ ¹å› ç»“æœ['n41']['ä¸è¾¾æ ‡å°åŒºæ•°']:,} / {æ ¹å› ç»“æœ['n41']['æ€»å°åŒºæ•°']:,}")
                
                if len(æ ¹å› ç»“æœ['n41']['æ ¹å› ç»Ÿè®¡']) > 0:
                    st.dataframe(æ ¹å› ç»“æœ['n41']['æ ¹å› ç»Ÿè®¡'], use_container_width=True)
                    
                    # æ ¹å› åˆ†å¸ƒå›¾
                    fig = px.bar(
                        æ ¹å› ç»“æœ['n41']['æ ¹å› ç»Ÿè®¡'], x='æ ¹å› ç±»å‹', y='å æ¯”(%)',
                        title="N41: CQIä¸è¾¾æ ‡æ ¹å› åˆ†å¸ƒ",
                        color='å æ¯”(%)', color_continuous_scale='Blues',
                        height=400
                    )
                    fig.update_layout(template="plotly_white", xaxis_tickangle=-45)
                    st.plotly_chart(fig, use_container_width=True)
            else:
                st.warning("N41æ•°æ®ä¸è¶³")
        
        with col_divider:
            st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
        
        with col_n28:
            st.markdown(f'<div class="network-type-header n28-header">ğŸ“¡ N28 - æ ¹å› åˆ†æ (é˜ˆå€¼:{n28é˜ˆå€¼}%)</div>', unsafe_allow_html=True)
            if 'n28' in æ ¹å› ç»“æœ:
                st.metric("ä¸è¾¾æ ‡æ¯”ä¾‹", f"{æ ¹å› ç»“æœ['n28']['ä¸è¾¾æ ‡æ¯”ä¾‹']:.2f}%")
                st.metric("ä¸è¾¾æ ‡å°åŒºæ•°", f"{æ ¹å› ç»“æœ['n28']['ä¸è¾¾æ ‡å°åŒºæ•°']:,} / {æ ¹å› ç»“æœ['n28']['æ€»å°åŒºæ•°']:,}")
                
                if len(æ ¹å› ç»“æœ['n28']['æ ¹å› ç»Ÿè®¡']) > 0:
                    st.dataframe(æ ¹å› ç»“æœ['n28']['æ ¹å› ç»Ÿè®¡'], use_container_width=True)
                    
                    fig = px.bar(
                        æ ¹å› ç»“æœ['n28']['æ ¹å› ç»Ÿè®¡'], x='æ ¹å› ç±»å‹', y='å æ¯”(%)',
                        title="N28: CQIä¸è¾¾æ ‡æ ¹å› åˆ†å¸ƒ",
                        color='å æ¯”(%)', color_continuous_scale='Reds',
                        height=400
                    )
                    fig.update_layout(template="plotly_white", xaxis_tickangle=-45)
                    st.plotly_chart(fig, use_container_width=True)
            else:
                st.warning("N28æ•°æ®ä¸è¶³")

    # ========== æ€»ä½“åˆ†ææ€»ç»“ ==========
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ å¤šç»´åº¦äº¤å‰åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)

    st.markdown("""
    <div class="highlight">
    <b>ğŸ”„ å¤šç»´åº¦äº¤å‰åˆ†ææ´å¯Ÿï¼š</b><br><br>

    <b>1. ä¸‰ç»´å…³ç³»æ´å¯Ÿï¼š</b><br>
    â€¢ é€šè¿‡è¦†ç›–Ã—SINRÃ—CQIçš„ä¸‰ç»´åˆ†æï¼Œå¯ä»¥è¯†åˆ«å‡ºç½‘ç»œè´¨é‡çš„å…³é”®ç“¶é¢ˆ<br>
    â€¢ é¢œè‰²æ·±æµ…ä»£è¡¨CQIæ°´å¹³ï¼Œæ°”æ³¡å¤§å°ä»£è¡¨ä¸‹è¡Œé€Ÿç‡<br><br>

    <b>2. å››è±¡é™åˆ†æåº”ç”¨ï¼š</b><br>
    â€¢ è±¡é™1(å¥½è¦†ç›–+å¥½SINR)ï¼šç½‘ç»œè´¨é‡ä¼˜è‰¯ï¼Œå¯ä½œä¸ºæ ‡æ†<br>
    â€¢ è±¡é™2(å¥½è¦†ç›–+å·®SINR)ï¼šå­˜åœ¨å¹²æ‰°é—®é¢˜ï¼Œéœ€ä¼˜åŒ–å¹²æ‰°<br>
    â€¢ è±¡é™3(å·®è¦†ç›–+å¥½SINR)ï¼šè¦†ç›–ä¸è¶³ï¼Œéœ€å¢å¼ºè¦†ç›–<br>
    â€¢ è±¡é™4(å·®è¦†ç›–+å·®SINR)ï¼šç»¼åˆé—®é¢˜ï¼Œéœ€å…¨é¢ä¼˜åŒ–<br><br>

    <b>3. æ ¹å› åˆ†ææŒ‡å¯¼ï¼š</b><br>
    â€¢ é€šè¿‡é‡åŒ–å„ç±»é—®é¢˜çš„å æ¯”ï¼Œæ˜ç¡®ä¼˜åŒ–ä¼˜å…ˆçº§<br>
    â€¢ é’ˆå¯¹ä¸»è¦æ ¹å› åˆ¶å®šä¸“é¡¹ä¼˜åŒ–æ–¹æ¡ˆï¼Œæé«˜ä¼˜åŒ–æ•ˆç‡<br><br>

    <b>ğŸ’¡ æç¤ºï¼š</b> TAåˆ†å±‚åˆ†æå’Œæ¡ä»¶åˆ†ç»„åˆ†æå·²åˆå¹¶åˆ°ã€ŒğŸ“ è·ç¦»è¦†ç›–åˆ†æã€æ ‡ç­¾é¡µ
    </div>
    """, unsafe_allow_html=True)


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”è·ç¦»è¦†ç›–åˆ†æ(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“è·ç¦»è¦†ç›–åˆ†æçš„åˆ¶å¼å¯¹æ¯” - æ•´åˆè¦†ç›–ç³»æ•°ã€TAåˆ†å±‚ã€æ¡ä»¶åˆ†ç»„"""
    st.markdown("""
    <div class="highlight">
    <b>ğŸ“ è·ç¦»è¦†ç›–åˆ†æè¯´æ˜ï¼š</b><br>
    ç»¼åˆåˆ†æè¦†ç›–ç³»æ•°ã€TAè·ç¦»ã€è¦†ç›–ç”µå¹³ç­‰å¤šä¸ªç»´åº¦ï¼Œå…¨é¢è¯„ä¼°ç½‘ç»œè¦†ç›–åˆç†æ€§ã€‚
    <br>â€¢ <b>è¦†ç›–ç³»æ•°</b> = TA / ç«™é—´è· | <b>TA</b> = æ—¶é—´æå‰é‡(ç±³) | <b>è¦†ç›–ç”µå¹³</b> = RSRP(dBm)
    </div>
    """, unsafe_allow_html=True)
    
    # è¦†ç›–ç³»æ•°åˆ†æå†…å®¹ï¼ˆç›´æ¥æ˜¾ç¤ºï¼Œæ— å­æ ‡ç­¾ï¼‰
    st.markdown('<p class="sub-header">ğŸ“Š è¦†ç›–ç³»æ•°åˆ†æ - TA/ç«™é—´è·è¯„ä¼°è¦†ç›–åˆç†æ€§</p>', unsafe_allow_html=True)
    
    st.info("""
    ğŸ“Š **è¦†ç›–ç³»æ•°è¯´æ˜**ï¼šè¦†ç›–ç³»æ•° = TA / ç«™é—´è·
    â€¢ <0.3ï¼šè¿‘è¦†ç›– | 0.3~0.65ï¼šé€‚ä¸­è¦†ç›– | >0.65ï¼šè¶ŠåŒºè¦†ç›–
    â€¢ éœ€è¦åŸå§‹æ•°æ®åŒ…å«ã€Œæ–¹å‘è§’ç«™é—´è·ï¼ˆç±³ï¼‰ã€å’Œã€Œå°åŒºMRè¦†ç›–å¹³å‡TAã€å­—æ®µ
    """)
    
    # è¦†ç›–ç³»æ•°ç»Ÿè®¡
    è¦†ç›–ç³»æ•°ç»Ÿè®¡ = åˆ†æå™¨.è¦†ç›–ç³»æ•°ç»Ÿè®¡_æŒ‰åˆ¶å¼()
    
    if len(è¦†ç›–ç³»æ•°ç»Ÿè®¡) == 0:
        st.warning("âš ï¸ æ•°æ®ä¸­æœªæ‰¾åˆ°è¦†ç›–ç³»æ•°å­—æ®µ")
        return
    
    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
    
    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - è¦†ç›–ç³»æ•°ç»Ÿè®¡</div>', unsafe_allow_html=True)
        if 'n41' in è¦†ç›–ç³»æ•°ç»Ÿè®¡:
            æ•°æ® = è¦†ç›–ç³»æ•°ç»Ÿè®¡['n41']
            st.metric("æ ·æœ¬æ•°", f"{æ•°æ®['æ ·æœ¬æ•°']:,}")
            st.metric("å¹³å‡å€¼", f"{æ•°æ®['å¹³å‡å€¼']:.3f}")
            st.metric("ä¸­ä½æ•°", f"{æ•°æ®['ä¸­ä½æ•°']:.3f}")
            st.metric("æ ‡å‡†å·®", f"{æ•°æ®['æ ‡å‡†å·®']:.3f}")
            st.markdown("---")
            st.markdown("**ğŸ“Š è¦†ç›–è·ç¦»åˆ†å¸ƒ**")
            st.write(f"â€¢ è¦†ç›–è¾ƒè¿‘(<0.3): {æ•°æ®['è¦†ç›–è¾ƒè¿‘(<0.3)']:,} ({æ•°æ®['è¦†ç›–è¾ƒè¿‘(<0.3)']/æ•°æ®['æ ·æœ¬æ•°']*100:.1f}%)")
            st.write(f"â€¢ è¦†ç›–é€‚ä¸­(0.3-0.65): {æ•°æ®['è¦†ç›–é€‚ä¸­(0.3-0.65)']:,} ({æ•°æ®['è¦†ç›–é€‚ä¸­(0.3-0.65)']/æ•°æ®['æ ·æœ¬æ•°']*100:.1f}%)")
            st.write(f"â€¢ è¶ŠåŒºè¦†ç›–(>0.65): {æ•°æ®['è¶ŠåŒºè¦†ç›–(>0.65)']:,} ({æ•°æ®['è¶ŠåŒºè¦†ç›–(>0.65)']/æ•°æ®['æ ·æœ¬æ•°']*100:.1f}%)")
    
    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
    
    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - è¦†ç›–ç³»æ•°ç»Ÿè®¡</div>', unsafe_allow_html=True)
        if 'n28' in è¦†ç›–ç³»æ•°ç»Ÿè®¡:
            æ•°æ® = è¦†ç›–ç³»æ•°ç»Ÿè®¡['n28']
            st.metric("æ ·æœ¬æ•°", f"{æ•°æ®['æ ·æœ¬æ•°']:,}")
            st.metric("å¹³å‡å€¼", f"{æ•°æ®['å¹³å‡å€¼']:.3f}")
            st.metric("ä¸­ä½æ•°", f"{æ•°æ®['ä¸­ä½æ•°']:.3f}")
            st.metric("æ ‡å‡†å·®", f"{æ•°æ®['æ ‡å‡†å·®']:.3f}")
            st.markdown("---")
            st.markdown("**ğŸ“Š è¦†ç›–è·ç¦»åˆ†å¸ƒ**")
            st.write(f"â€¢ è¦†ç›–è¾ƒè¿‘(<0.3): {æ•°æ®['è¦†ç›–è¾ƒè¿‘(<0.3)']:,} ({æ•°æ®['è¦†ç›–è¾ƒè¿‘(<0.3)']/æ•°æ®['æ ·æœ¬æ•°']*100:.1f}%)")
            st.write(f"â€¢ è¦†ç›–é€‚ä¸­(0.3-0.65): {æ•°æ®['è¦†ç›–é€‚ä¸­(0.3-0.65)']:,} ({æ•°æ®['è¦†ç›–é€‚ä¸­(0.3-0.65)']/æ•°æ®['æ ·æœ¬æ•°']*100:.1f}%)")
            st.write(f"â€¢ è¶ŠåŒºè¦†ç›–(>0.65): {æ•°æ®['è¶ŠåŒºè¦†ç›–(>0.65)']:,} ({æ•°æ®['è¶ŠåŒºè¦†ç›–(>0.65)']/æ•°æ®['æ ·æœ¬æ•°']*100:.1f}%)")
    
    st.markdown("---")
    
    # 2. è¦†ç›–ç³»æ•°åˆ†å¸ƒç›´æ–¹å›¾
    st.markdown('<p class="sub-header">ğŸ“ˆ è¦†ç›–ç³»æ•°åˆ†å¸ƒå¯¹æ¯”</p>', unsafe_allow_html=True)
    
    col_hist1, col_hist2 = st.columns(2)
    
    with col_hist1:
        if 'n41' in è¦†ç›–ç³»æ•°ç»Ÿè®¡:
            æ•°æ® = è¦†ç›–ç³»æ•°ç»Ÿè®¡['n41']['è¦†ç›–ç³»æ•°æ•°æ®']
            fig_n41 = px.histogram(
                x=æ•°æ®,
                nbins=50,
                color_discrete_sequence=['#1E90FF'],
                title="N41 - è¦†ç›–ç³»æ•°åˆ†å¸ƒ",
                labels={'x': 'è¦†ç›–ç³»æ•°'}
            )
            fig_n41.add_vline(x=0.3, line_dash="dash", line_color="green", annotation_text="é€‚ä¸­ä¸‹é™")
            fig_n41.add_vline(x=0.7, line_dash="dash", line_color="orange", annotation_text="é€‚ä¸­ä¸Šé™")
            fig_n41.add_vline(x=1.0, line_dash="dash", line_color="red", annotation_text="è¶ŠåŒºé˜ˆå€¼")
            fig_n41.update_layout(template="plotly_white", height=400)
            st.plotly_chart(fig_n41, use_container_width=True)
    
    with col_hist2:
        if 'n28' in è¦†ç›–ç³»æ•°ç»Ÿè®¡:
            æ•°æ® = è¦†ç›–ç³»æ•°ç»Ÿè®¡['n28']['è¦†ç›–ç³»æ•°æ•°æ®']
            fig_n28 = px.histogram(
                x=æ•°æ®,
                nbins=50,
                color_discrete_sequence=['#FF6B6B'],
                title="N28 - è¦†ç›–ç³»æ•°åˆ†å¸ƒ",
                labels={'x': 'è¦†ç›–ç³»æ•°'}
            )
            fig_n28.add_vline(x=0.3, line_dash="dash", line_color="green", annotation_text="é€‚ä¸­ä¸‹é™")
            fig_n28.add_vline(x=0.7, line_dash="dash", line_color="orange", annotation_text="é€‚ä¸­ä¸Šé™")
            fig_n28.add_vline(x=1.0, line_dash="dash", line_color="red", annotation_text="è¶ŠåŒºé˜ˆå€¼")
            fig_n28.update_layout(template="plotly_white", height=400)
            st.plotly_chart(fig_n28, use_container_width=True)
    
    st.markdown("---")
    
    # 3. è¦†ç›–ç³»æ•°ä¸CQIç›¸å…³æ€§åˆ†æ
    st.markdown('<p class="sub-header">ğŸ”— è¦†ç›–ç³»æ•°ä¸ç½‘ç»œè´¨é‡ç›¸å…³æ€§</p>', unsafe_allow_html=True)
    
    ç›¸å…³æ€§ç»“æœ = åˆ†æå™¨.è¦†ç›–ç³»æ•°ä¸CQIç›¸å…³æ€§_æŒ‰åˆ¶å¼()
    
    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
    
    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - ç›¸å…³æ€§åˆ†æ</div>', unsafe_allow_html=True)
        if 'n41' in ç›¸å…³æ€§ç»“æœ:
            å›¾è¡¨æ•°æ® = pd.DataFrame(ç›¸å…³æ€§ç»“æœ['n41'])
            fig_n41 = px.bar(
                å›¾è¡¨æ•°æ®,
                x="ç›¸å…³ç³»æ•°",
                y="æŒ‡æ ‡",
                orientation='h',
                color="ç›¸å…³ç³»æ•°",
                color_continuous_scale="Blues",
                title="N41 - è¦†ç›–ç³»æ•°ä¸å„æŒ‡æ ‡ç›¸å…³æ€§",
                text_auto=".3f"
            )
            fig_n41.update_layout(template="plotly_white", yaxis={'categoryorder': 'total ascending'})
            st.plotly_chart(fig_n41, use_container_width=True)
            st.dataframe(å›¾è¡¨æ•°æ®[['æŒ‡æ ‡', 'ç›¸å…³ç³»æ•°', 'æ˜¾è‘—æ€§', 'å¼ºåº¦']], use_container_width=True)
    
    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
    
    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - ç›¸å…³æ€§åˆ†æ</div>', unsafe_allow_html=True)
        if 'n28' in ç›¸å…³æ€§ç»“æœ:
            å›¾è¡¨æ•°æ® = pd.DataFrame(ç›¸å…³æ€§ç»“æœ['n28'])
            fig_n28 = px.bar(
                å›¾è¡¨æ•°æ®,
                x="ç›¸å…³ç³»æ•°",
                y="æŒ‡æ ‡",
                orientation='h',
                color="ç›¸å…³ç³»æ•°",
                color_continuous_scale="Reds",
                title="N28 - è¦†ç›–ç³»æ•°ä¸å„æŒ‡æ ‡ç›¸å…³æ€§",
                text_auto=".3f"
            )
            fig_n28.update_layout(template="plotly_white", yaxis={'categoryorder': 'total ascending'})
            st.plotly_chart(fig_n28, use_container_width=True)
            st.dataframe(å›¾è¡¨æ•°æ®[['æŒ‡æ ‡', 'ç›¸å…³ç³»æ•°', 'æ˜¾è‘—æ€§', 'å¼ºåº¦']], use_container_width=True)
    
    st.markdown("---")
    
    # 4. è¦†ç›–ç³»æ•°åˆ†å±‚åˆ†æ
    st.markdown('<p class="sub-header">ğŸ“Š è¦†ç›–ç³»æ•°åˆ†å±‚åˆ†æ</p>', unsafe_allow_html=True)
    
    åˆ†å±‚ç»“æœ = åˆ†æå™¨.å¤šç»´åº¦åˆ†å±‚åˆ†æ_æŒ‰åˆ¶å¼(ç»´åº¦='è¦†ç›–ç³»æ•°')
    
    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
    
    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - åˆ†å±‚åˆ†æ</div>', unsafe_allow_html=True)
        if 'n41' in åˆ†å±‚ç»“æœ and len(åˆ†å±‚ç»“æœ['n41']) > 0:
            st.dataframe(åˆ†å±‚ç»“æœ['n41'], use_container_width=True)
            
            # åŒè½´å›¾ï¼šCQIå’Œé€Ÿç‡éšè¦†ç›–ç³»æ•°æ¡£ä½å˜åŒ–
            from plotly.subplots import make_subplots
            import plotly.graph_objects as go
            
            fig = make_subplots(rows=1, cols=2, subplot_titles=('CQIéšè¦†ç›–ç³»æ•°å˜åŒ–', 'é€Ÿç‡éšè¦†ç›–ç³»æ•°å˜åŒ–'))
            fig.add_trace(
                go.Bar(x=åˆ†å±‚ç»“æœ['n41']['æ¡£ä½'], y=åˆ†å±‚ç»“æœ['n41']['å¹³å‡CQI'], 
                       name='CQI', marker_color='#1E90FF'),
                row=1, col=1
            )
            fig.add_trace(
                go.Bar(x=åˆ†å±‚ç»“æœ['n41']['æ¡£ä½'], y=åˆ†å±‚ç»“æœ['n41']['å¹³å‡ä¸‹è¡Œé€Ÿç‡'], 
                       name='é€Ÿç‡', marker_color='#4169E1'),
                row=1, col=2
            )
            fig.update_layout(template='plotly_white', height=400, showlegend=False)
            st.plotly_chart(fig, use_container_width=True)
    
    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
    
    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - åˆ†å±‚åˆ†æ</div>', unsafe_allow_html=True)
        if 'n28' in åˆ†å±‚ç»“æœ and len(åˆ†å±‚ç»“æœ['n28']) > 0:
            st.dataframe(åˆ†å±‚ç»“æœ['n28'], use_container_width=True)
            
            # åŒè½´å›¾ï¼šCQIå’Œé€Ÿç‡éšè¦†ç›–ç³»æ•°æ¡£ä½å˜åŒ–
            from plotly.subplots import make_subplots
            import plotly.graph_objects as go
            
            fig = make_subplots(rows=1, cols=2, subplot_titles=('CQIéšè¦†ç›–ç³»æ•°å˜åŒ–', 'é€Ÿç‡éšè¦†ç›–ç³»æ•°å˜åŒ–'))
            fig.add_trace(
                go.Bar(x=åˆ†å±‚ç»“æœ['n28']['æ¡£ä½'], y=åˆ†å±‚ç»“æœ['n28']['å¹³å‡CQI'], 
                       name='CQI', marker_color='#FF6B6B'),
                row=1, col=1
            )
            fig.add_trace(
                go.Bar(x=åˆ†å±‚ç»“æœ['n28']['æ¡£ä½'], y=åˆ†å±‚ç»“æœ['n28']['å¹³å‡ä¸‹è¡Œé€Ÿç‡'], 
                       name='é€Ÿç‡', marker_color='#FF8E53'),
                row=1, col=2
            )
            fig.update_layout(template='plotly_white', height=400, showlegend=False)
            st.plotly_chart(fig, use_container_width=True)
    
    st.markdown("---")
    
    # 5. å››è±¡é™åˆ†æ
    st.markdown('<p class="sub-header">ğŸ¯ è¦†ç›–ç³»æ•°Ã—è¦†ç›–ç”µå¹³ å››è±¡é™åˆ†æ</p>', unsafe_allow_html=True)
    
    col1, col2 = st.columns(2)
    with col1:
        è¦†ç›–ç³»æ•°é˜ˆå€¼ = st.number_input("è¦†ç›–ç³»æ•°é˜ˆå€¼", value=0.7, step=0.1, key="è¦†ç›–ç³»æ•°é˜ˆå€¼")
    with col2:
        è¦†ç›–ç”µå¹³é˜ˆå€¼ = st.number_input("è¦†ç›–ç”µå¹³é˜ˆå€¼(dBm)", value=-90, key="å››è±¡é™è¦†ç›–ç”µå¹³é˜ˆå€¼")
    
    å››è±¡é™ç»“æœ = åˆ†æå™¨.è¦†ç›–ç³»æ•°å››è±¡é™åˆ†æ_æŒ‰åˆ¶å¼(è¦†ç›–ç³»æ•°é˜ˆå€¼, è¦†ç›–ç”µå¹³é˜ˆå€¼)
    
    col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
    
    with col_n41:
        st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 - å››è±¡é™åˆ†å¸ƒ</div>', unsafe_allow_html=True)
        if 'n41' in å››è±¡é™ç»“æœ and len(å››è±¡é™ç»“æœ['n41']) > 0:
            st.dataframe(å››è±¡é™ç»“æœ['n41'], use_container_width=True)
            
            fig = px.pie(
                å››è±¡é™ç»“æœ['n41'], values='å æ¯”(%)', names='è±¡é™',
                title="N41: å››è±¡é™åˆ†å¸ƒ", hole=0.3,
                color_discrete_sequence=['#1E90FF', '#4169E1', '#87CEEB', '#B0C4DE']
            )
            fig.update_layout(height=400)
            st.plotly_chart(fig, use_container_width=True)
    
    with col_divider:
        st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
    
    with col_n28:
        st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 - å››è±¡é™åˆ†å¸ƒ</div>', unsafe_allow_html=True)
        if 'n28' in å››è±¡é™ç»“æœ and len(å››è±¡é™ç»“æœ['n28']) > 0:
            st.dataframe(å››è±¡é™ç»“æœ['n28'], use_container_width=True)
            
            fig = px.pie(
                å››è±¡é™ç»“æœ['n28'], values='å æ¯”(%)', names='è±¡é™',
                title="N28: å››è±¡é™åˆ†å¸ƒ", hole=0.3,
                color_discrete_sequence=['#FF6B6B', '#FF8E53', '#FFA07A', '#FFB6C1']
            )
            fig.update_layout(height=400)
            st.plotly_chart(fig, use_container_width=True)
    
        # åˆ†ææ€»ç»“
        st.markdown("---")
        st.markdown('<p class="sub-header">ğŸ“ è¦†ç›–ç³»æ•°åˆ†ææ€»ç»“</p>', unsafe_allow_html=True)
        
        if len(è¦†ç›–ç³»æ•°ç»Ÿè®¡) > 0:
            æ€»ç»“å†…å®¹ = "<div class='highlight'><b>ğŸ“Š è¦†ç›–ç³»æ•°åˆ†ææ´å¯Ÿ</b><br><br>"
            
            æ€»ç»“å†…å®¹ += "<b>1. è¦†ç›–ç³»æ•°ç»Ÿè®¡æ‘˜è¦ï¼š</b><br>"
            for åˆ¶å¼, æ•°æ® in è¦†ç›–ç³»æ•°ç»Ÿè®¡.items():
                è¶ŠåŒºå æ¯” = æ•°æ®['è¶ŠåŒºè¦†ç›–(>0.65)'] / æ•°æ®['æ ·æœ¬æ•°'] * 100
                æ€»ç»“å†…å®¹ += f"â€¢ <b>{åˆ¶å¼.upper()}</b>: å‡å€¼={æ•°æ®['å¹³å‡å€¼']:.3f}, ä¸­ä½æ•°={æ•°æ®['ä¸­ä½æ•°']:.3f}, è¶ŠåŒºè¦†ç›–å æ¯”={è¶ŠåŒºå æ¯”:.1f}%<br>"
            
            if len(ç›¸å…³æ€§ç»“æœ) > 0:
                æ€»ç»“å†…å®¹ += "<br><b>2. è¦†ç›–ç³»æ•°ä¸CQIå…³ç³»ï¼š</b><br>"
                for åˆ¶å¼, åˆ—è¡¨ in ç›¸å…³æ€§ç»“æœ.items():
                    if len(åˆ—è¡¨) > 0:
                        cqi_corr = next((x for x in åˆ—è¡¨ if x['æŒ‡æ ‡'] == 'CQIä¼˜è‰¯ç‡'), None)
                        if cqi_corr:
                            æ–¹å‘ = "è´Ÿç›¸å…³" if cqi_corr['ç›¸å…³ç³»æ•°'] < 0 else "æ­£ç›¸å…³"
                            æ€»ç»“å†…å®¹ += f"â€¢ <b>{åˆ¶å¼.upper()}</b>: è¦†ç›–ç³»æ•°ä¸CQIå‘ˆ{cqi_corr['å¼ºåº¦']}{æ–¹å‘}(r={cqi_corr['ç›¸å…³ç³»æ•°']:.3f})<br>"
            
            æ€»ç»“å†…å®¹ += "<br><b>3. ä¼˜åŒ–å»ºè®®ï¼š</b><br>"
            æ€»ç»“å†…å®¹ += "â€¢ å…³æ³¨è¦†ç›–ç³»æ•°>0.65çš„è¶ŠåŒºè¦†ç›–å°åŒºï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ä¸‹å€¾è§’æˆ–åŠŸç‡<br>"
            æ€»ç»“å†…å®¹ += "â€¢ è¦†ç›–ç³»æ•°<0.3çš„å°åŒºå¯èƒ½å­˜åœ¨è¦†ç›–ä¸è¶³ï¼Œå»ºè®®æ£€æŸ¥å¤©çº¿æ–¹ä½è§’<br>"
            æ€»ç»“å†…å®¹ += "â€¢ è¦†ç›–ç³»æ•°åœ¨0.3~0.65èŒƒå›´å†…çš„ç½‘ç»œè´¨é‡é€šå¸¸è¾ƒå¥½ï¼Œå¯ä½œä¸ºæ ‡æ†<br>"
            æ€»ç»“å†…å®¹ += "â€¢ ç»“åˆå››è±¡é™åˆ†æï¼Œä¼˜å…ˆå¤„ç†'å·®è¦†ç›–+è¿‡è¿œè¦†ç›–è·ç¦»'çš„å°åŒº"
            
            æ€»ç»“å†…å®¹ += "</div>"
            st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)


def æ¸²æŸ“åˆ¶å¼å¯¹æ¯”æ•°æ®å¯¼å‡º(åˆ†æå™¨: CQIåˆ†æå™¨):
    """æ¸²æŸ“æ•°æ®å¯¼å‡ºçš„ç½‘ç»œåˆ¶å¼å¯¹æ¯”"""
    st.markdown('<p class="sub-header">ğŸ“¥ æ•°æ®å¯¼å‡º</p>', unsafe_allow_html=True)

    st.markdown("""
    <div class="highlight">
    <b>ğŸ“¥ å¯¼å‡ºè¯´æ˜ï¼š</b><br>
    ç”ŸæˆåŒ…å«N41å’ŒN28ä¸¤ä¸ªç½‘ç»œåˆ¶å¼å®Œæ•´åˆ†æç»“æœçš„ExcelæŠ¥å‘Šï¼ŒåŒ…å«æ–°å¢çš„è¦†ç›–ç³»æ•°åˆ†æç»“æœã€‚
    </div>
    """, unsafe_allow_html=True)

    åˆ†ç»„æ•°æ® = åˆ†æå™¨.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
    
    # æ˜¾ç¤ºæ•°æ®é‡ç»Ÿè®¡
    if 'n41' in åˆ†ç»„æ•°æ® and 'n28' in åˆ†ç»„æ•°æ®:
        col_n41, col_divider, col_n28 = st.columns([10, 1, 10])
        
        with col_n41:
            st.markdown('<div class="network-type-header n41-header">ğŸ“¡ N41 æ•°æ®æ¦‚å†µ</div>', unsafe_allow_html=True)
            st.metric("æ•°æ®é‡", f"{len(åˆ†ç»„æ•°æ®['n41']):,} æ¡")
            # æ˜¾ç¤ºè¦†ç›–ç³»æ•°ç»Ÿè®¡
            if 'è¦†ç›–ç³»æ•°' in åˆ†ç»„æ•°æ®['n41'].columns:
                è¶ŠåŒºæ•° = len(åˆ†ç»„æ•°æ®['n41'][åˆ†ç»„æ•°æ®['n41']['è¦†ç›–ç³»æ•°'] > 0.65])
                st.metric("è¶ŠåŒºè¦†ç›–å°åŒº", f"{è¶ŠåŒºæ•°:,} æ¡")
        
        with col_divider:
            st.markdown('<div class="comparison-divider"></div>', unsafe_allow_html=True)
        
        with col_n28:
            st.markdown('<div class="network-type-header n28-header">ğŸ“¡ N28 æ•°æ®æ¦‚å†µ</div>', unsafe_allow_html=True)
            st.metric("æ•°æ®é‡", f"{len(åˆ†ç»„æ•°æ®['n28']):,} æ¡")
            # æ˜¾ç¤ºè¦†ç›–ç³»æ•°ç»Ÿè®¡
            if 'è¦†ç›–ç³»æ•°' in åˆ†ç»„æ•°æ®['n28'].columns:
                è¶ŠåŒºæ•° = len(åˆ†ç»„æ•°æ®['n28'][åˆ†ç»„æ•°æ®['n28']['è¦†ç›–ç³»æ•°'] > 0.65])
                st.metric("è¶ŠåŒºè¦†ç›–å°åŒº", f"{è¶ŠåŒºæ•°:,} æ¡")

    st.markdown("---")

    # å¯¼å‡ºå®Œæ•´åˆ†ææŠ¥å‘Š
    st.markdown('<p class="sub-header">ğŸ“Š å¯¼å‡ºå®Œæ•´åˆ†ææŠ¥å‘Š</p>', unsafe_allow_html=True)
    
    st.info("""
    ğŸ“Š æŠ¥å‘Šå†…å®¹æ¸…å•ï¼ˆ18ä¸ªå·¥ä½œè¡¨ï¼‰ï¼š
    â€¢ N41åŸå§‹æ•°æ® / N28åŸå§‹æ•°æ®  
    â€¢ ç»Ÿè®¡æ‘˜è¦
    â€¢ N41_CQIå¯¹é€Ÿç‡å½±å“ / N28_CQIå¯¹é€Ÿç‡å½±å“
    â€¢ N41_å½±å“CQIçš„å› ç´  / N28_å½±å“CQIçš„å› ç´ 
    â€¢ N41_ç›¸å…³æ€§çŸ©é˜µ / N28_ç›¸å…³æ€§çŸ©é˜µ
    â€¢ N41_æ‹ç‚¹åˆ†æ / N28_æ‹ç‚¹åˆ†æ
    â€¢ N41_è´¡çŒ®åº¦åˆ†æ / N28_è´¡çŒ®åº¦åˆ†æ
    â€¢ N41_åˆ†ç»„åˆ†æ / N28_åˆ†ç»„åˆ†æ
    â€¢ N41_è¦†ç›–ç³»æ•°ç»Ÿè®¡ / N28_è¦†ç›–ç³»æ•°ç»Ÿè®¡ â­æ–°å¢
    â€¢ N41_è¦†ç›–ç³»æ•°åˆ†å±‚åˆ†æ / N28_è¦†ç›–ç³»æ•°åˆ†å±‚åˆ†æ â­æ–°å¢
    """)
    
    # é¢„ç”ŸæˆæŠ¥å‘Šæ•°æ®
    @st.cache_data
    def ç”ŸæˆæŠ¥å‘Šæ•°æ®():
        """ç”ŸæˆæŠ¥å‘Šæ•°æ®å¹¶ç¼“å­˜"""
        import io
        è¾“å‡º = io.BytesIO()
        with pd.ExcelWriter(è¾“å‡º, engine='openpyxl') as writer:
            # 1. N41åŸå§‹æ•°æ®
            if 'n41' in åˆ†ç»„æ•°æ®:
                åˆ†ç»„æ•°æ®['n41'].to_excel(writer, sheet_name='N41åŸå§‹æ•°æ®', index=False)
            
            # 2. N28åŸå§‹æ•°æ®
            if 'n28' in åˆ†ç»„æ•°æ®:
                åˆ†ç»„æ•°æ®['n28'].to_excel(writer, sheet_name='N28åŸå§‹æ•°æ®', index=False)
            
            # 3. ç»Ÿè®¡æ‘˜è¦
            ç»Ÿè®¡æ‘˜è¦ = åˆ†æå™¨.è·å–ç»Ÿè®¡æ‘˜è¦_æŒ‰åˆ¶å¼()
            ç»Ÿè®¡df = pd.DataFrame(ç»Ÿè®¡æ‘˜è¦).T
            ç»Ÿè®¡df.to_excel(writer, sheet_name='ç»Ÿè®¡æ‘˜è¦')
            
            # 4. CQIå¯¹é€Ÿç‡å½±å“åˆ†æ
            é€Ÿç‡å½±å“ = åˆ†æå™¨.åˆ†æCQIå¯¹é€Ÿç‡å½±å“_æŒ‰åˆ¶å¼()
            if 'n41' in é€Ÿç‡å½±å“:
                n41_rate_df = pd.DataFrame(é€Ÿç‡å½±å“['n41']).T
                n41_rate_df.to_excel(writer, sheet_name='N41_CQIå¯¹é€Ÿç‡å½±å“')
            if 'n28' in é€Ÿç‡å½±å“:
                n28_rate_df = pd.DataFrame(é€Ÿç‡å½±å“['n28']).T
                n28_rate_df.to_excel(writer, sheet_name='N28_CQIå¯¹é€Ÿç‡å½±å“')
            
            # 5. å½±å“CQIçš„å› ç´ åˆ†æ
            å½±å“ç»“æœ = åˆ†æå™¨.åˆ†æå½±å“CQIçš„æŒ‡æ ‡_æŒ‰åˆ¶å¼()
            if 'n41' in å½±å“ç»“æœ:
                n41_factor_df = pd.DataFrame(å½±å“ç»“æœ['n41'])
                n41_factor_df.to_excel(writer, sheet_name='N41_å½±å“CQIçš„å› ç´ ', index=False)
            if 'n28' in å½±å“ç»“æœ:
                n28_factor_df = pd.DataFrame(å½±å“ç»“æœ['n28'])
                n28_factor_df.to_excel(writer, sheet_name='N28_å½±å“CQIçš„å› ç´ ', index=False)
            
            # 6. ç›¸å…³æ€§çŸ©é˜µ
            åˆ—ååˆ—è¡¨ = [
                'CQIä¼˜è‰¯ç‡',
                'ä¸‹è¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
                'ä¸Šè¡Œç”¨æˆ·å¹³å‡é€Ÿç‡(MBPS)',
                'å°åŒºMRè¦†ç›–å¹³å‡ç”µå¹³',
                'å°åŒºMRè¦†ç›–å¹³å‡SINR',
                'å°åŒºMRè¦†ç›–å¹³å‡TA',
                'å°åŒºä¸Šè¡Œå¹³å‡å¹²æ‰°ç”µå¹³',
                'é‡å è¦†ç›–é‡‡æ ·ç‚¹æ¯”ä¾‹(%)',  # â­æ–°å¢
                'è¦†ç›–ç³»æ•°'  # â­æ–°å¢
            ]
            ç›¸å…³æ€§çŸ©é˜µ = åˆ†æå™¨.è®¡ç®—ç›¸å…³æ€§çŸ©é˜µ_æŒ‰åˆ¶å¼(åˆ—ååˆ—è¡¨)
            if 'n41' in ç›¸å…³æ€§çŸ©é˜µ:
                ç›¸å…³æ€§çŸ©é˜µ['n41'].to_excel(writer, sheet_name='N41_ç›¸å…³æ€§çŸ©é˜µ')
            if 'n28' in ç›¸å…³æ€§çŸ©é˜µ:
                ç›¸å…³æ€§çŸ©é˜µ['n28'].to_excel(writer, sheet_name='N28_ç›¸å…³æ€§çŸ©é˜µ')
            
            # 7. æ‹ç‚¹åˆ†æ
            æ‹ç‚¹åˆ†æç»“æœ = åˆ†æå™¨.CQIé€Ÿç‡æ‹ç‚¹åˆ†æ_æŒ‰åˆ¶å¼(10)
            if 'n41' in æ‹ç‚¹åˆ†æç»“æœ:
                æ‹ç‚¹åˆ†æç»“æœ['n41']['åŒºé—´ç»Ÿè®¡'].to_excel(writer, sheet_name='N41_æ‹ç‚¹åˆ†æ', index=False)
            if 'n28' in æ‹ç‚¹åˆ†æç»“æœ:
                æ‹ç‚¹åˆ†æç»“æœ['n28']['åŒºé—´ç»Ÿè®¡'].to_excel(writer, sheet_name='N28_æ‹ç‚¹åˆ†æ', index=False)
            
            # 8. è´¡çŒ®åº¦åˆ†æ
            è´¡çŒ®åº¦ç»“æœ = åˆ†æå™¨.è´¡çŒ®åº¦åˆ†æ_æŒ‰åˆ¶å¼()
            if 'n41' in è´¡çŒ®åº¦ç»“æœ:
                n41_contrib_df = pd.DataFrame(è´¡çŒ®åº¦ç»“æœ['n41']['è´¡çŒ®åº¦åˆ—è¡¨'])
                n41_contrib_df.to_excel(writer, sheet_name='N41_è´¡çŒ®åº¦åˆ†æ', index=False)
            if 'n28' in è´¡çŒ®åº¦ç»“æœ:
                n28_contrib_df = pd.DataFrame(è´¡çŒ®åº¦ç»“æœ['n28']['è´¡çŒ®åº¦åˆ—è¡¨'])
                n28_contrib_df.to_excel(writer, sheet_name='N28_è´¡çŒ®åº¦åˆ†æ', index=False)
            
            # 9. åˆ†ç»„åˆ†æ
            åˆ†ç»„åˆ†æ = åˆ†æå™¨.æŒ‰CQIåˆ†ç»„åˆ†æ_æŒ‰åˆ¶å¼(5)
            if 'n41' in åˆ†ç»„åˆ†æ:
                åˆ†ç»„åˆ†æ['n41'].to_excel(writer, sheet_name='N41_åˆ†ç»„åˆ†æ')
            if 'n28' in åˆ†ç»„åˆ†æ:
                åˆ†ç»„åˆ†æ['n28'].to_excel(writer, sheet_name='N28_åˆ†ç»„åˆ†æ')
            
            # 10. è¦†ç›–ç³»æ•°ç»Ÿè®¡ â­æ–°å¢
            è¦†ç›–ç³»æ•°ç»Ÿè®¡ = åˆ†æå™¨.è¦†ç›–ç³»æ•°ç»Ÿè®¡_æŒ‰åˆ¶å¼()
            if 'n41' in è¦†ç›–ç³»æ•°ç»Ÿè®¡:
                n41_coef_stats = {k: v for k, v in è¦†ç›–ç³»æ•°ç»Ÿè®¡['n41'].items() if k != 'è¦†ç›–ç³»æ•°æ•°æ®'}
                pd.DataFrame([n41_coef_stats]).to_excel(writer, sheet_name='N41_è¦†ç›–ç³»æ•°ç»Ÿè®¡', index=False)
            if 'n28' in è¦†ç›–ç³»æ•°ç»Ÿè®¡:
                n28_coef_stats = {k: v for k, v in è¦†ç›–ç³»æ•°ç»Ÿè®¡['n28'].items() if k != 'è¦†ç›–ç³»æ•°æ•°æ®'}
                pd.DataFrame([n28_coef_stats]).to_excel(writer, sheet_name='N28_è¦†ç›–ç³»æ•°ç»Ÿè®¡', index=False)
            
            # 11. è¦†ç›–ç³»æ•°ä¸CQIç›¸å…³æ€§ â­æ–°å¢
            ç›¸å…³æ€§ç»“æœ = åˆ†æå™¨.è¦†ç›–ç³»æ•°ä¸CQIç›¸å…³æ€§_æŒ‰åˆ¶å¼()
            if 'n41' in ç›¸å…³æ€§ç»“æœ:
                pd.DataFrame(ç›¸å…³æ€§ç»“æœ['n41']).to_excel(writer, sheet_name='N41_è¦†ç›–ç³»æ•°ç›¸å…³æ€§', index=False)
            if 'n28' in ç›¸å…³æ€§ç»“æœ:
                pd.DataFrame(ç›¸å…³æ€§ç»“æœ['n28']).to_excel(writer, sheet_name='N28_è¦†ç›–ç³»æ•°ç›¸å…³æ€§', index=False)
            
            # 12. è¦†ç›–ç³»æ•°åˆ†å±‚åˆ†æ â­æ–°å¢
            åˆ†å±‚ç»“æœ = åˆ†æå™¨.å¤šç»´åº¦åˆ†å±‚åˆ†æ_æŒ‰åˆ¶å¼(ç»´åº¦='è¦†ç›–ç³»æ•°')
            if 'n41' in åˆ†å±‚ç»“æœ:
                åˆ†å±‚ç»“æœ['n41'].to_excel(writer, sheet_name='N41_è¦†ç›–ç³»æ•°åˆ†å±‚', index=False)
            if 'n28' in åˆ†å±‚ç»“æœ:
                åˆ†å±‚ç»“æœ['n28'].to_excel(writer, sheet_name='N28_è¦†ç›–ç³»æ•°åˆ†å±‚', index=False)

        è¾“å‡º.seek(0)
        return è¾“å‡º.getvalue()
    
    # ç”ŸæˆæŠ¥å‘Š
    with st.spinner('æ­£åœ¨å‡†å¤‡æŠ¥å‘Š...'):
        try:
            æŠ¥å‘Šæ•°æ® = ç”ŸæˆæŠ¥å‘Šæ•°æ®()
            st.success("âœ… æŠ¥å‘Šå·²å‡†å¤‡å¥½ï¼")
            
            # ç›´æ¥æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½å®Œæ•´åˆ†ææŠ¥å‘Š",
                data=æŠ¥å‘Šæ•°æ®,
                file_name="CQI_ZTE/CQIåˆ†æå®Œæ•´æŠ¥å‘Š_N41vsN28.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                type="primary"
            )
        except Exception as e:
            st.error(f"âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥: {str(e)}")

    # åˆ†ææ€»ç»“
    st.markdown("---")
    st.markdown('<p class="sub-header">ğŸ“ æ•°æ®å¯¼å‡ºæ€»ç»“</p>', unsafe_allow_html=True)

    åˆ†ç»„æ•°æ® = åˆ†æå™¨.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()

    æ€»ç»“å†…å®¹ = "<div class='highlight'><b>ğŸ“Š æ•°æ®å¯¼å‡ºè¯´æ˜</b><br><br>"

    æ€»ç»“å†…å®¹ += "<b>1. å¯å¯¼å‡ºæ•°æ®ç±»å‹ï¼š</b><br>"
    æ€»ç»“å†…å®¹ += "â€¢ <b>N41åŸå§‹æ•°æ®</b>ï¼šåŒ…å«N41ç½‘ç»œåˆ¶å¼æ‰€æœ‰å°åŒºçš„è¯¦ç»†æ•°æ®<br>"
    æ€»ç»“å†…å®¹ += "â€¢ <b>N28åŸå§‹æ•°æ®</b>ï¼šåŒ…å«N28ç½‘ç»œåˆ¶å¼æ‰€æœ‰å°åŒºçš„è¯¦ç»†æ•°æ®<br>"
    æ€»ç»“å†…å®¹ += "â€¢ <b>ç»Ÿè®¡æ‘˜è¦</b>ï¼šN41å’ŒN28çš„æ±‡æ€»ç»Ÿè®¡ä¿¡æ¯<br>"

    if 'n41' in åˆ†ç»„æ•°æ® and 'n28' in åˆ†ç»„æ•°æ®:
        n41_count = len(åˆ†ç»„æ•°æ®['n41'])
        n28_count = len(åˆ†ç»„æ•°æ®['n28'])
        total_count = n41_count + n28_count

        æ€»ç»“å†…å®¹ += "<br><b>2. æ•°æ®é‡ç»Ÿè®¡ï¼š</b><br>"
        æ€»ç»“å†…å®¹ += f"â€¢ N41æ•°æ®é‡: {n41_count:,} æ¡ ({n41_count/total_count*100:.1f}%)<br>"
        æ€»ç»“å†…å®¹ += f"â€¢ N28æ•°æ®é‡: {n28_count:,} æ¡ ({n28_count/total_count*100:.1f}%)<br>"
        æ€»ç»“å†…å®¹ += f"â€¢ æ€»æ•°æ®é‡: {total_count:,} æ¡<br>"

    æ€»ç»“å†…å®¹ += "<br><b>3. å¯¼å‡ºæ–‡ä»¶è¯´æ˜ï¼š</b><br>"
    æ€»ç»“å†…å®¹ += "â€¢ <b>N41_CQIåˆ†ææ•°æ®.xlsx</b>ï¼šä»…åŒ…å«N41ç½‘ç»œåˆ¶å¼çš„åˆ†ææ•°æ®<br>"
    æ€»ç»“å†…å®¹ += "â€¢ <b>N28_CQIåˆ†ææ•°æ®.xlsx</b>ï¼šä»…åŒ…å«N28ç½‘ç»œåˆ¶å¼çš„åˆ†ææ•°æ®<br>"
    æ€»ç»“å†…å®¹ += "â€¢ <b>CQIåˆ†æå®Œæ•´æŠ¥å‘Š_N41vsN28.xlsx</b>ï¼šåŒ…å«ä¸¤ä¸ªåˆ¶å¼çš„å®Œæ•´åˆ†ææŠ¥å‘Š<br>"

    æ€»ç»“å†…å®¹ += "<br><b>4. ä½¿ç”¨å»ºè®®ï¼š</b><br>"
    æ€»ç»“å†…å®¹ += "â€¢ å¦‚éœ€å•ç‹¬åˆ†ææŸä¸€åˆ¶å¼ï¼Œè¯·ä¸‹è½½å¯¹åº”çš„å•ç‹¬æ•°æ®æ–‡ä»¶<br>"
    æ€»ç»“å†…å®¹ += "â€¢ å¦‚éœ€æ•´ä½“å¯¹æ¯”åˆ†æï¼Œè¯·ä¸‹è½½å®Œæ•´æŠ¥å‘Š<br>"
    æ€»ç»“å†…å®¹ += "â€¢ å¯¼å‡ºçš„Excelæ–‡ä»¶å¯ç›´æ¥ç”¨äºåç»­çš„å®šåˆ¶åŒ–åˆ†ææˆ–æŠ¥å‘Šåˆ¶ä½œ"

    æ€»ç»“å†…å®¹ += "</div>"
    st.markdown(æ€»ç»“å†…å®¹, unsafe_allow_html=True)


def main():
    """ä¸»å‡½æ•°"""
    st.markdown('<p class="main-header">ğŸ“¡ 5G CQIå…³è”æ€§èƒ½åˆ†æç³»ç»Ÿ<br><small>ç½‘ç»œåˆ¶å¼å¯¹æ¯”ç‰ˆ (N41 vs N28) - ä¸­å…´æ•°æ®ç‰ˆ</small></p>', unsafe_allow_html=True)

    st.markdown("---")

    # ä½¿ç”¨æ–°çš„æ•°æ®æºæ–‡ä»¶ï¼ˆæ”¯æŒæœ¬åœ°å’Œäº‘ç«¯éƒ¨ç½²ï¼‰
    import os
    # è·å–å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•
    current_dir = os.path.dirname(os.path.abspath(__file__))
    æ–‡ä»¶è·¯å¾„ = os.path.join(current_dir, "CQIå…³è”æŒ‡æ ‡_ä¸­å…´.xlsx")

    # åˆ›å»ºåˆ†æå™¨
    åˆ†æå™¨ = CQIåˆ†æå™¨(æ–‡ä»¶è·¯å¾„)

    with st.spinner('æ­£åœ¨åŠ è½½æ•°æ®...'):
        if åˆ†æå™¨.è¯»å–æ•°æ®() and åˆ†æå™¨.æ¸…æ´—æ•°æ®():
            æ•°æ®é‡ = len(åˆ†æå™¨.æ¸…æ´—åæ•°æ®)
            åˆ†ç»„æ•°æ® = åˆ†æå™¨.æŒ‰ç½‘ç»œåˆ¶å¼åˆ†ç»„()
            if len(åˆ†ç»„æ•°æ®) > 1:
                åˆ¶å¼ä¿¡æ¯ = " | ".join([f"{k}: {len(v):,}æ¡" for k, v in åˆ†ç»„æ•°æ®.items()])
                st.success(f"âœ… æ•°æ®åŠ è½½æˆåŠŸï¼å…± {æ•°æ®é‡:,} æ¡æœ‰æ•ˆè®°å½• ({åˆ¶å¼ä¿¡æ¯})")
            else:
                st.success(f"âœ… æ•°æ®åŠ è½½æˆåŠŸï¼å…± {æ•°æ®é‡:,} æ¡æœ‰æ•ˆè®°å½•")
        else:
            st.error("âŒ æ•°æ®åŠ è½½å¤±è´¥")
            return

    st.markdown("---")

    # â­ é‡ç»„åçš„æ ‡ç­¾é¡µç»“æ„ï¼ˆ6ä¸ªä¸»æ ‡ç­¾é¡µï¼‰
    é€‰é¡¹å¡ = st.tabs([
        "ğŸ  æ¦‚è§ˆ",
        "ğŸ”— ç›¸å…³æ€§åˆ†æ",      # åˆå¹¶ï¼šCQIå¯¹é€Ÿç‡å½±å“ + å½±å“CQIçš„å› ç´  + ç›¸å…³æ€§çŸ©é˜µ
        "ğŸ¯ æ·±åº¦å…³è”åˆ†æ",    # åˆå¹¶ï¼šé˜ˆå€¼åˆ†æ + è´¡çŒ®åº¦åˆ†æ + åˆ†ç»„åˆ†æ
        "ğŸ”„ å¤šç»´åº¦è¯Šæ–­",      # åŸå¤šç»´åº¦äº¤å‰åˆ†æï¼ˆç§»é™¤TAåˆ†å±‚å’Œæ¡ä»¶åˆ†ç»„ï¼‰
        "ğŸ“ è·ç¦»è¦†ç›–åˆ†æ",    # â­ åˆå¹¶ï¼šè¦†ç›–ç³»æ•° + TAåˆ†å±‚ + æ¡ä»¶åˆ†ç»„
        "ğŸ“¥ æ•°æ®å¯¼å‡º"
    ])

    with é€‰é¡¹å¡[0]:
        st.markdown('<p class="sub-header">ğŸ“Š æ•°æ®æ¦‚è§ˆ - N41 vs N28 å¯¹æ¯”</p>', unsafe_allow_html=True)
        æ¸²æŸ“åˆ¶å¼å¯¹æ¯”æ¦‚è§ˆ(åˆ†æå™¨)

    with é€‰é¡¹å¡[1]:
        # ğŸ”— ç›¸å…³æ€§åˆ†æ - ä½¿ç”¨å­æ ‡ç­¾ç»„ç»‡2ä¸ªåŸé¡µé¢
        st.markdown('<p class="sub-header">ğŸ”— ç›¸å…³æ€§åˆ†æ - N41 vs N28 å¯¹æ¯”</p>', unsafe_allow_html=True)
        ç›¸å…³æ€§å­æ ‡ç­¾ = st.tabs([
            "ğŸ“Š CQIå¯¹é€Ÿç‡å½±å“",
            "ğŸ“ˆ ç›¸å…³æ€§å¯è§†åŒ–"
        ])
        with ç›¸å…³æ€§å­æ ‡ç­¾[0]:
            æ¸²æŸ“åˆ¶å¼å¯¹æ¯”é€Ÿç‡å½±å“(åˆ†æå™¨)
        with ç›¸å…³æ€§å­æ ‡ç­¾[1]:
            æ¸²æŸ“åˆ¶å¼å¯¹æ¯”ç›¸å…³æ€§çŸ©é˜µ(åˆ†æå™¨)

    with é€‰é¡¹å¡[2]:
        # ğŸ¯ æ·±åº¦å…³è”åˆ†æ - ä½¿ç”¨å­æ ‡ç­¾ç»„ç»‡3ä¸ªåŸé¡µé¢
        st.markdown('<p class="sub-header">ğŸ¯ æ·±åº¦å…³è”åˆ†æ - N41 vs N28 å¯¹æ¯”</p>', unsafe_allow_html=True)
        æ·±åº¦å­æ ‡ç­¾ = st.tabs([
            "ğŸ“ˆ æ‹ç‚¹åˆ†æ",
            "ğŸ“Š è´¡çŒ®åº¦åˆ†æ",
            "ğŸ“ˆ åˆ†ç»„åˆ†æ"
        ])
        with æ·±åº¦å­æ ‡ç­¾[0]:
            æ¸²æŸ“åˆ¶å¼å¯¹æ¯”æ‹ç‚¹åˆ†æ(åˆ†æå™¨)
        with æ·±åº¦å­æ ‡ç­¾[1]:
            æ¸²æŸ“åˆ¶å¼å¯¹æ¯”è´¡çŒ®åº¦åˆ†æ(åˆ†æå™¨)
        with æ·±åº¦å­æ ‡ç­¾[2]:
            æ¸²æŸ“åˆ¶å¼å¯¹æ¯”åˆ†ç»„åˆ†æ(åˆ†æå™¨)

    with é€‰é¡¹å¡[3]:
        st.markdown('<p class="sub-header">ğŸ”„ å¤šç»´åº¦è¯Šæ–­ - N41 vs N28 å¯¹æ¯”</p>', unsafe_allow_html=True)
        æ¸²æŸ“åˆ¶å¼å¯¹æ¯”å¤šç»´åº¦äº¤å‰åˆ†æ(åˆ†æå™¨)

    with é€‰é¡¹å¡[4]:  # ğŸ“ è·ç¦»è¦†ç›–åˆ†æ
        st.markdown('<p class="sub-header">ğŸ“ è·ç¦»è¦†ç›–åˆ†æ - N41 vs N28 å¯¹æ¯”</p>', unsafe_allow_html=True)
        æ¸²æŸ“åˆ¶å¼å¯¹æ¯”è·ç¦»è¦†ç›–åˆ†æ(åˆ†æå™¨)

    with é€‰é¡¹å¡[5]:  # ğŸ“¥ æ•°æ®å¯¼å‡º
        st.markdown('<p class="sub-header">ğŸ“¥ æ•°æ®å¯¼å‡º - N41 vs N28</p>', unsafe_allow_html=True)
        æ¸²æŸ“åˆ¶å¼å¯¹æ¯”æ•°æ®å¯¼å‡º(åˆ†æå™¨)

    st.markdown("---")
    st.markdown("""
    <div style="text-align: center; color: #666; padding: 20px;">
    <b>5G CQIå…³è”æ€§èƒ½åˆ†æç³»ç»Ÿ - ç½‘ç»œåˆ¶å¼å¯¹æ¯”ç‰ˆ</b> | Powered by Streamlit & Plotly<br>
    æ”¯æŒN41å’ŒN28ç½‘ç»œåˆ¶å¼å·¦å³å¯¹æ¯”åˆ†æ
    </div>
    """, unsafe_allow_html=True)


if __name__ == "__main__":
    main()
